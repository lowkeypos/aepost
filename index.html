<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM/POS для Тату-мастера</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Темный фон */
            color: #e2e8f0; /* Светлый текст */
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #2d3748; /* Чуть светлее темного */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15); /* Темная тень */
        }
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #4a5568; /* Темный трек */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #718096; /* Темный скролл */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0; /* Светлее при наведении */
        }
        .nav-link.active {
            background-color: #374151; /* Активный пункт навигации */
            color: #ffffff;
        }
        /* Adjust calendar/time picker indicator for dark theme */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(0.8); /* Инвертировать и затемнить для видимости */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2); /* Светлый спиннер */
            border-left-color: #63b3ed; /* Синий цвет */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        /* Style for custom modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* Более темный оверлей */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #2d3748; /* Фон модального окна */
            color: #e2e8f0; /* Текст модального окна */
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem; /* Более округлые углы */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
        }
        .close-button {
            color: #a0aec0; /* Цвет кнопки закрытия */
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #ffffff; /* Светлее при наведении */
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col">
    <div class="container bg-gray-800 shadow-xl rounded-lg overflow-hidden md:flex md:flex-row">
        <nav class="bg-gray-950 text-white p-4 md:w-48 md:min-h-screen flex flex-col justify-start items-center md:items-stretch">
            <h1 class="text-2xl font-bold mb-6 text-center text-blue-300">Tattoo CRM</h1>
            <ul class="flex flex-row md:flex-col space-x-4 md:space-x-0 md:space-y-2 w-full justify-center md:justify-start">
                <li><a href="#dashboard" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">
                    <i class="fas fa-tachometer-alt mr-3"></i>Панель
                </a></li>
                <li><a href="#appointments" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">
                    <i class="fas fa-calendar-alt mr-3"></i>Записи
                </a></li>
                <li><a href="#clients" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">
                    <i class="fas fa-users mr-3"></i>Клиенты
                </a></li>
                <li><a href="#inventory" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">
                    <i class="fas fa-box-open mr-3"></i>Инвентарь
                </a></li>
                <li><a href="#finance" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">
                    <i class="fas fa-dollar-sign mr-3"></i>Финансы
                </a></li>
                <li><a href="#settings" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">
                    <i class="fas fa-cog mr-3"></i>Настройки
                </a></li>
            </ul>
            <div class="mt-auto pt-4 border-t border-gray-700 w-full">
                <a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">
                    <i class="fas fa-sign-out-alt mr-3"></i>Выйти
                </a>
            </div>
        </nav>

        <main id="app-content" class="main-content p-6 flex-1">
            <div class="bg-gray-900 p-4 rounded-lg shadow-md mb-6 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h2 id="page-title" class="text-xl font-semibold text-blue-300">Панель</h2>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input type="text" placeholder="Пошук ..." class="bg-gray-700 text-gray-200 border border-gray-600 rounded-full py-2 px-4 pl-10 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button class="text-gray-400 hover:text-white transition-colors">
                        <i class="fas fa-bell text-xl"></i>
                    </button>
                    <div class="flex items-center space-x-2 bg-gray-700 rounded-full px-3 py-1">
                        <div class="bg-blue-500 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold">TM</div>
                        <span class="text-gray-200">Tattoo Master</span>
                    </div>
                </div>
            </div>

            <div class="flex justify-center items-center h-full" id="initial-loading-spinner">
                <div class="spinner"></div>
            </div>
        </main>
    </div>

    <div id="custom-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="modal-close-button">&times;</span>
            <h3 id="modal-title" class="text-xl font-semibold mb-4"></h3>
            <p id="modal-message" class="mb-6"></p>
            <div id="modal-actions" class="flex justify-end space-x-3">
                </div>
        </div>
    </div>

    <script>
        // Supabase Client Initialization
        var SUPABASE_URL = 'https://iedrcmbvegttznaxpevd.supabase.co';
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllZHJjbWJ2ZWd0dHpuYXhwZXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc0MDQyMzEsImV4cCI6MjA2Mjk4MDIzMX0.5K7nHzHI10tXQRP1ha8iH1CD-gjTtpzFSQSRIPofj1A';

        var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global state variables
        var appState = {
            hourlyRate: 0,
            materialCategories: [],
            materials: [],
            clients: [],
            appointments: [],
            expenses: [],
            sessions: [],
            isDataLoaded: false
        };

        // Function to replace String.prototype.padStart
        function customPadStart(str, targetLength, padString) {
            str = String(str);
            padString = String(padString);
            if (str.length >= targetLength) {
                return str;
            }
            targetLength = targetLength - str.length;
            if (targetLength > padString.length) {
                padString += padString.repeat(Math.ceil(targetLength / padString.length)); // Ensure enough padding
            }
            return padString.slice(0, targetLength) + str;
        }

        // Helper to format currency
        var formatCurrency = function(amount) {
            // Intl.NumberFormat is ES2015. For very old iPads, this might fail.
            // A fallback would be manual string formatting if this causes issues.
            try {
                return new Intl.NumberFormat('uk-UA', { style: 'currency', currency: 'UAH' }).format(amount);
            } catch (e) {
                console.warn("Intl.NumberFormat not fully supported, falling back to basic format.");
                return amount.toFixed(2) + ' грн'; // Basic fallback
            }
        };

        // Helper to format date
        var formatDate = function(dateString) {
            if (!dateString) return '';
            var date = new Date(dateString);
            // toLocaleDateString is ES1, generally well-supported, but locale might vary.
            return date.toLocaleDateString('uk-UA');
        };

        // Helper to format time (replacing padStart)
        var formatTime = function(timeString) {
            if (!timeString) return '';
            // Assuming timeString is in HH:MM:SS format from Supabase
            var parts = timeString.split(':');
            var hours = parts[0];
            var minutes = parts[1];
            return customPadStart(hours, 2, '0') + ':' + customPadStart(minutes, 2, '0');
        };

        // Helper to find an element in an array (replacing Array.prototype.find)
        var findInArray = function(array, predicate) {
            for (var i = 0; i < array.length; i++) {
                if (predicate(array[i])) {
                    return array[i];
                }
            }
            return undefined;
        };

        // Helper to filter an array (replacing Array.prototype.filter)
        var filterArray = function(array, predicate) {
            var result = [];
            for (var i = 0; i < array.length; i++) {
                if (predicate(array[i])) {
                    result.push(array[i]);
                }
            }
            return result;
        };

        // Helper to map an array (replacing Array.prototype.map)
        var mapArray = function(array, callback) {
            var result = [];
            for (var i = 0; i < array.length; i++) {
                result.push(callback(array[i], i, array));
            }
            return result;
        };

        // Helper to reduce an array (replacing Array.prototype.reduce)
        var reduceArray = function(array, callback, initialValue) {
            var accumulator = initialValue;
            var startIndex = 0;
            if (arguments.length < 3) {
                if (array.length === 0) {
                    throw new TypeError('Reduce of empty array with no initial value');
                }
                accumulator = array[0];
                startIndex = 1;
            }
            for (var i = startIndex; i < array.length; i++) {
                accumulator = callback(accumulator, array[i], i, array);
            }
            return accumulator;
        };

        // Helper for includes (replacing Array.prototype.includes)
        var arrayIncludes = function(arr, value) {
            for (var i = 0; i < arr.length; i++) {
                if (arr[i] === value) {
                    return true;
                }
            }
            return false;
        };

        // Utility function to show custom modal
        var showModal = function(title, message, type, onConfirm) {
            if (type === undefined) type = 'alert';

            var modal = document.getElementById('custom-modal');
            var modalTitle = document.getElementById('modal-title');
            var modalMessage = document.getElementById('modal-message');
            var modalActions = document.getElementById('modal-actions');

            modalTitle.textContent = title;
            modalMessage.innerHTML = message; // Use innerHTML for rich content
            modalActions.innerHTML = ''; // Clear previous buttons

            if (type === 'alert') {
                var okButton = document.createElement('button');
                okButton.textContent = 'ОК';
                okButton.className = 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors';
                okButton.onclick = function() { modal.classList.add('hidden'); };
                modalActions.appendChild(okButton);
            } else if (type === 'confirm') {
                var cancelButton = document.createElement('button');
                cancelButton.textContent = 'Отмена';
                cancelButton.className = 'px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors';
                var confirmButton = document.createElement('button');
                confirmButton.textContent = 'Подтвердить';
                confirmButton.className = 'px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors';
                cancelButton.onclick = function() { modal.classList.add('hidden'); };
                confirmButton.onclick = function() {
                    if (onConfirm) onConfirm();
                    modal.classList.add('hidden');
                };
                modalActions.appendChild(cancelButton);
                modalActions.appendChild(confirmButton);
            }
            modal.classList.remove('hidden');
        };

        // Close modal button
        document.getElementById('modal-close-button').onclick = function() {
            document.getElementById('custom-modal').classList.add('hidden');
        };

        // --- Data Fetching and Realtime Subscriptions ---
        var fetchData = function() {
            return new Promise(function(resolve, reject) {
                document.getElementById('initial-loading-spinner').classList.remove('hidden');
                supabase.from('settings').select('*').limit(1)
                    .then(function(settingsResponse) {
                        if (settingsResponse.error) throw settingsResponse.error;
                        if (settingsResponse.data.length > 0) {
                            appState.hourlyRate = settingsResponse.data[0].hourly_rate || 0;
                            appState.materialCategories = settingsResponse.data[0].material_categories || [];
                        } else {
                            // Initialize default settings if none exist
                            return supabase.from('settings').insert([{ hourly_rate: 500, material_categories: ['Краски', 'Иглы', 'Средства гигиены', 'Другое'] }])
                                .then(function() {
                                    appState.hourlyRate = 500;
                                    appState.materialCategories = ['Краски', 'Иглы', 'Средства гигиены', 'Другое'];
                                    return {}; // Return empty object to continue chain
                                });
                        }
                        return {}; // Return empty object if settings already exist
                    })
                    .then(function() {
                        return supabase.from('materials').select('*');
                    })
                    .then(function(materialsResponse) {
                        if (materialsResponse.error) throw materialsResponse.error;
                        appState.materials = materialsResponse.data;
                        return supabase.from('clients').select('*');
                    })
                    .then(function(clientsResponse) {
                        if (clientsResponse.error) throw clientsResponse.error;
                        appState.clients = clientsResponse.data;
                        return supabase.from('appointments').select('*, clients(*)');
                    })
                    .then(function(appointmentsResponse) {
                        if (appointmentsResponse.error) throw appointmentsResponse.error;
                        appState.appointments = appointmentsResponse.data;
                        return supabase.from('expenses').select('*');
                    })
                    .then(function(expensesResponse) {
                        if (expensesResponse.error) throw expensesResponse.error;
                        appState.expenses = expensesResponse.data;
                        return supabase.from('sessions').select('*');
                    })
                    .then(function(sessionsResponse) {
                        if (sessionsResponse.error) throw sessionsResponse.error;
                        appState.sessions = sessionsResponse.data;

                        appState.isDataLoaded = true;
                        document.getElementById('initial-loading-spinner').classList.add('hidden');
                        handleRouteChange(); // Render content after data is loaded
                        resolve();
                    })
                    .catch(function(error) {
                        console.error('Ошибка загрузки данных:', error.message);
                        showModal('Ошибка', 'Не удалось загрузить данные: ' + error.message + '. Пожалуйста, проверьте подключение к Supabase и настройки таблиц.', 'alert');
                        document.getElementById('initial-loading-spinner').classList.add('hidden');
                        reject(error);
                    });
            });
        };

        var setupRealtimeSubscriptions = function() {
            supabase.channel('public:materials')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'materials' }, function(payload) {
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();

            supabase.channel('public:clients')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'clients' }, function(payload) {
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();

            supabase.channel('public:appointments')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'appointments' }, function(payload) {
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();

            supabase.channel('public:expenses')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'expenses' }, function(payload) {
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();

            supabase.channel('public:sessions')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'sessions' }, function(payload) {
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();

            supabase.channel('public:settings')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'settings' }, function(payload) {
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();
        };

        var fetchDataAndRerenderCurrentPage = function() {
            return fetchData().then(function() {
                handleRouteChange(); // Re-render the current view
            });
        };

        // --- Routing ---
        var routes = {
            'dashboard': renderDashboard,
            'appointments': renderAppointments,
            'clients': renderClients,
            'inventory': renderInventory,
            'finance': renderFinance,
            'settings': renderSettings,
            'session': renderSessionCalculator // This will handle /session/[id]
        };

        var handleRouteChange = function() {
            var path = window.location.hash.substring(1);
            var appContent = document.getElementById('app-content');
            var pageTitle = document.getElementById('page-title');
            appContent.innerHTML = ''; // Clear content

            // Remove active class from all nav links
            var navLinks = document.querySelectorAll('.nav-link');
            for (var i = 0; i < navLinks.length; i++) {
                navLinks[i].classList.remove('active');
            }

            var pathParts = path.split('/');
            var basePath = pathParts[0];
            var id = pathParts[1];

            if (routes[basePath]) {
                routes[basePath](id); // Pass ID if available
                // Add active class to current nav link
                var activeLink = document.querySelector('.nav-link[href="#' + basePath + '"]');
                if (activeLink) {
                    activeLink.classList.add('active');
                }
                // Update page title
                var linkText = activeLink ? activeLink.textContent.trim() : '';
                // Extract only the Russian word for the title
                var titleMatch = linkText.match(/(Панель|Записи|Клиенты|Инвентарь|Финансы|Настройки)/);
                pageTitle.textContent = titleMatch ? titleMatch[0] : 'Неизвестно';

            } else {
                // Default to dashboard if path is not found or empty
                window.location.hash = '#dashboard';
                renderDashboard();
                document.querySelector('.nav-link[href="#dashboard"]').classList.add('active');
                pageTitle.textContent = 'Панель';
            }
        };

        // --- Module Rendering Functions ---

        // 1. Dashboard Module
        var renderDashboard = function() {
            var appContent = document.getElementById('app-content');
            appContent.innerHTML = `
                <div class="p-4 md:p-8 bg-gray-700 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-blue-300">Дашборд</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gray-800 p-5 rounded-lg shadow-sm flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300 mb-1">Дохід</h3>
                                <p class="text-3xl font-bold text-green-400">${formatCurrency(calculateTotalRevenue())}</p>
                                <p class="text-sm text-gray-400">+0% з минулого місяця</p>
                            </div>
                            <i class="fas fa-wallet text-4xl text-green-600"></i>
                        </div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-sm flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300 mb-1">Клієнти</h3>
                                <p class="text-3xl font-bold text-blue-400">${appState.clients.length}</p>
                                <p class="text-sm text-gray-400">+0 нових</p>
                            </div>
                            <i class="fas fa-users text-4xl text-blue-600"></i>
                        </div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-sm flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300 mb-1">Сеанси</h3>
                                <p class="text-3xl font-bold text-purple-400">${appState.sessions.length}</p>
                                <p class="text-sm text-gray-400">${filterArray(appState.appointments, function(a) { return a.status === 'pending' || a.status === 'confirmed'; }).length} заплановано</p>
                            </div>
                            <i class="fas fa-calendar-check text-4xl text-purple-600"></i>
                        </div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-sm flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300 mb-1">Матеріали</h3>
                                <p class="text-3xl font-bold text-yellow-400">${appState.materials.length}</p>
                                <p class="text-sm text-gray-400">${filterArray(appState.materials, function(m) { return m.stock <= m.low_stock_threshold; }).length} закінчується</p>
                            </div>
                            <i class="fas fa-box-open text-4xl text-yellow-600"></i>
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-inner mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-semibold text-blue-300">Дохід за останні 30 днів</h3>
                            <select class="bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-1 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option>30 днів</option>
                                <option>90 днів</option>
                                <option>12 місяців</option>
                            </select>
                        </div>
                        <div class="h-64 bg-gray-900 rounded-md flex items-center justify-center text-gray-500">
                            Графік доходу
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-inner">
                        <h3 class="text-2xl font-semibold mb-4 text-blue-300">Найближчі сеанси</h3>
                        <div id="latest-appointments-list" class="overflow-x-auto">
                            </div>
                    </div>
                </div>
            `;
            renderLatestAppointments();
        };

        var calculateTotalRevenue = function() {
            return reduceArray(appState.sessions, function(sum, session) { return sum + session.total_price; }, 0);
        };

        var calculateMonthlyRevenue = function() {
            var now = new Date();
            var currentMonth = now.getMonth();
            var currentYear = now.getFullYear();
            return reduceArray(appState.sessions, function(sum, session) {
                var sessionDate = new Date(session.start_time);
                if (sessionDate.getMonth() === currentMonth && sessionDate.getFullYear() === currentYear) {
                    return sum + session.total_price;
                }
                return sum;
            }, 0);
        };

        var renderLatestAppointments = function() {
            var listContainer = document.getElementById('latest-appointments-list');
            var latestAppointments = filterArray(appState.appointments, function(a) { return a.status === 'pending' || a.status === 'confirmed'; })
                .sort(function(a, b) { return new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time); })
                .slice(0, 5); // Show top 5

            if (latestAppointments.length === 0) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                        <i class="fas fa-calendar-alt text-6xl mb-4"></i>
                        <p class="text-lg">Немає запланованих сеансів</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = `
                <table class="min-w-full bg-gray-800 rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-700 text-gray-300 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Дата</th>
                            <th class="py-3 px-6 text-left">Время</th>
                            <th class="py-3 px-6 text-left">Клиент</th>
                            <th class="py-3 px-6 text-left rounded-tr-lg">Статус</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-200 text-sm">
                        ${mapArray(latestAppointments, function(app) {
                            return `
                                <tr class="border-b border-gray-600 hover:bg-gray-700">
                                    <td class="py-3 px-6 text-left whitespace-nowrap">${formatDate(app.date)}</td>
                                    <td class="py-3 px-6 text-left">${formatTime(app.time)}</td>
                                    <td class="py-3 px-6 text-left">${app.clients ? app.clients.name : 'Неизвестно'}</td>
                                    <td class="py-3 px-6 text-left">
                                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${app.status === 'confirmed' ? 'bg-green-700 text-green-100' : 'bg-yellow-700 text-yellow-100'}">
                                            ${app.status === 'pending' ? 'Ожидает' : 'Подтверждено'}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        };

        // 2. Appointment System
        var renderAppointments = function() {
            var appContent = document.getElementById('app-content');
            appContent.innerHTML = `
                <div class="p-4 md:p-8 bg-gray-700 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-blue-300">Записи</h2>

                    <div class="flex justify-between items-center mb-6">
                        <select class="bg-gray-800 text-gray-200 border border-gray-600 rounded-md py-2 px-4 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option>Усі дати</option>
                            <option>Сьогодні</option>
                            <option>Цей тиждень</option>
                            <option>Цей місяць</option>
                        </select>
                        <button id="add-appointment-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-plus mr-2"></i>Додати запис
                        </button>
                    </div>

                    <div id="appointment-form-container" class="hidden bg-gray-800 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-blue-300">Створити нову запис</h3>
                        <form id="appointment-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="appointment-client" class="block text-sm font-medium text-gray-300">Клиент</label>
                                <select id="appointment-client" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-200">
                                    <option value="">Выберите клиента</option>
                                    ${mapArray(appState.clients, function(client) { return `<option value="${client.id}">${client.name}</option>`; }).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="appointment-date" class="block text-sm font-medium text-gray-300">Дата</label>
                                <input type="date" id="appointment-date" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-200">
                            </div>
                            <div>
                                <label for="appointment-time" class="block text-sm font-medium text-gray-300">Время</label>
                                <input type="time" id="appointment-time" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-200">
                            </div>
                            <div>
                                <label for="appointment-duration" class="block text-sm font-medium text-gray-300">Предполагаемая длительность (часов)</label>
                                <input type="number" id="appointment-duration" step="0.5" min="0.5" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-200">
                            </div>
                            <div>
                                <label for="appointment-complexity" class="block text-sm font-medium text-gray-300">Сложность (1-10)</label>
                                <input type="number" id="appointment-complexity" min="1" max="10" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-200">
                            </div>
                            <div>
                                <label for="appointment-sketch" class="block text-sm font-medium text-gray-300">Эскиз (URL)</label>
                                <input type="url" id="appointment-sketch" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-200" placeholder="http://example.com/sketch.jpg">
                            </div>
                            <div class="md:col-span-2 flex justify-end space-x-3">
                                <button type="button" id="cancel-appointment-form" class="px-5 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Отмена</button>
                                <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Сохранить запись</button>
                            </div>
                        </form>
                    </div>

                    <h3 class="text-2xl font-semibold mb-4 text-blue-300">Предстоящие визиты</h3>
                    <div id="upcoming-appointments-list" class="overflow-x-auto">
                        </div>
                </div>
            `;

            document.getElementById('add-appointment-btn').addEventListener('click', function() {
                document.getElementById('appointment-form-container').classList.toggle('hidden');
            });

            document.getElementById('cancel-appointment-form').addEventListener('click', function() {
                document.getElementById('appointment-form-container').classList.add('hidden');
                document.getElementById('appointment-form').reset();
            });

            document.getElementById('appointment-form').addEventListener('submit', handleAddAppointment);
            renderUpcomingAppointments();
        };

        var handleAddAppointment = function(event) {
            event.preventDefault();
            var form = event.target;
            var clientId = form['appointment-client'].value;
            var date = form['appointment-date'].value;
            var time = form['appointment-time'].value;
            var duration = parseFloat(form['appointment-duration'].value);
            var complexity = parseInt(form['appointment-complexity'].value);
            var sketchUrl = form['appointment-sketch'].value;

            if (!clientId || !date || !time || isNaN(duration) || isNaN(complexity)) {
                showModal('Ошибка', 'Пожалуйста, заполните все обязательные поля (Клиент, Дата, Время, Длительность, Сложность).', 'alert');
                return;
            }

            supabase.from('appointments').insert([
                {
                    client_id: clientId,
                    date: date,
                    time: time,
                    duration: duration,
                    complexity: complexity,
                    sketch_url: sketchUrl,
                    status: 'pending'
                }
            ])
            .then(function(response) {
                if (response.error) throw response.error;
                showModal('Успех', 'Запись успешно добавлена!', 'alert');
                form.reset();
                document.getElementById('appointment-form-container').classList.add('hidden');
                fetchDataAndRerenderCurrentPage(); // Re-fetch and re-render
            })
            .catch(function(error) {
                console.error('Ошибка добавления записи:', error.message);
                showModal('Ошибка', 'Не удалось добавить запись: ' + error.message, 'alert');
            });
        };

        var renderUpcomingAppointments = function() {
            var listContainer = document.getElementById('upcoming-appointments-list');
            var upcomingAppointments = filterArray(appState.appointments, function(app) { return app.status === 'pending' || app.status === 'confirmed'; })
                .sort(function(a, b) { return new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time); });

            if (upcomingAppointments.length === 0) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                        <i class="fas fa-calendar-times text-6xl mb-4"></i>
                        <p class="text-lg">Немає записів</p>
                        <p class="text-md mb-4">Створіть перший запис клієнта</p>
                        <button id="add-appointment-from-empty-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-plus mr-2"></i>Додати запис
                        </button>
                    </div>
                `;
                document.getElementById('add-appointment-from-empty-btn').addEventListener('click', function() {
                    document.getElementById('appointment-form-container').classList.remove('hidden');
                });
                return;
            }

            listContainer.innerHTML = `
                <table class="min-w-full bg-gray-800 rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-700 text-gray-300 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Дата</th>
                            <th class="py-3 px-6 text-left">Время</th>
                            <th class="py-3 px-6 text-left">Клиент</th>
                            <th class="py-3 px-6 text-left">Длительность</th>
                            <th class="py-3 px-6 text-left">Сложность</th>
                            <th class="py-3 px-6 text-left">Статус</th>
                            <th class="py-3 px-6 text-center rounded-tr-lg">Действия</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-200 text-sm">
                        ${mapArray(upcomingAppointments, function(app) {
                            return `
                                <tr class="border-b border-gray-600 hover:bg-gray-700">
                                    <td class="py-3 px-6 text-left whitespace-nowrap">${formatDate(app.date)}</td>
                                    <td class="py-3 px-6 text-left">${formatTime(app.time)}</td>
                                    <td class="py-3 px-6 text-left">${app.clients ? app.clients.name : 'Неизвестно'}</td>
                                    <td class="py-3 px-6 text-left">${app.duration} ч</td>
                                    <td class="py-3 px-6 text-left">${app.complexity}</td>
                                    <td class="py-3 px-6 text-left">
                                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${app.status === 'confirmed' ? 'bg-green-700 text-green-100' : 'bg-yellow-700 text-yellow-100'}">
                                            ${app.status === 'pending' ? 'Ожидает' : 'Подтверждено'}
                                        </span>
                                    </td>
                                    <td class="py-3 px-6 text-center">
                                        ${app.status === 'pending' ? `
                                            <button data-id="${app.id}" class="confirm-appointment-btn bg-green-600 text-white px-3 py-1 rounded-md text-xs hover:bg-green-700 transition-colors mr-2">Подтвердить</button>
                                            <button data-id="${app.id}" class="cancel-appointment-btn bg-red-600 text-white px-3 py-1 rounded-md text-xs hover:bg-red-700 transition-colors">Отменить</button>
                                        ` : `
                                            <a href="#session/${app.id}" class="bg-purple-600 text-white px-3 py-1 rounded-md text-xs hover:bg-purple-700 transition-colors">Открыть калькулятор</a>
                                        `}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            var confirmButtons = listContainer.querySelectorAll('.confirm-appointment-btn');
            for (var i = 0; i < confirmButtons.length; i++) {
                confirmButtons[i].addEventListener('click', function(e) {
                    var appointmentId = e.target.dataset.id;
                    showModal('Подтверждение', 'Вы уверены, что хотите подтвердить этот визит? Он будет перенесен в калькулятор сеанса.', 'confirm', function() {
                        supabase.from('appointments').update({ status: 'confirmed' }).eq('id', appointmentId)
                            .then(function(response) {
                                if (response.error) throw response.error;
                                showModal('Успех', 'Визит подтвержден!', 'alert');
                                window.location.hash = '#session/' + appointmentId; // Redirect to session calculator
                            })
                            .catch(function(error) {
                                console.error('Ошибка подтверждения визита:', error.message);
                                showModal('Ошибка', 'Не удалось подтвердить визит: ' + error.message, 'alert');
                            });
                    });
                });
            }

            var cancelButtons = listContainer.querySelectorAll('.cancel-appointment-btn');
            for (var i = 0; i < cancelButtons.length; i++) {
                cancelButtons[i].addEventListener('click', function(e) {
                    var appointmentId = e.target.dataset.id;
                    showModal('Отмена визита', 'Вы уверены, что хотите отменить этот визит?', 'confirm', function() {
                        supabase.from('appointments').update({ status: 'cancelled' }).eq('id', appointmentId)
                            .then(function(response) {
                                if (response.error) throw response.error;
                                showModal('Успех', 'Визит отменен.', 'alert');
                                fetchDataAndRerenderCurrentPage(); // Re-fetch and re-render
                            })
                            .catch(function(error) {
                                console.error('Ошибка отмены визита:', error.message);
                                showModal('Ошибка', 'Не удалось отменить визит: ' + error.message, 'alert');
                            });
                    });
                });
            }
        };

        // 3. Tattoo Session Calculator
        var renderSessionCalculator = function(appointmentId) {
            var appContent = document.getElementById('app-content');
            var appointment = findInArray(appState.appointments, function(app) { return app.id === appointmentId; });

            if (!appointment) {
                appContent.innerHTML = `<div class="p-4 bg-red-900 text-red-200 rounded-lg">Визит не найден или не подтвержден.</div>`;
                return;
            }

            var client = findInArray(appState.clients, function(c) { return c.id === appointment.client_id; });
            var hourlyRate = appState.hourlyRate;

            appContent.innerHTML = `
                <div class="p-4 md:p-8 bg-gray-700 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-blue-300">Калькулятор тату-сеанса</h2>
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">Визит клиента: ${client ? client.name : 'Неизвестно'} (${formatDate(appointment.date)} ${formatTime(appointment.time)})</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="space-y-4">
                            <div>
                                <label for="session-start-time" class="block text-sm font-medium text-gray-300">Время начала</label>
                                <input type="datetime-local" id="session-start-time" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="session-end-time" class="block text-sm font-medium text-gray-300">Время окончания</label>
                                <input type="datetime-local" id="session-end-time" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="session-complexity" class="block text-sm font-medium text-gray-300">Сложность (1-10)</label>
                                <input type="number" id="session-complexity" min="1" max="10" value="${appointment.complexity}" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="session-discount" class="block text-sm font-medium text-gray-300">Скидка (%)</label>
                                <input type="number" id="session-discount" min="0" max="100" value="0" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="session-notes" class="block text-sm font-medium text-gray-300">Заметки по сеансу</label>
                                <textarea id="session-notes" rows="3" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200"></textarea>
                            </div>
                            ${appointment.sketch_url ? `
                                <div class="mt-4">
                                    <h4 class="text-lg font-semibold mb-2 text-gray-300">Эскиз:</h4>
                                    <img src="${appointment.sketch_url}" alt="Эскиз тату" class="w-full h-48 object-contain rounded-lg shadow-md border border-gray-600" onerror="this.onerror=null;this.src='https://placehold.co/300x200/4a5568/a0aec0?text=Нет+эскиза';">
                                </div>
                            ` : `<p class="text-gray-400 mt-4">Эскиз не прикреплен.</p>`}
                        </div>

                        <div class="space-y-4">
                            <div>
                                <h4 class="text-lg font-semibold mb-2 text-gray-300">Использованные расходники</h4>
                                <div id="materials-used-list" class="space-y-3">
                                    </div>
                                <button id="add-material-btn" class="mt-3 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                                    Добавить расходник
                                </button>
                            </div>

                            <div class="bg-blue-900 p-5 rounded-lg shadow-inner mt-6">
                                <h4 class="text-xl font-bold mb-3 text-blue-200">Итого:</h4>
                                <p class="text-lg text-blue-100">Время работы: <span id="calculated-work-time">0</span> ч</p>
                                <p class="text-lg text-blue-100">Себестоимость материалов: <span id="calculated-cost-price">${formatCurrency(0)}</span></p>
                                <p class="text-lg text-blue-100">Наценка за сложность: <span id="calculated-complexity-markup">${formatCurrency(0)}</span></p>
                                <p class="text-lg text-blue-100">Стоимость работы: <span id="calculated-work-cost">${formatCurrency(0)}</span></p>
                                <p class="text-2xl font-bold text-blue-50 mt-4">Итоговая цена: <span id="calculated-total-price">${formatCurrency(0)}</span></p>
                            </div>

                            <div class="mt-6">
                                <label for="payment-method" class="block text-sm font-medium text-gray-300">Метод оплаты</label>
                                <select id="payment-method" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                                    <option value="cash">Наличные</option>
                                    <option value="card">Карта</option>
                                    <option value="transfer">Перевод</option>
                                </select>
                            </div>

                            <div class="flex justify-end mt-6 space-x-3">
                                <button id="save-session-btn" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-colors">
                                    Оплата и завершение
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Pre-fill start time with appointment date and time
            var appointmentDateTime = new Date(appointment.date + 'T' + appointment.time);
            document.getElementById('session-start-time').value = appointmentDateTime.toISOString().slice(0, 16);

            var materialsUsedList = document.getElementById('materials-used-list');
            var usedMaterials = []; // Array to store {material_id, quantity}

            function addMaterialInput(material) {
                if (material === void 0) { material = null; }
                var materialDiv = document.createElement('div');
                materialDiv.className = 'flex items-center space-x-2';
                materialDiv.innerHTML = `
                    <select class="material-select block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                        <option value="">Выберите материал</option>
                        ${mapArray(appState.materials, function(m) { return `<option value="${m.id}" data-price="${m.unit_price}" ${material && material.material_id === m.id ? 'selected' : ''}>${m.name} (${formatCurrency(m.unit_price)}/ед.)</option>`; }).join('')}
                    </select>
                    <input type="number" min="0.01" step="0.01" placeholder="Кол-во" value="${material ? material.quantity : ''}" class="material-quantity w-24 p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                    <button class="remove-material-btn text-red-500 hover:text-red-400 p-2 rounded-full">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                materialsUsedList.appendChild(materialDiv);

                var selectElement = materialDiv.querySelector('.material-select');
                var quantityElement = materialDiv.querySelector('.material-quantity');

                selectElement.addEventListener('change', calculateSessionPrice);
                quantityElement.addEventListener('input', calculateSessionPrice);
                materialDiv.querySelector('.remove-material-btn').addEventListener('click', function() {
                    materialsUsedList.removeChild(materialDiv);
                    calculateSessionPrice();
                });
            }

            document.getElementById('add-material-btn').addEventListener('click', function() { addMaterialInput(); });

            // Load existing materials if session was already calculated (e.g., editing a completed session)
            var existingSession = findInArray(appState.sessions, function(s) { return s.appointment_id === appointmentId; });
            if (existingSession && existingSession.materials_used) {
                try {
                    var parsedMaterials = JSON.parse(existingSession.materials_used);
                    mapArray(parsedMaterials, function(mat) { addMaterialInput(mat); });
                    document.getElementById('session-start-time').value = new Date(existingSession.start_time).toISOString().slice(0, 16);
                    document.getElementById('session-end-time').value = new Date(existingSession.end_time).toISOString().slice(0, 16);
                    document.getElementById('session-complexity').value = existingSession.complexity_score;
                    document.getElementById('session-discount').value = existingSession.discount;
                    document.getElementById('payment-method').value = existingSession.payment_method;
                    document.getElementById('session-notes').value = existingSession.notes || '';
                } catch (e) {
                    console.error("Error parsing materials_used:", e);
                }
            } else {
                // Add one empty material input by default for new sessions
                addMaterialInput();
            }


            // Event listeners for calculations
            document.getElementById('session-start-time').addEventListener('input', calculateSessionPrice);
            document.getElementById('session-end-time').addEventListener('input', calculateSessionPrice);
            document.getElementById('session-complexity').addEventListener('input', calculateSessionPrice);
            document.getElementById('session-discount').addEventListener('input', calculateSessionPrice);

            // Initial calculation
            calculateSessionPrice();

            document.getElementById('save-session-btn').addEventListener('click', function() {
                var startTime = document.getElementById('session-start-time').value;
                var endTime = document.getElementById('session-end-time').value;
                var complexity = parseInt(document.getElementById('session-complexity').value);
                var discount = parseFloat(document.getElementById('session-discount').value);
                var paymentMethod = document.getElementById('payment-method').value;
                var notes = document.getElementById('session-notes').value;

                if (!startTime || !endTime || isNaN(complexity) || isNaN(discount)) {
                    showModal('Ошибка', 'Пожалуйста, заполните все поля времени, сложности и скидки.', 'alert');
                    return;
                }

                var start = new Date(startTime);
                var end = new Date(endTime);

                if (end <= start) {
                    showModal('Ошибка', 'Время окончания должно быть позже времени начала.', 'alert');
                    return;
                }

                var calculationResults = calculateSessionPrice(true);
                var totalWorkTime = calculationResults.totalWorkTime;
                var costPriceMaterials = calculationResults.costPriceMaterials;
                var complexityMarkup = calculationResults.complexityMarkup;
                var workCost = calculationResults.workCost;
                var finalPrice = calculationResults.finalPrice;

                var materialsUsed = mapArray(materialsUsedList.children, function(div) {
                    var select = div.querySelector('.material-select');
                    var quantity = div.querySelector('.material-quantity');
                    return {
                        material_id: select.value,
                        quantity: parseFloat(quantity.value)
                    };
                });
                materialsUsed = filterArray(materialsUsed, function(m) { return m.material_id && m.quantity > 0; }); // Filter out empty or zero quantity materials

                // Check for duplicate materials
                var materialCounts = {};
                for (var i = 0; i < materialsUsed.length; i++) {
                    var mat = materialsUsed[i];
                    materialCounts[mat.material_id] = (materialCounts[mat.material_id] || 0) + 1;
                    if (materialCounts[mat.material_id] > 1) {
                        showModal('Ошибка', 'Обнаружены дубликаты материалов. Пожалуйста, объедините их или удалите лишние.', 'alert');
                        return;
                    }
                }

                showModal('Подтверждение оплаты', 'Итого к оплате: ' + formatCurrency(finalPrice) + '. Подтвердить?', 'confirm', function() {
                    var sessionId = existingSession ? existingSession.id : null;
                    var sessionData = {
                        appointment_id: appointmentId,
                        start_time: startTime,
                        end_time: endTime,
                        hourly_rate_used: hourlyRate,
                        complexity_score: complexity,
                        materials_used: JSON.stringify(materialsUsed), // Store as JSON string
                        total_price: finalPrice,
                        cost_price: costPriceMaterials,
                        discount: discount,
                        payment_method: paymentMethod,
                        notes: notes
                    };

                    var promise;
                    if (sessionId) {
                        // Update existing session
                        promise = supabase.from('sessions').update(sessionData).eq('id', sessionId);
                    } else {
                        // Insert new session
                        promise = supabase.from('sessions').insert([sessionData]).select()
                            .then(function(newSessionResponse) {
                                if (newSessionResponse.error) throw newSessionResponse.error;
                                sessionId = newSessionResponse.data[0].id;
                                // Link session to appointment
                                return supabase.from('appointments').update({ status: 'completed', session_id: sessionId }).eq('id', appointmentId);
                            });
                    }

                    promise
                        .then(function(response) {
                            if (response.error) throw response.error;
                            // Deduct materials from inventory and record movements
                            var materialDeductionPromises = mapArray(materialsUsed, function(item) {
                                var material = findInArray(appState.materials, function(m) { return m.id === item.material_id; });
                                if (material) {
                                    var newStock = material.stock - item.quantity;
                                    return supabase.from('materials').update({ stock: newStock }).eq('id', item.material_id)
                                        .then(function() {
                                            return supabase.from('material_movements').insert([
                                                {
                                                    material_id: item.material_id,
                                                    type: 'out',
                                                    quantity: item.quantity,
                                                    source_target: 'session_' + sessionId
                                                }
                                            ]);
                                        });
                                }
                                return Promise.resolve(); // Resolve if material not found
                            });
                            return Promise.all(materialDeductionPromises);
                        })
                        .then(function() {
                            showModal('Успех', 'Сеанс успешно сохранен и оплачен!', 'alert');
                            fetchDataAndRerenderCurrentPage(); // Re-fetch and re-render
                            window.location.hash = '#appointments'; // Go back to appointments
                        })
                        .catch(function(error) {
                            console.error('Ошибка сохранения сеанса:', error.message);
                            showModal('Ошибка', 'Не удалось сохранить сеанс: ' + error.message, 'alert');
                        });
                });
            });

            function calculateSessionPrice(returnValues) {
                if (returnValues === void 0) { returnValues = false; }
                var startTime = document.getElementById('session-start-time').value;
                var endTime = document.getElementById('session-end-time').value;
                var complexity = parseInt(document.getElementById('session-complexity').value);
                var discount = parseFloat(document.getElementById('session-discount').value);

                var totalWorkTime = 0;
                if (startTime && endTime) {
                    var start = new Date(startTime);
                    var end = new Date(endTime);
                    if (end > start) {
                        totalWorkTime = (end - start) / (1000 * 60 * 60); // in hours
                    }
                }

                var costPriceMaterials = 0;
                var materialInputs = materialsUsedList.querySelectorAll('.material-select');
                var quantityInputs = materialsUsedList.querySelectorAll('.material-quantity');

                for (var i = 0; i < materialInputs.length; i++) {
                    var materialId = materialInputs[i].value;
                    var quantity = parseFloat(quantityInputs[i].value);
                    if (materialId && !isNaN(quantity) && quantity > 0) {
                        var material = findInArray(appState.materials, function(m) { return m.id === materialId; });
                        if (material) {
                            costPriceMaterials += material.unit_price * quantity;
                        }
                    }
                }

                var workCost = totalWorkTime * hourlyRate;
                var complexityMarkup = workCost * (complexity / 100); // Simple markup based on complexity (e.g., 10% for complexity 10)
                var subtotal = workCost + complexityMarkup + costPriceMaterials;
                var finalPrice = subtotal * (1 - (discount / 100));

                document.getElementById('calculated-work-time').textContent = totalWorkTime.toFixed(2);
                document.getElementById('calculated-cost-price').textContent = formatCurrency(costPriceMaterials);
                document.getElementById('calculated-complexity-markup').textContent = formatCurrency(complexityMarkup);
                document.getElementById('calculated-work-cost').textContent = formatCurrency(workCost);
                document.getElementById('calculated-total-price').textContent = formatCurrency(finalPrice);

                if (returnValues) {
                    return { totalWorkTime: totalWorkTime, costPriceMaterials: costPriceMaterials, complexityMarkup: complexityMarkup, workCost: workCost, finalPrice: finalPrice };
                }
            }
        };


        // 4. Clients Module
        var renderClients = function() {
            var appContent = document.getElementById('app-content');
            appContent.innerHTML = `
                <div class="p-4 md:p-8 bg-gray-700 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-blue-300">Клиенты</h2>

                    <div class="flex justify-end mb-6">
                        <button id="add-client-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-plus mr-2"></i>Додати клієнта
                        </button>
                    </div>

                    <div id="client-form-container" class="hidden bg-gray-800 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-blue-300">Додати/Редагувати клієнта</h3>
                        <form id="client-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="client-id">
                            <div>
                                <label for="client-name" class="block text-sm font-medium text-gray-300">Ім'я</label>
                                <input type="text" id="client-name" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="client-contact" class="block text-sm font-medium text-gray-300">Контакти (телефон/email)</label>
                                <input type="text" id="client-contact" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div class="md:col-span-2">
                                <label for="client-social" class="block text-sm font-medium text-gray-300">Посилання на соцмережі</label>
                                <input type="text" id="client-social" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200" placeholder="https://instagram.com/user">
                            </div>
                            <div class="md:col-span-2">
                                <label for="client-notes" class="block text-sm font-medium text-gray-300">Заметки</label>
                                <textarea id="client-notes" rows="3" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200"></textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label for="client-tags" class="block text-sm font-medium text-gray-300">Метки (через запятую)</label>
                                <input type="text" id="client-tags" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200" placeholder="Постоянный, Пропускал">
                            </div>
                            <div class="md:col-span-2 flex justify-end space-x-3">
                                <button type="button" id="cancel-client-form" class="px-5 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Отмена</button>
                                <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Сохранить клиента</button>
                            </div>
                        </form>
                    </div>

                    <h3 class="text-2xl font-semibold mb-4 text-blue-300">Список клиентов</h3>
                    <div id="clients-list" class="overflow-x-auto">
                        </div>
                </div>
            `;

            document.getElementById('add-client-btn').addEventListener('click', function() {
                document.getElementById('client-form-container').classList.toggle('hidden');
                document.getElementById('client-form').reset();
                document.getElementById('client-id').value = ''; // Clear ID for new client
            });

            document.getElementById('cancel-client-form').addEventListener('click', function() {
                document.getElementById('client-form-container').classList.add('hidden');
                document.getElementById('client-form').reset();
            });

            document.getElementById('client-form').addEventListener('submit', handleAddEditClient);
            renderClientList();
        };

        var handleAddEditClient = function(event) {
            event.preventDefault();
            var form = event.target;
            var clientId = form['client-id'].value;
            var name = form['client-name'].value;
            var contact = form['client-contact'].value;
            var socialLinks = form['client-social'].value;
            var notes = form['client-notes'].value;
            var tags = filterArray(mapArray(form['client-tags'].value.split(','), function(tag) { return tag.trim(); }), function(tag) { return tag !== ''; });

            if (!name || !contact) {
                showModal('Ошибка', 'Имя и контакты клиента обязательны.', 'alert');
                return;
            }

            var promise;
            if (clientId) {
                // Update existing client
                promise = supabase.from('clients').update({ name: name, contact: contact, social_links: socialLinks, notes: notes, tags: tags }).eq('id', clientId);
            } else {
                // Add new client
                promise = supabase.from('clients').insert([{ name: name, contact: contact, social_links: socialLinks, notes: notes, tags: tags }]);
            }

            promise
                .then(function(response) {
                    if (response.error) throw response.error;
                    showModal('Успех', 'Данные клиента успешно ' + (clientId ? 'обновлены' : 'добавлены') + '!', 'alert');
                    form.reset();
                    document.getElementById('client-form-container').classList.add('hidden');
                    fetchDataAndRerenderCurrentPage();
                })
                .catch(function(error) {
                    console.error('Ошибка сохранения клиента:', error.message);
                    showModal('Ошибка', 'Не удалось сохранить клиента: ' + error.message, 'alert');
                });
        };

        var renderClientList = function() {
            var listContainer = document.getElementById('clients-list');
            if (appState.clients.length === 0) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                        <i class="fas fa-users text-6xl mb-4"></i>
                        <p class="text-lg">База клієнтів порожня</p>
                        <button id="add-client-from-empty-btn" class="mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-plus mr-2"></i>Додати клієнта
                        </button>
                    </div>
                `;
                document.getElementById('add-client-from-empty-btn').addEventListener('click', function() {
                    document.getElementById('client-form-container').classList.remove('hidden');
                });
                return;
            }

            listContainer.innerHTML = `
                <table class="min-w-full bg-gray-800 rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-700 text-gray-300 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Ім'я</th>
                            <th class="py-3 px-6 text-left">Контакти</th>
                            <th class="py-3 px-6 text-left">Сеанси</th>
                            <th class="py-3 px-6 text-left">Останній візит</th>
                            <th class="py-3 px-6 text-center rounded-tr-lg">Дії</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-200 text-sm">
                        ${mapArray(appState.clients, function(client) {
                            var clientSessions = filterArray(appState.sessions, function(s) {
                                var app = findInArray(appState.appointments, function(a) { return a.id === s.appointment_id; });
                                return app && app.client_id === client.id;
                            });
                            var lastVisit = clientSessions.length > 0
                                ? formatDate(clientSessions.sort(function(a, b) { return new Date(b.start_time) - new Date(a.start_time); })[0].start_time)
                                : 'N/A';
                            return `
                                <tr class="border-b border-gray-600 hover:bg-gray-700">
                                    <td class="py-3 px-6 text-left font-medium">${client.name}</td>
                                    <td class="py-3 px-6 text-left">${client.contact}</td>
                                    <td class="py-3 px-6 text-left">${clientSessions.length}</td>
                                    <td class="py-3 px-6 text-left">${lastVisit}</td>
                                    <td class="py-3 px-6 text-center">
                                        <button data-id="${client.id}" class="edit-client-btn bg-yellow-600 text-white px-3 py-1 rounded-md text-xs hover:bg-yellow-700 transition-colors mr-2">Редагувати</button>
                                        <button data-id="${client.id}" class="view-client-history-btn bg-purple-600 text-white px-3 py-1 rounded-md text-xs hover:bg-purple-700 transition-colors mr-2">Історія</button>
                                        <button data-id="${client.id}" class="delete-client-btn bg-red-600 text-white px-3 py-1 rounded-md text-xs hover:bg-red-700 transition-colors">Видалити</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            var editClientButtons = listContainer.querySelectorAll('.edit-client-btn');
            for (var i = 0; i < editClientButtons.length; i++) {
                editClientButtons[i].addEventListener('click', function(e) {
                    var clientId = e.target.dataset.id;
                    var client = findInArray(appState.clients, function(c) { return c.id === clientId; });
                    if (client) {
                        document.getElementById('client-id').value = client.id;
                        document.getElementById('client-name').value = client.name;
                        document.getElementById('client-contact').value = client.contact;
                        document.getElementById('client-social').value = client.social_links || '';
                        document.getElementById('client-notes').value = client.notes || '';
                        document.getElementById('client-tags').value = client.tags ? client.tags.join(', ') : '';
                        document.getElementById('client-form-container').classList.remove('hidden');
                    }
                });
            }

            var deleteClientButtons = listContainer.querySelectorAll('.delete-client-btn');
            for (var i = 0; i < deleteClientButtons.length; i++) {
                deleteClientButtons[i].addEventListener('click', function(e) {
                    var clientId = e.target.dataset.id;
                    showModal('Удалить клиента', 'Вы уверены, что хотите удалить этого клиента? Все связанные записи и сеансы останутся, но клиент будет удален из базы.', 'confirm', function() {
                        supabase.from('clients').delete().eq('id', clientId)
                            .then(function(response) {
                                if (response.error) throw response.error;
                                showModal('Успех', 'Клиент успешно удален!', 'alert');
                                fetchDataAndRerenderCurrentPage();
                            })
                            .catch(function(error) {
                                console.error('Ошибка удаления клиента:', error.message);
                                showModal('Ошибка', 'Не удалось удалить клиента: ' + error.message, 'alert');
                            });
                    });
                });
            }

            var viewClientHistoryButtons = listContainer.querySelectorAll('.view-client-history-btn');
            for (var i = 0; i < viewClientHistoryButtons.length; i++) {
                viewClientHistoryButtons[i].addEventListener('click', function(e) {
                    var clientId = e.target.dataset.id;
                    showClientHistoryModal(clientId);
                });
            }
        };

        var showClientHistoryModal = function(clientId) {
            var client = findInArray(appState.clients, function(c) { return c.id === clientId; });
            if (!client) {
                showModal('Ошибка', 'Клиент не найден.', 'alert');
                return;
            }

            var clientAppointments = filterArray(appState.appointments, function(app) { return app.client_id === clientId; })
                .sort(function(a, b) { return new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time); }); // Latest first

            var historyHtml = '';
            if (clientAppointments.length === 0) {
                historyHtml = '<p class="text-gray-400">У этого клиента нет истории визитов.</p>';
            } else {
                historyHtml = `
                    <div class="overflow-x-auto max-h-96">
                        <table class="min-w-full bg-gray-800 rounded-lg shadow-sm text-sm">
                            <thead>
                                <tr class="bg-gray-700 text-gray-300 uppercase text-xs leading-normal">
                                    <th class="py-2 px-4 text-left rounded-tl-lg">Дата</th>
                                    <th class="py-2 px-4 text-left">Время</th>
                                    <th class="py-2 px-4 text-left">Статус</th>
                                    <th class="py-2 px-4 text-left">Цена</th>
                                    <th class="py-2 px-4 text-left">Эскиз</th>
                                    <th class="py-2 px-4 text-left rounded-tr-lg">Заметки</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-200">
                                ${mapArray(clientAppointments, function(app) {
                                    var session = findInArray(appState.sessions, function(s) { return s.appointment_id === app.id; });
                                    return `
                                        <tr class="border-b border-gray-600 hover:bg-gray-700">
                                            <td class="py-2 px-4 whitespace-nowrap">${formatDate(app.date)}</td>
                                            <td class="py-2 px-4">${formatTime(app.time)}</td>
                                            <td class="py-2 px-4">
                                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                                    app.status === 'completed' ? 'bg-green-700 text-green-100' :
                                                    app.status === 'confirmed' ? 'bg-blue-700 text-blue-100' :
                                                    app.status === 'pending' ? 'bg-yellow-700 text-yellow-100' :
                                                    'bg-red-700 text-red-100'
                                                }">
                                                    ${app.status === 'completed' ? 'Завершено' :
                                                      app.status === 'confirmed' ? 'Подтверждено' :
                                                      app.status === 'pending' ? 'Ожидает' :
                                                      'Отменено'}
                                                </span>
                                            </td>
                                            <td class="py-2 px-4 font-semibold">${session ? formatCurrency(session.total_price) : 'N/A'}</td>
                                            <td class="py-2 px-4">
                                                ${app.sketch_url ? `<a href="${app.sketch_url}" target="_blank" class="text-blue-400 hover:underline">Показать</a>` : 'Нет'}
                                            </td>
                                            <td class="py-2 px-4">${session ? (session.notes || 'Нет') : 'Нет'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            showModal(
                'История визитов для ' + client.name,
                `<div class="mb-4">
                    <p class="text-gray-300"><strong>Контакты:</strong> ${client.contact}</p>
                    <p class="text-gray-300"><strong>Соцсети:</strong> ${client.social_links ? `<a href="${client.social_links}" target="_blank" class="text-blue-400 hover:underline">${client.social_links}</a>` : 'N/A'}</p>
                    <p class="text-gray-300"><strong>Заметки:</strong> ${client.notes || 'Нет'}</p>
                    <p class="text-gray-300"><strong>Метки:</strong> ${client.tags && client.tags.length > 0 ? client.tags.join(', ') : 'Нет'}</p>
                </div>
                <h4 class="text-lg font-semibold mb-2 text-gray-300">История сеансов:</h4>
                ${historyHtml}`,
                'alert' // Using alert type, but with rich HTML content
            );
        };


        // 5. Inventory Module
        var renderInventory = function() {
            var appContent = document.getElementById('app-content');
            appContent.innerHTML = `
                <div class="p-4 md:p-8 bg-gray-700 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-blue-300">Матеріали</h2>

                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center space-x-4">
                            <select class="bg-gray-800 text-gray-200 border border-gray-600 rounded-md py-2 px-4 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option>Усі категорії</option>
                                ${mapArray(appState.materialCategories, function(cat) { return `<option value="${cat}">${cat}</option>`; }).join('')}
                            </select>
                            <div class="relative">
                                <input type="text" placeholder="Пошук матеріалів ..." class="bg-gray-800 text-gray-200 border border-gray-600 rounded-md py-2 px-4 pl-10 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                        <button id="add-material-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-plus mr-2"></i>Додати матеріал
                        </button>
                    </div>

                    <p class="text-gray-400 mb-4">Показано ${appState.materials.length} матеріалів</p>

                    <div id="material-form-container" class="hidden bg-gray-800 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-blue-300">Додати/Редагувати матеріал</h3>
                        <form id="material-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="material-id">
                            <div>
                                <label for="material-name" class="block text-sm font-medium text-gray-300">Назва</label>
                                <input type="text" id="material-name" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="material-price" class="block text-sm font-medium text-gray-300">Ціна за одиницю (грн)</label>
                                <input type="number" id="material-price" step="0.01" min="0" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="material-stock" class="block text-sm font-medium text-gray-300">Кількість</label>
                                <input type="number" id="material-stock" step="0.01" min="0" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="material-type" class="block text-sm font-medium text-gray-300">Категорія</label>
                                <select id="material-type" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                                    ${mapArray(appState.materialCategories, function(cat) { return `<option value="${cat}">${cat}</option>`; }).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="material-low-threshold" class="block text-sm font-medium text-gray-300">Поріг низького остатку</label>
                                <input type="number" id="material-low-threshold" step="0.01" min="0" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div class="md:col-span-2 flex justify-end space-x-3">
                                <button type="button" id="cancel-material-form" class="px-5 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Отмена</button>
                                <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Сохранить материал</button>
                            </div>
                        </form>
                    </div>

                    <div id="materials-list" class="overflow-x-auto mb-8">
                        </div>

                    <p class="text-gray-400 mt-4">Двічі клік по матеріалу для швидкого редагування</p>

                    <h3 class="text-2xl font-semibold mb-4 text-blue-300 mt-8">Історія рухів матеріалів</h3>
                    <div id="material-movements-list" class="overflow-x-auto">
                        </div>
                </div>
            `;

            document.getElementById('add-material-btn').addEventListener('click', function() {
                document.getElementById('material-form-container').classList.toggle('hidden');
                document.getElementById('material-form').reset();
                document.getElementById('material-id').value = ''; // Clear ID for new material
            });

            document.getElementById('cancel-material-form').addEventListener('click', function() {
                document.getElementById('material-form-container').classList.add('hidden');
                document.getElementById('material-form').reset();
            });

            document.getElementById('material-form').addEventListener('submit', handleAddEditMaterial);
            renderMaterialsList();
            renderMaterialMovements();
            checkLowStock();
        };

        var handleAddEditMaterial = function(event) {
            event.preventDefault();
            var form = event.target;
            var materialId = form['material-id'].value;
            var name = form['material-name'].value;
            var unitPrice = parseFloat(form['material-price'].value);
            var stock = parseFloat(form['material-stock'].value);
            var type = form['material-type'].value;
            var lowStockThreshold = parseFloat(form['material-low-threshold'].value);

            if (!name || isNaN(unitPrice) || isNaN(stock) || !type || isNaN(lowStockThreshold)) {
                showModal('Ошибка', 'Пожалуйста, заполните все обязательные поля.', 'alert');
                return;
            }

            var promise;
            if (materialId) {
                // Update existing material
                promise = supabase.from('materials').update({ name: name, unit_price: unitPrice, stock: stock, type: type, low_stock_threshold: lowStockThreshold }).eq('id', materialId);
            } else {
                // Add new material
                promise = supabase.from('materials').insert([{ name: name, unit_price: unitPrice, stock: stock, type: type, low_stock_threshold: lowStockThreshold }]);
            }

            promise
                .then(function(response) {
                    if (response.error) throw response.error;
                    showModal('Успех', 'Материал успешно ' + (materialId ? 'обновлен' : 'добавлен') + '!', 'alert');
                    form.reset();
                    document.getElementById('material-form-container').classList.add('hidden');
                    fetchDataAndRerenderCurrentPage();
                })
                .catch(function(error) {
                    console.error('Ошибка сохранения материала:', error.message);
                    showModal('Ошибка', 'Не удалось сохранить материал: ' + error.message, 'alert');
                });
        };

        var renderMaterialsList = function() {
            var listContainer = document.getElementById('materials-list');
            if (appState.materials.length === 0) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                        <i class="fas fa-box-open text-6xl mb-4"></i>
                        <p class="text-lg">Немає матеріалів на складі</p>
                        <button id="add-material-from-empty-btn" class="mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-plus mr-2"></i>Додати матеріал
                        </button>
                    </div>
                `;
                document.getElementById('add-material-from-empty-btn').addEventListener('click', function() {
                    document.getElementById('material-form-container').classList.remove('hidden');
                });
                return;
            }

            listContainer.innerHTML = `
                <table class="min-w-full bg-gray-800 rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-700 text-gray-300 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Назва</th>
                            <th class="py-3 px-6 text-left">Категорія</th>
                            <th class="py-3 px-6 text-left">Кількість</th>
                            <th class="py-3 px-6 text-left">Ціна</th>
                            <th class="py-3 px-6 text-center rounded-tr-lg">Дії</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-200 text-sm">
                        ${mapArray(appState.materials, function(material) {
                            return `
                                <tr class="border-b border-gray-600 hover:bg-gray-700 ${material.stock <= material.low_stock_threshold ? 'bg-red-900/30' : ''}">
                                    <td class="py-3 px-6 text-left font-medium">${material.name}</td>
                                    <td class="py-3 px-6 text-left">${material.type}</td>
                                    <td class="py-3 px-6 text-left">${material.stock}</td>
                                    <td class="py-3 px-6 text-left">${formatCurrency(material.unit_price)}</td>
                                    <td class="py-3 px-6 text-center">
                                        <button data-id="${material.id}" class="edit-material-btn bg-yellow-600 text-white px-3 py-1 rounded-md text-xs hover:bg-yellow-700 transition-colors mr-2">Редагувати</button>
                                        <button data-id="${material.id}" class="delete-material-btn bg-red-600 text-white px-3 py-1 rounded-md text-xs hover:bg-red-700 transition-colors">Видалити</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            var editMaterialButtons = listContainer.querySelectorAll('.edit-material-btn');
            for (var i = 0; i < editMaterialButtons.length; i++) {
                editMaterialButtons[i].addEventListener('click', function(e) {
                    var materialId = e.target.dataset.id;
                    var material = findInArray(appState.materials, function(m) { return m.id === materialId; });
                    if (material) {
                        document.getElementById('material-id').value = material.id;
                        document.getElementById('material-name').value = material.name;
                        document.getElementById('material-price').value = material.unit_price;
                        document.getElementById('material-stock').value = material.stock;
                        document.getElementById('material-type').value = material.type;
                        document.getElementById('material-low-threshold').value = material.low_stock_threshold;
                        document.getElementById('material-form-container').classList.remove('hidden');
                    }
                });
            }

            var deleteMaterialButtons = listContainer.querySelectorAll('.delete-material-btn');
            for (var i = 0; i < deleteMaterialButtons.length; i++) {
                deleteMaterialButtons[i].addEventListener('click', function(e) {
                    var materialId = e.target.dataset.id;
                    showModal('Удалить материал', 'Вы уверены, что хотите удалить этот материал? Это действие необратимо.', 'confirm', function() {
                        supabase.from('materials').delete().eq('id', materialId)
                            .then(function(response) {
                                if (response.error) throw response.error;
                                showModal('Успех', 'Материал успешно удален!', 'alert');
                                fetchDataAndRerenderCurrentPage();
                            })
                            .catch(function(error) {
                                console.error('Ошибка удаления материала:', error.message);
                                showModal('Ошибка', 'Не удалось удалить материал: ' + error.message, 'alert');
                            });
                    });
                });
            }
        };

        var renderMaterialMovements = function() {
            var listContainer = document.getElementById('material-movements-list');
            supabase.from('material_movements').select('*, materials(name)').order('date', { ascending: false })
                .then(function(response) {
                    if (response.error) throw response.error;
                    var movements = response.data;

                    if (movements.length === 0) {
                        listContainer.innerHTML = '<p class="text-gray-400">Нет истории движений материалов.</p>';
                        return;
                    }

                    listContainer.innerHTML = `
                        <table class="min-w-full bg-gray-800 rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gray-700 text-gray-300 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left rounded-tl-lg">Дата</th>
                                    <th class="py-3 px-6 text-left">Материал</th>
                                    <th class="py-3 px-6 text-left">Тип</th>
                                    <th class="py-3 px-6 text-left">Кол-во</th>
                                    <th class="py-3 px-6 text-left rounded-tr-lg">Источник/Цель</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-200 text-sm">
                                ${mapArray(movements, function(move) {
                                    return `
                                        <tr class="border-b border-gray-600 hover:bg-gray-700">
                                            <td class="py-3 px-6 text-left whitespace-nowrap">${new Date(move.date).toLocaleString('uk-UA')}</td>
                                            <td class="py-3 px-6 text-left">${move.materials ? move.materials.name : 'Неизвестно'}</td>
                                            <td class="py-3 px-6 text-left">
                                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${move.type === 'in' ? 'bg-blue-700 text-blue-100' : 'bg-orange-700 text-orange-100'}">
                                                    ${move.type === 'in' ? 'Приход' : 'Расход'}
                                                </span>
                                            </td>
                                            <td class="py-3 px-6 text-left">${move.quantity}</td>
                                            <td class="py-3 px-6 text-left">${move.source_target || 'N/A'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                })
                .catch(function(error) {
                    console.error('Ошибка загрузки истории движений материалов:', error.message);
                    listContainer.innerHTML = `<p class="text-red-400">Ошибка загрузки истории: ${error.message}</p>`;
                });
        };

        var checkLowStock = function() {
            var lowStockMaterials = filterArray(appState.materials, function(m) { return m.stock <= m.low_stock_threshold; });
            if (lowStockMaterials.length > 0) {
                var materialNames = mapArray(lowStockMaterials, function(m) { return m.name; }).join(', ');
                showModal('Низкий остаток материалов', 'Следующие материалы имеют низкий остаток: ' + materialNames + '. Пожалуйста, пополните запасы.', 'alert');
            }
        };


        // 6. Finance Module
        var renderFinance = function() {
            var appContent = document.getElementById('app-content');
            appContent.innerHTML = `
                <div class="p-4 md:p-8 bg-gray-700 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-blue-300">Фінанси</h2>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gray-800 p-5 rounded-lg shadow-sm">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300 mb-1">Дохід (за місяць)</h3>
                                <p class="text-3xl font-bold text-green-400" id="monthly-revenue-finance">${formatCurrency(calculateMonthlyRevenue())}</p>
                                <p class="text-sm text-gray-400">+0% з минулого місяця</p>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-sm">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300 mb-1">Витрати (за місяць)</h3>
                                <p class="text-3xl font-bold text-red-400" id="monthly-expenses-finance">${formatCurrency(calculateMonthlyExpenses())}</p>
                                <p class="text-sm text-gray-400">+0% з минулого місяця</p>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-sm">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300 mb-1">Прибуток</h3>
                                <p class="text-3xl font-bold text-blue-400" id="net-profit">${formatCurrency(calculateNetProfit())}</p>
                                <p class="text-sm text-gray-400">Рентабельність: ${((calculateNetProfit() / calculateTotalRevenue()) * 100 || 0).toFixed(1)}%</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end mb-6">
                        <button id="add-expense-btn" class="px-6 py-3 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors flex items-center">
                            <i class="fas fa-plus mr-2"></i>Додати витрату
                        </button>
                    </div>

                    <div id="expense-form-container" class="hidden bg-gray-800 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-blue-300">Додати новий расход</h3>
                        <form id="expense-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="expense-date" class="block text-sm font-medium text-gray-300">Дата</label>
                                <input type="date" id="expense-date" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="expense-amount" class="block text-sm font-medium text-gray-300">Сумма (грн)</label>
                                <input type="number" id="expense-amount" step="0.01" min="0" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div class="md:col-span-2">
                                <label for="expense-description" class="block text-sm font-medium text-gray-300">Описание</label>
                                <input type="text" id="expense-description" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="expense-category" class="block text-sm font-medium text-gray-300">Категория</label>
                                <input type="text" id="expense-category" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200" placeholder="Аренда, Реклама, Коммунальные">
                            </div>
                            <div class="md:col-span-2 flex justify-end space-x-3">
                                <button type="button" id="cancel-expense-form" class="px-5 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Отмена</button>
                                <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Добавить расход</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-inner mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-semibold text-blue-300">Дохід vs Витрати</h3>
                            <select class="bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-1 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option>12 місяців</option>
                                <option>6 місяців</option>
                                <option>3 місяці</option>
                            </select>
                        </div>
                        <div class="h-64 bg-gray-900 rounded-md flex items-center justify-center text-gray-500">
                            Графік Дохід vs Витрати
                        </div>
                    </div>

                    <h3 class="text-2xl font-semibold mb-4 text-blue-300">Останні операції</h3>
                    <div id="finance-table" class="overflow-x-auto mb-8">
                        </div>

                    <h3 class="text-2xl font-semibold mb-4 text-blue-300">Отчёты</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-800 p-5 rounded-lg shadow-inner">
                            <h4 class="text-lg font-semibold mb-3 text-gray-300">Выручка по месяцам</h4>
                            <div id="monthly-revenue-report"></div>
                        </div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-inner">
                            <h4 class="text-lg font-semibold mb-3 text-gray-300">Выручка по методам оплаты</h4>
                            <div id="payment-method-report"></div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('add-expense-btn').addEventListener('click', function() {
                document.getElementById('expense-form-container').classList.toggle('hidden');
                document.getElementById('expense-form').reset();
            });

            document.getElementById('cancel-expense-form').addEventListener('click', function() {
                document.getElementById('expense-form-container').classList.add('hidden');
                document.getElementById('expense-form').reset();
            });

            document.getElementById('expense-form').addEventListener('submit', handleAddExpense);
            renderFinanceTable();
            renderMonthlyRevenueReport();
            renderPaymentMethodReport();
        };

        var calculateMonthlyExpenses = function() {
            var now = new Date();
            var currentMonth = now.getMonth();
            var currentYear = now.getFullYear();
            return reduceArray(appState.expenses, function(sum, expense) {
                var expenseDate = new Date(expense.date);
                if (expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear) {
                    return sum + expense.amount;
                }
                return sum;
            }, 0);
        };

        var calculateTotalExpenses = function() {
            return reduceArray(appState.expenses, function(sum, expense) { return sum + expense.amount; }, 0);
        };

        var calculateNetProfit = function() {
            return calculateTotalRevenue() - calculateTotalExpenses();
        };

        var handleAddExpense = function(event) {
            event.preventDefault();
            var form = event.target;
            var date = form['expense-date'].value;
            var amount = parseFloat(form['expense-amount'].value);
            var description = form['expense-description'].value;
            var category = form['expense-category'].value;

            if (!date || isNaN(amount) || !description || !category) {
                showModal('Ошибка', 'Пожалуйста, заполните все поля расхода.', 'alert');
                return;
            }

            supabase.from('expenses').insert([{ date: date, amount: amount, description: description, category: category }])
                .then(function(response) {
                    if (response.error) throw response.error;
                    showModal('Успех', 'Расход успешно добавлен!', 'alert');
                    form.reset();
                    document.getElementById('expense-form-container').classList.add('hidden');
                    fetchDataAndRerenderCurrentPage();
                })
                .catch(function(error) {
                    console.error('Ошибка добавления расхода:', error.message);
                    showModal('Ошибка', 'Не удалось добавить расход: ' + error.message, 'alert');
                });
        };

        var renderFinanceTable = function() {
            var tableContainer = document.getElementById('finance-table');
            var combinedData = [];

            mapArray(appState.sessions, function(session) {
                var sessionDate = new Date(session.start_time);
                combinedData.push({
                    type: 'Доход',
                    date: sessionDate.toISOString().split('T')[0],
                    description: 'Сеанс (' + (findInArray(appState.clients, function(c) {
                        var app = findInArray(appState.appointments, function(a) { return a.id === session.appointment_id; });
                        return app ? c.id === app.client_id : false;
                    }) ? findInArray(appState.clients, function(c) {
                        var app = findInArray(appState.appointments, function(a) { return a.id === session.appointment_id; });
                        return app ? c.id === app.client_id : false;
                    }).name : 'Неизвестно') + ')',
                    amount: session.total_price,
                    category: 'Тату-сеанс',
                    paymentMethod: session.payment_method
                });
            });

            mapArray(appState.expenses, function(expense) {
                combinedData.push({
                    type: 'Расход',
                    date: expense.date,
                    description: expense.description,
                    amount: expense.amount,
                    category: expense.category,
                    paymentMethod: 'N/A'
                });
            });

            combinedData.sort(function(a, b) { return new Date(b.date) - new Date(a.date); }); // Sort by date, newest first

            if (combinedData.length === 0) {
                tableContainer.innerHTML = '<p class="text-gray-400">Нет финансовых операций.</p>';
                return;
            }

            tableContainer.innerHTML = `
                <table class="min-w-full bg-gray-800 rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-700 text-gray-300 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Дата</th>
                            <th class="py-3 px-6 text-left">Тип</th>
                            <th class="py-3 px-6 text-left">Описание</th>
                            <th class="py-3 px-6 text-left">Категория</th>
                            <th class="py-3 px-6 text-left">Метод оплаты</th>
                            <th class="py-3 px-6 text-left rounded-tr-lg">Сумма</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-200 text-sm">
                        ${mapArray(combinedData, function(item) {
                            return `
                                <tr class="border-b border-gray-600 hover:bg-gray-700">
                                    <td class="py-3 px-6 text-left whitespace-nowrap">${formatDate(item.date)}</td>
                                    <td class="py-3 px-6 text-left">
                                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${item.type === 'Доход' ? 'bg-green-700 text-green-100' : 'bg-red-700 text-red-100'}">
                                            ${item.type}
                                        </span>
                                    </td>
                                    <td class="py-3 px-6 text-left">${item.description}</td>
                                    <td class="py-3 px-6 text-left">${item.category}</td>
                                    <td class="py-3 px-6 text-left">${item.paymentMethod === 'cash' ? 'Наличные' : item.paymentMethod === 'card' ? 'Карта' : item.paymentMethod === 'transfer' ? 'Перевод' : item.paymentMethod}</td>
                                    <td class="py-3 px-6 text-left font-semibold ${item.type === 'Доход' ? 'text-green-400' : 'text-red-400'}">${formatCurrency(item.amount)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        };

        var renderMonthlyRevenueReport = function() {
            var reportContainer = document.getElementById('monthly-revenue-report');
            var monthlyData = {};

            mapArray(appState.sessions, function(session) {
                var sessionDate = new Date(session.start_time);
                var monthYear = sessionDate.getFullYear() + '-' + customPadStart((sessionDate.getMonth() + 1), 2, '0');
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = 0;
                }
                monthlyData[monthYear] += session.total_price;
            });

            var sortedMonths = Object.keys(monthlyData).sort();

            if (sortedMonths.length === 0) {
                reportContainer.innerHTML = '<p class="text-gray-400">Нет данных о выручке по месяцам.</p>';
                return;
            }

            reportContainer.innerHTML = `
                <ul class="list-disc list-inside space-y-1 text-gray-200">
                    ${mapArray(sortedMonths, function(month) {
                        return `
                        <li>${month}: <span class="font-semibold">${formatCurrency(monthlyData[month])}</span></li>
                    `;
                    }).join('')}
                </ul>
            `;
        };

        var renderPaymentMethodReport = function() {
            var reportContainer = document.getElementById('payment-method-report');
            var paymentMethodData = {
                cash: 0,
                card: 0,
                transfer: 0
            };

            mapArray(appState.sessions, function(session) {
                if (paymentMethodData.hasOwnProperty(session.payment_method)) {
                    paymentMethodData[session.payment_method] += session.total_price;
                }
            });

            var totalRevenue = calculateTotalRevenue();

            if (totalRevenue === 0) {
                reportContainer.innerHTML = '<p class="text-gray-400">Нет данных о выручке по методам оплаты.</p>';
                return;
            }

            reportContainer.innerHTML = `
                <ul class="list-disc list-inside space-y-1 text-gray-200">
                    <li>Наличные: <span class="font-semibold">${formatCurrency(paymentMethodData.cash)} (${((paymentMethodData.cash / totalRevenue) * 100 || 0).toFixed(1)}%)</span></li>
                    <li>Карта: <span class="font-semibold">${formatCurrency(paymentMethodData.card)} (${((paymentMethodData.card / totalRevenue) * 100 || 0).toFixed(1)}%)</span></li>
                    <li>Перевод: <span class="font-semibold">${formatCurrency(paymentMethodData.transfer)} (${((paymentMethodData.transfer / totalRevenue) * 100 || 0).toFixed(1)}%)</span></li>
                </ul>
            `;
        };


        // 7. Settings Module
        var renderSettings = function() {
            var appContent = document.getElementById('app-content');
            appContent.innerHTML = `
                <div class="p-4 md:p-8 bg-gray-700 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-blue-300">Налаштування</h2>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-blue-300">Основні налаштування</h3>
                        <form id="settings-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="hourly-rate" class="block text-sm font-medium text-gray-300">Почасова ставка (грн)</label>
                                <input type="number" id="hourly-rate" step="0.01" min="0" value="${appState.hourlyRate}" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="currency" class="block text-sm font-medium text-gray-300">Валюта</label>
                                <select id="currency" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                                    <option value="UAH">Гривня (грн)</option>
                                    <option value="USD">Доллар (USD)</option>
                                    <option value="EUR">Евро (EUR)</option>
                                </select>
                            </div>
                            <div>
                                <label for="language" class="block text-sm font-medium text-gray-300">Мова інтерфейсу</label>
                                <select id="language" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                                    <option value="uk-UA">Українська</option>
                                    <option value="en-US">English</option>
                                </select>
                            </div>
                            <div>
                                <label for="date-format" class="block text-sm font-medium text-gray-300">Формат дати</label>
                                <select id="date-format" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                                    <option value="DD.MM.YYYY">ДД.ММ.ГГГГ</option>
                                    <option value="MM/DD/YYYY">ММ/ДД/ГГГГ</option>
                                </select>
                            </div>
                            <div class="md:col-span-2 flex justify-end">
                                <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-colors">
                                    Зберегти налаштування
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-blue-300">Категорії витрат</h3>
                        <div id="expense-categories-list" class="mb-4">
                            ${mapArray(appState.materialCategories, function(cat) { // Using materialCategories for now, should be separate expenseCategories
                                return `
                                <div class="flex items-center justify-between bg-gray-700 p-3 rounded-md mb-2">
                                    <span class="text-gray-200">${cat}</span>
                                    <div class="flex space-x-2">
                                        <button class="text-blue-400 hover:text-blue-300"><i class="fas fa-pencil-alt"></i></button>
                                        <button class="text-red-400 hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="new-expense-category" placeholder="Назва нової категорії" class="flex-1 p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            <button id="add-expense-category-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-inner">
                        <h3 class="text-xl font-semibold mb-4 text-blue-300">Категорії матеріалів</h3>
                        <div id="material-categories-list" class="mb-4">
                            ${mapArray(appState.materialCategories, function(cat) {
                                return `
                                <div class="flex items-center justify-between bg-gray-700 p-3 rounded-md mb-2">
                                    <span class="text-gray-200">${cat}</span>
                                    <div class="flex space-x-2">
                                        <button class="text-blue-400 hover:text-blue-300"><i class="fas fa-pencil-alt"></i></button>
                                        <button class="text-red-400 hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="new-material-category" placeholder="Назва нової категорії" class="flex-1 p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            <button id="add-material-category-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('settings-form').addEventListener('submit', handleSaveSettings);

            // Add/Edit category logic (simplified, full implementation would require more state management)
            document.getElementById('add-expense-category-btn').addEventListener('click', function() {
                var newCatInput = document.getElementById('new-expense-category');
                if (newCatInput.value.trim() !== '') {
                    // For now, adding to materialCategories for demonstration.
                    // In a real app, you'd have a separate array for expense categories.
                    appState.materialCategories.push(newCatInput.value.trim());
                    newCatInput.value = '';
                    renderSettings(); // Re-render settings to show new category
                }
            });
            document.getElementById('add-material-category-btn').addEventListener('click', function() {
                var newCatInput = document.getElementById('new-material-category');
                if (newCatInput.value.trim() !== '') {
                    appState.materialCategories.push(newCatInput.value.trim());
                    newCatInput.value = '';
                    renderSettings(); // Re-render settings to show new category
                }
            });
        };

        var handleSaveSettings = function(event) {
            event.preventDefault();
            var form = event.target;
            var hourlyRate = parseFloat(form['hourly-rate'].value);
            var materialCategories = filterArray(mapArray(form['material-categories'].value.split(','), function(cat) { return cat.trim(); }), function(cat) { return cat !== ''; });

            if (isNaN(hourlyRate) || hourlyRate < 0) {
                showModal('Ошибка', 'Ставка за час должна быть положительным числом.', 'alert');
                return;
            }

            // Assuming there's only one settings row, update it
            var settingsId = appState.settings && appState.settings.length > 0 ? appState.settings[0].id : null;
            var promise;

            if (settingsId) {
                promise = supabase.from('settings').update({ hourly_rate: hourlyRate, material_categories: materialCategories }).eq('id', settingsId);
            } else {
                promise = supabase.from('settings').insert([{ hourly_rate: hourlyRate, material_categories: materialCategories }]);
            }

            promise
                .then(function(response) {
                    if (response.error) {
                        // If no settings row exists, insert one (PGRST116 is a common code for no rows found on update)
                        if (response.error.code === 'PGRST116' || response.error.message.includes('no rows found')) {
                            return supabase.from('settings').insert([{ hourly_rate: hourlyRate, material_categories: materialCategories }]);
                        } else {
                            throw response.error;
                        }
                    }
                    return response; // Pass through successful update response
                })
                .then(function() {
                    showModal('Успех', 'Настройки успешно сохранены!', 'alert');
                    fetchDataAndRerenderCurrentPage();
                })
                .catch(function(error) {
                    console.error('Ошибка сохранения настроек:', error.message);
                    showModal('Ошибка', 'Не удалось сохранить настройки: ' + error.message, 'alert');
                });
        };


        // Initial load and event listeners
        window.addEventListener('hashchange', handleRouteChange);
        window.addEventListener('load', function() {
            fetchData().then(function() {
                setupRealtimeSubscriptions();
                handleRouteChange(); // Initial route handling after data is loaded
            });
        });
    </script>
</body>
</html>
