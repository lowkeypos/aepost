<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RDNCK.TATTOO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Темный фон */
            color: #e0e0e0; /* Светлый текст */
        }
        /* Пользовательский скроллбар для лучшей эстетики */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        /* Скрыть скроллбар для определенных элементов при необходимости */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none; /* IE и Edge */
            scrollbar-width: none; /* Firefox */
        }

        /* Стиль активной вкладки навигации */
        .nav-link.active {
            background-color: #2a2a2a; /* Более темный фон для активной вкладки */
            color: #6366f1; /* Фиолетовый акцент */
            border-left: 4px solid #6366f1; /* Акцентная полоса */
            padding-left: 1rem; /* Отступ для полосы */
        }

        /* Фон модального окна */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7); /* Более темный фон для модальных окон */
            overflow-y: auto; /* Позволяет прокручивать сам оверлей */
            padding: 1rem; /* Отступ для модальных окон на мобильных */
        }

        /* Общий стиль кнопок */
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out;
        }
        .btn-danger {
            @apply bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out;
        }
        /* Стиль полей ввода */
        .input-field {
            /* Добавлено !important для принудительного применения стилей */
            background-color: #4a4a4a !important; /* Чуть светлее, чем фон карточек */
            border: 1px solid #5a5a5a !important; /* Темнее, чем фон, но светлее, чем основной фон */
            color: #e0e0e0 !important; /* Светлый текст */
            padding: 0.75rem !important; /* p-3 */
            border-radius: 0.5rem !important; /* rounded-lg */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important; /* shadow-sm */
            transition: all 0.2s ease-in-out !important; /* transition duration-200 ease-in-out */
            outline: none !important; /* focus:outline-none */
        }
        .input-field:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5) !important; /* focus:ring-2 focus:ring-blue-500 */
            border-color: #3b82f6 !important; /* focus:border-blue-500 */
        }

        /* Стиль таблицы */
        .table-header {
            @apply bg-gray-700 text-gray-300 uppercase text-sm leading-normal;
        }
        .table-row {
            @apply border-b border-gray-700 hover:bg-gray-800;
        }
        .table-cell {
            @apply py-3 px-6 text-left text-gray-200;
        }
        /* Карточки */
        .card {
            @apply bg-gray-800 p-6 rounded-xl shadow-lg;
        }
        .card-header {
            @apply text-xl font-semibold text-gray-100 mb-4;
        }
        .card-body {
            @apply text-gray-300;
        }
        /* Для мобильной навигации */
        #mobile-nav-toggle {
            @apply md:hidden block text-white text-2xl cursor-pointer;
        }
        #mobile-nav-menu {
            @apply fixed top-0 left-0 w-64 h-full bg-gray-900 z-50 transform -translate-x-full transition-transform duration-300 ease-in-out md:static md:translate-x-0;
        }
        #mobile-nav-menu.open {
            transform: translateX(0);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row bg-gray-900">

    <div id="mobile-nav-toggle" class="fixed top-4 left-4 z-50 md:hidden">
        <i class="fas fa-bars"></i>
    </div>

    <nav id="mobile-nav-menu" class="w-full md:w-64 bg-gray-800 text-white p-4 flex flex-col justify-between shadow-lg">
        <div>
            <div class="text-2xl font-bold mb-4 text-center border-b border-gray-700 pb-4">RDNK.TATTOO</div>
            <ul class="space-y-2">
                <li>
                    <a href="#dashboard" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200 ease-in-out active">
                        <i class="fas fa-home mr-3"></i>
                        <span>Главная</span>
                    </a>
                </li>
                <li>
                    <a href="#appointments" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200 ease-in-out">
                        <i class="fas fa-calendar-alt mr-3"></i>
                        <span>Записи</span>
                    </a>
                </li>
                <li>
                    <a href="#clients" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200 ease-in-out">
                        <i class="fas fa-users mr-3"></i>
                        <span>Клиенты</span>
                    </a>
                </li>
                <li>
                    <a href="#inventory" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200 ease-in-out">
                        <i class="fas fa-boxes mr-3"></i>
                        <span>Инвентарь</span>
                    </a>
                </li>
                <li>
                    <a href="#finance" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200 ease-in-out">
                        <i class="fas fa-wallet mr-3"></i>
                        <span>Финансы</span>
                    </a>
                </li>
                <li>
                    <a href="#settings" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-200 ease-in-out">
                        <i class="fas fa-cog mr-3"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </div>
        <div class="mt-auto p-2 text-sm text-gray-400 border-t border-gray-700 pt-4">
            <p class="mb-2">User ID: <span id="current-user-id">Загрузка...</span></p>
            <button id="logout-btn" class="flex items-center p-3 rounded-lg bg-red-700 hover:bg-red-800 transition duration-200 ease-in-out w-full text-left">
                <i class="fas fa-sign-out-alt mr-3"></i>
                <span>Выйти</span>
            </button>
        </div>
    </nav>

    <main id="app-content" class="flex-1 overflow-y-auto p-6 md:p-8 bg-gray-900 ml-0 md:ml-64 transition-all duration-300">
        <div class="flex items-center justify-center h-full text-gray-500 text-xl">
            Загрузка...
        </div>
    </main>

    <div id="appointment-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-lg mx-4 transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto" id="appointment-modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-100" id="appointment-modal-title">Создать Запись</h2>
            <form id="appointment-form" class="space-y-4">
                <div>
                    <label for="appointment-client-phone" class="block text-sm font-medium text-gray-300 mb-1">Телефон клиента</label>
                    <input type="tel" id="appointment-client-phone" class="input-field w-full" placeholder="+380XXXXXXXXX" required>
                </div>
                <div id="client-selection-area">
                    <label for="appointment-client" class="block text-sm font-medium text-gray-300 mb-1">Выбрать существующего клиента</label>
                    <select id="appointment-client" class="input-field w-full appearance-none">
                        </select>
                    <p id="client-status-message" class="text-sm mt-2 text-gray-400"></p>
                </div>
                <div id="new-client-details" class="hidden space-y-4 border-t border-gray-700 pt-4 mt-4">
                    <h3 class="text-lg font-semibold text-gray-100">Новый клиент</h3>
                    <div>
                        <label for="new-client-name" class="block text-sm font-medium text-gray-300 mb-1">Имя нового клиента</label>
                        <input type="text" id="new-client-name" class="input-field w-full">
                    </div>
                    <div>
                        <label for="new-client-email" class="block text-sm font-medium text-gray-300 mb-1">Email нового клиента (необязательно)</label>
                        <input type="email" id="new-client-email" class="input-field w-full">
                    </div>
                    <div>
                        <label for="new-client-instagram" class="block text-sm font-medium text-gray-300 mb-1">Instagram/Telegram</label>
                        <input type="text" id="new-client-instagram" class="input-field w-full" placeholder="@username">
                    </div>
                </div>
                <div>
                    <label for="appointment-date" class="block text-sm font-medium text-gray-300 mb-1">Дата</label>
                    <input type="date" id="appointment-date" class="input-field w-full" required>
                </div>
                <div>
                    <label for="appointment-time" class="block text-sm font-medium text-gray-300 mb-1">Время</label>
                    <input type="time" id="appointment-time" class="input-field w-full" required>
                </div>
                <div>
                    <label for="appointment-duration" class="block text-sm font-medium text-gray-300 mb-1">Предполагаемая длительность (часы)</label>
                    <input type="number" id="appointment-duration" class="input-field w-full" min="0.5" step="0.5" required>
                </div>
                <div>
                    <label for="appointment-complexity" class="block text-sm font-medium text-gray-300 mb-1">Сложность (1-10)</label>
                    <input type="number" id="appointment-complexity" class="input-field w-full" min="1" max="10" required>
                </div>
                <div>
                    <label for="appointment-sketch" class="block text-sm font-medium text-gray-300 mb-1">Эскиз (URL)</label>
                    <input type="url" id="appointment-sketch" class="input-field w-full" placeholder="http://example.com/sketch.jpg">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-appointment-modal" class="btn-secondary">Отмена</button>
                    <button type="submit" class="btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <div id="session-calculator-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-2xl mx-4 transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto" id="session-calculator-modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-100">Калькулятор Сеанса</h2>
            <div id="session-client-info" class="mb-4 text-lg font-medium text-gray-300"></div>
            <div id="session-appointment-info" class="mb-6 text-gray-400"></div>

            <div class="flex items-center justify-center mb-6">
                <img id="session-sketch-preview" src="https://placehold.co/150x150/2a2a2a/e0e0e0?text=Эскиз" alt="Эскиз тату" class="rounded-lg shadow-md max-w-[300px] max-h-[300px] object-cover border border-gray-700">
            </div>

            <form id="session-calculator-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="session-work-time" class="block text-sm font-medium text-gray-300 mb-1">Время работы (часы)</label>
                    <input type="number" id="session-work-time" class="input-field w-full" min="0.5" step="0.5" required>
                </div>
                <div>
                    <label for="session-hourly-rate" class="block text-sm font-medium text-gray-300 mb-1">Ставка за час (грн)</label>
                    <input type="number" id="session-hourly-rate" class="input-field w-full" min="0" step="0.01" readonly>
                </div>
                <div>
                    <label for="session-complexity-markup" class="block text-sm font-medium text-gray-300 mb-1">Наценка за сложность (%)</label>
                    <input type="number" id="session-complexity-markup" class="input-field w-full" min="0" step="1" readonly>
                </div>
                <div>
                    <label for="session-discount" class="block text-sm font-medium text-gray-300 mb-1">Скидка (%)</label>
                    <input type="number" id="session-discount" class="input-field w-full" min="0" max="100" step="1" value="0">
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Использованные расходники</label>
                    <div id="session-consumables-list" class="space-y-2 max-h-48 overflow-y-auto pr-2 no-scrollbar border border-gray-700 rounded-lg p-2 bg-gray-900">
                        <div class="flex items-center justify-between p-2 bg-gray-800 rounded-lg shadow-sm hidden">
                            <span class="text-gray-300">Название материала</span>
                            <div class="flex items-center space-x-2">
                                <input type="number" value="1" min="0.1" step="0.1" class="w-20 input-field text-center consumable-qty">
                                <span class="text-gray-400">ед.</span>
                                <span class="font-semibold text-gray-100 consumable-price">0.00 грн</span>
                                <button type="button" class="text-red-500 hover:text-red-700 remove-consumable-btn"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="add-consumable-btn" class="btn-secondary mt-3 text-sm"><i class="fas fa-plus mr-2"></i>Добавить расходник</button>
                    <div id="add-consumable-dropdown" class="hidden mt-2 p-2 bg-gray-800 border border-gray-700 rounded-lg shadow-md max-h-48 overflow-y-auto no-scrollbar">
                        <input type="text" id="consumable-search" class="input-field w-full mb-2" placeholder="Поиск материала...">
                        <div id="consumable-search-results" class="space-y-1">
                            </div>
                    </div>
                </div>

                <div class="md:col-span-2 mt-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg font-medium text-gray-300">Себестоимость (материалы):</span>
                        <span id="session-cost-price" class="text-xl font-bold text-red-500">0.00 грн</span>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg font-medium text-gray-300">Итоговая цена:</span>
                        <span id="session-total-price" class="text-2xl font-bold text-green-500">0.00 грн</span>
                    </div>
                </div>

                <div class="md:col-span-2 flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-session-modal" class="btn-secondary">Отмена</button>
                    <button type="button" id="pay-session-btn" class="btn-primary"><i class="fas fa-money-bill-wave mr-2"></i>Оплата</button>
                    <button type="button" id="print-receipt-btn" class="btn-secondary"><i class="fas fa-print mr-2"></i>Печать чека</button>
                </div>
            </form>
        </div>
    </div>

    <div id="expense-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-lg mx-4 transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto" id="expense-modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-100">Добавить Расход</h2>
            <form id="expense-form" class="space-y-4">
                <div>
                    <label for="expense-description" class="block text-sm font-medium text-gray-300 mb-1">Описание</label>
                    <input type="text" id="expense-description" class="input-field w-full" required>
                </div>
                <div>
                    <label for="expense-amount" class="block text-sm font-medium text-gray-300 mb-1">Сумма (грн)</label>
                    <input type="number" id="expense-amount" class="input-field w-full" min="0.01" step="0.01" required>
                </div>
                <div>
                    <label for="expense-date" class="block text-sm font-medium text-gray-300 mb-1">Дата</label>
                    <input type="date" id="expense-date" class="input-field w-full" required>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-expense-modal" class="btn-secondary">Отмена</button>
                    <button type="submit" class="btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <div id="material-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-lg mx-4 transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto" id="material-modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-100" id="material-modal-title">Добавить Материал</h2>
            <form id="material-form" class="space-y-4">
                <input type="hidden" id="material-id">
                <div>
                    <label for="material-name" class="block text-sm font-medium text-gray-300 mb-1">Название</label>
                    <input type="text" id="material-name" class="input-field w-full" required>
                </div>
                <div>
                    <label for="material-price-unit" class="block text-sm font-medium text-gray-300 mb-1">Цена за единицу (грн)</label>
                    <input type="number" id="material-price-unit" class="input-field w-full" min="0.01" step="0.01" required>
                </div>
                <div>
                    <label for="material-quantity" class="block text-sm font-medium text-gray-300 mb-1">Остаток</label>
                    <input type="number" id="material-quantity" class="input-field w-full" min="0" step="0.01" required>
                </div>
                <div>
                    <label for="material-type" class="block text-sm font-medium text-gray-300 mb-1">Вид</label>
                    <input type="text" id="material-type" class="input-field w-full" placeholder="Например: Иглы, Краска, Средство">
                </div>
                <div>
                    <label for="material-min-stock" class="block text-sm font-medium text-gray-300 mb-1">Минимальный остаток для уведомления</label>
                    <input type="number" id="material-min-stock" class="input-field w-full" min="0" step="0.01" value="1">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-material-modal" class="btn-secondary">Отмена</button>
                    <button type="submit" class="btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <div id="client-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-lg mx-4 transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto" id="client-modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-100" id="client-modal-title">Добавить Клиента</h2>
            <form id="client-form" class="space-y-4">
                <input type="hidden" id="client-id">
                <div>
                    <label for="client-name" class="block text-sm font-medium text-gray-300 mb-1">Имя</label>
                    <input type="text" id="client-name" class="input-field w-full" required>
                </div>
                <div>
                    <label for="client-phone" class="block text-sm font-medium text-gray-300 mb-1">Телефон</label>
                    <input type="tel" id="client-phone" class="input-field w-full" placeholder="+380XXXXXXXXX">
                </div>
                <div>
                    <label for="client-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                    <input type="email" id="client-email" class="input-field w-full">
                </div>
                <div>
                    <label for="client-instagram" class="block text-sm font-medium text-gray-300 mb-1">Instagram (ссылка)</label>
                    <input type="text" id="client-instagram" class="input-field w-full" placeholder="@username">
                </div>
                <div>
                    <label for="client-notes" class="block text-sm font-medium text-gray-300 mb-1">Заметки</label>
                    <textarea id="client-notes" class="input-field w-full h-24 resize-y"></textarea>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-client-modal" class="btn-secondary">Отмена</button>
                    <button type="submit" class="btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <div id="message-box-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4 transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto" id="message-box-modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-100" id="message-box-title">Уведомление</h3>
            <p id="message-box-text" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end">
                <button type="button" id="message-box-ok" class="btn-primary">ОК</button>
            </div>
        </div>
    </div>

    <canvas id="receipt-canvas" class="hidden"></canvas>

    <div id="login-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto" id="login-modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-100 text-center">Вход</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                    <input type="email" id="login-email" class="input-field w-full" placeholder="email@example.com" required>
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-300 mb-1">Пароль</label>
                    <input type="password" id="login-password" class="input-field w-full" placeholder="********" required>
                </div>
                <p id="login-error-message" class="text-red-500 text-sm hidden">Неверный Email или пароль.</p>
                <div class="flex justify-center">
                    <button type="submit" class="btn-primary w-full">Войти</button>
                </div>
            </form>
            <p class="text-center text-sm text-gray-400 mt-4">
                Нет аккаунта? <a href="#" id="show-signup" class="text-blue-500 hover:underline">Зарегистрироваться</a>
            </p>
        </div>
    </div>

    <div id="signup-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto" id="signup-modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-100 text-center">Регистрация</h2>
            <form id="signup-form" class="space-y-4">
                <div>
                    <label for="signup-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                    <input type="email" id="signup-email" class="input-field w-full" placeholder="email@example.com" required>
                </div>
                <div>
                    <label for="signup-password" class="block text-sm font-medium text-gray-300 mb-1">Пароль</label>
                    <input type="password" id="signup-password" class="input-field w-full" placeholder="********" required>
                </div>
                <div>
                    <label for="signup-password-confirm" class="block text-sm font-medium text-gray-300 mb-1">Подтвердите пароль</label>
                    <input type="password" id="signup-password-confirm" class="input-field w-full" placeholder="********" required>
                </div>
                <p id="signup-error-message" class="text-red-500 text-sm hidden">Пароли не совпадают или произошла ошибка.</p>
                <div class="flex justify-center">
                    <button type="submit" class="btn-primary w-full">Зарегистрироваться</button>
                </div>
            </form>
            <p class="text-center text-sm text-gray-400 mt-4">
                Уже есть аккаунт? <a href="#" id="show-login" class="text-blue-500 hover:underline">Войти</a>
            </p>
        </div>
    </div>

    <script type="module">
        // Импорт клиента Supabase
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Конфигурация Supabase - ЗАМЕНИТЕ НА ВАШИ АКТУАЛЬНЫЕ ДАННЫЕ ПРОЕКТА SUPABASE
        // Вы можете найти их в вашем проекте Supabase: Project Settings -> API
        const supabaseUrl = 'https://wdfpusnhkpkwupuuanar.supabase.co'; // Например, 'https://abcde12345.supabase.co'
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkZnB1c25oa3Brd3VwdXVhbmFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyNzY2MTIsImV4cCI6MjA2Mzg1MjYxMn0.w83zm_VOHLjvdLsvGKLp11gBBNLev9ICnm7XHzrQdmE'; // Это публичный "анонимный" ключ вашего проекта

        // Базовая проверка на неконфигурированные данные Supabase
        if (!supabaseUrl || !supabaseAnonKey || supabaseUrl === 'YOUR_SUPABASE_URL' || supabaseAnonKey === 'YOUR_SUPABASE_ANON_KEY') {
            console.error("URL или Anon Key Supabase не настроены. Пожалуйста, замените 'YOUR_SUPABASE_URL' и 'YOUR_SUPABASE_ANON_KEY' на актуальные данные вашего проекта Supabase.");
            // Отображение сообщения пользователю, если Supabase не настроен
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('app-content').innerHTML = `
                    <div class="flex items-center justify-center h-full text-red-500 text-xl text-center p-4">
                        Ошибка конфигурации Supabase.<br>Пожалуйста, обновите 'YOUR_SUPABASE_URL' и 'YOUR_SUPABASE_ANON_KEY' в коде.
                    </div>
                `;
            });
            throw new Error("Отсутствует конфигурация Supabase."); // Остановка выполнения скрипта
        }

        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        let userId = null; // Для хранения ID текущего аутентифицированного пользователя
        let isAuthReady = false; // Флаг, указывающий, была ли проверена аутентификация

        // Глобальное хранилище данных (кэш)
        let clients = [];
        let appointments = [];
        let materials = [];
        let expenses = [];
        let sales = [];
        let settings = {
            hourlyRate: 500, // грн
            materialCategories: ['Иглы', 'Краска', 'Средства', 'Прочее'],
            lowStockThreshold: 5, // По умолчанию для уведомлений
            studioName: 'RDNCK.TATTOO' // Название студии по умолчанию
        };

        let currentAppointmentForSession = null; // Для калькулятора сеанса

        // --- Вспомогательные функции для UI ---

        /**
         * Показывает модальное окно.
         * @param {HTMLElement} modalElement - Элемент модального окна.
         * @param {HTMLElement} contentElement - Элемент контента модального окна для анимации.
         */
        function showModal(modalElement, contentElement) {
            modalElement.classList.remove('hidden');
            setTimeout(() => {
                contentElement.classList.remove('opacity-0', 'scale-95');
                contentElement.classList.add('opacity-100', 'scale-100');
            }, 50); // Небольшая задержка для срабатывания анимации
        }

        /**
         * Скрывает модальное окно.
         * @param {HTMLElement} modalElement - Элемент модального окна.
         * @param {HTMLElement} contentElement - Элемент контента модального окна для анимации.
         */
        function hideModal(modalElement, contentElement) {
            contentElement.classList.remove('opacity-100', 'scale-100');
            contentElement.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modalElement.classList.add('hidden');
            }, 300); // Соответствует длительности transition
        }

        /**
         * Показывает сообщение в кастомном модальном окне.
         * @param {string} title - Заголовок сообщения.
         * @param {string} message - Текст сообщения.
         */
        function showMessageBox(title, message) {
            const modal = document.getElementById('message-box-modal');
            const content = document.getElementById('message-box-modal-content');
            document.getElementById('message-box-title').textContent = title;
            document.getElementById('message-box-text').textContent = message;
            showModal(modal, content);
        }

        /**
         * Форматирует число как валюту (грн).
         * @param {number} amount - Сумма.
         * @returns {string} Отформатированная строка.
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('uk-UA', {
                style: 'currency',
                currency: 'UAH',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        /**
         * Форматирует дату.
         * @param {string} dateString - Строка даты.
         * @returns {string} Отформатированная строка даты.
         */
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('uk-UA', options);
        }

        /**
         * Форматирует время.
         * @param {string} timeString - Строка времени.
         * @returns {string} Отформатированная строка времени.
         */
        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':');
            return `${hours}:${minutes}`;
        }

        /**
         * Загружает контент страницы в основной блок приложения.
         * @param {string} contentHtml - HTML-строка для загрузки.
         */
        function loadContent(contentHtml) {
            const appContent = document.getElementById('app-content');
            appContent.innerHTML = contentHtml;
        }

        /**
         * Обновляет активный класс для навигационных ссылок.
         * @param {string} hash - Хэш текущей страницы.
         */
        function updateNavLinkActiveState(hash) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.querySelector(`.nav-link[href="${hash}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        // --- Вспомогательные функции для преобразования camelCase в snake_case для Supabase ---
        function toSnakeCase(obj) {
            const newObj = {};
            for (const key in obj) {
                if (Object.prototype.hasOwnProperty.call(obj, key)) {
                    const snakeKey = key.replace(/([A-Z])/g, "_$1").toLowerCase();
                    newObj[snakeKey] = obj[key];
                }
            }
            return newObj;
        }

        // --- Вспомогательные функции для преобразования snake_case в camelCase для JS ---
        function toCamelCase(obj) {
            const newObj = {};
            for (const key in obj) {
                if (Object.prototype.hasOwnProperty.call(obj, key)) {
                    const camelKey = key.replace(/_([a-z])/g, (g) => g[1].toUpperCase());
                    newObj[camelKey] = obj[key];
                }
            }
            return newObj;
        }

        // --- Операции с данными Supabase ---
        const activeSupabaseSubscriptions = {}; // Для управления активными подписками

        /**
         * Настраивает слушатель в реальном времени для таблицы Supabase.
         * @param {string} tableName - Имя таблицы для прослушивания.
         * @param {function} callback - Функция обратного вызова для обработки данных.
         */
        async function setupSupabaseListener(tableName, callback) {
            if (!userId) {
                console.error('Пользователь не аутентифицирован, не удалось настроить слушатель Supabase для', tableName);
                return;
            }

            // Удалить существующую подписку для этой таблицы, если она есть
            if (activeSupabaseSubscriptions[tableName]) {
                supabase.removeChannel(activeSupabaseSubscriptions[tableName]);
                delete activeSupabaseSubscriptions[tableName];
            }

            const channel = supabase.channel(`${tableName}_channel_${userId}`); // Уникальный канал для каждого пользователя и таблицы
            const subscription = channel
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: tableName, filter: `user_id=eq.${userId}` }, // Фильтр по user_id непосредственно в слушателе
                    payload => {
                        console.log(`Изменение в реальном времени в ${tableName}:`, payload);
                        fetchAndSetData(tableName, callback); // Повторно получить все данные при изменении
                    }
                )
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log(`Подписан на ${tableName} для пользователя ${userId}`);
                        fetchAndSetData(tableName, callback); // Начальная выборка при подписке
                    } else if (status === 'CLOSED') {
                        console.log(`Подписка на ${tableName} закрыта`);
                    } else if (status === 'CHANNEL_ERROR') {
                        console.error(`Ошибка в подписке на ${tableName}`);
                    }
                });
            activeSupabaseSubscriptions[tableName] = channel; // Сохранить объект канала
            return subscription;
        }

        /**
         * Получает и устанавливает данные для данной таблицы.
         * @param {string} tableName - Имя таблицы.
         * @param {function} callback - Функция обратного вызова для обновления глобального массива данных.
         */
        async function fetchAndSetData(tableName, callback) {
            if (!userId) {
                console.error('ID пользователя недоступен для получения данных для', tableName);
                return;
            }
            try {
                const { data, error } = await supabase
                    .from(tableName)
                    .select('*')
                    .eq('user_id', userId); // Фильтр по user_id для RLS

                if (error) throw error;

                const camelCaseData = data.map(toCamelCase);
                callback(camelCaseData);
            } catch (e) {
                console.error(`Ошибка при получении ${tableName}:`, e.message);
                showMessageBox('Ошибка', `Не удалось загрузить данные: ${e.message}`);
            }
        }

        /**
         * Добавляет документ в таблицу Supabase.
         * @param {string} tableName - Имя таблицы.
         * @param {object} record - Данные для добавления.
         * @returns {Promise<string|null>} ID новой записи или null, если произошла ошибка.
         */
        async function addDocument(tableName, record) {
            if (!userId) {
                showMessageBox('Ошибка', 'Система не готова. Пожалуйста, войдите в систему.');
                return null;
            }
            try {
                // Для продаж генерируем номер заказа
                if (tableName === 'sales') {
                    const { data: latestSale, error: latestSaleError } = await supabase
                        .from('sales')
                        .select('order_number')
                        .eq('user_id', userId)
                        .order('order_number', { ascending: false })
                        .limit(1);

                    if (latestSaleError) throw latestSaleError;

                    const lastOrderNumber = latestSale.length > 0 ? latestSale[0].order_number : 0;
                    record.orderNumber = lastOrderNumber + 1;
                }

                const recordWithUserId = { ...record, user_id: userId };
                const snakeCaseRecord = toSnakeCase(recordWithUserId);
                const { data: insertedData, error } = await supabase
                    .from(tableName)
                    .insert([snakeCaseRecord])
                    .select();

                if (error) throw error;
                showMessageBox('Успех', 'Данные успешно добавлены!');
                return insertedData[0].id;
            } catch (e) {
                console.error("Ошибка при добавлении документа: ", e);
                showMessageBox('Ошибка', `Не удалось добавить данные: ${e.message}`);
                return null;
            }
        }

        /**
         * Обновляет документ в таблице Supabase.
         * @param {string} tableName - Имя таблицы.
         * @param {string} id - ID записи для обновления.
         * @param {object} record - Данные для обновления.
         */
        async function updateDocument(tableName, id, record) {
            if (!userId) {
                showMessageBox('Ошибка', 'Система не готова. Пожалуйста, войдите в систему.');
                return;
            }
            try {
                const snakeCaseRecord = toSnakeCase(record);
                const { error } = await supabase
                    .from(tableName)
                    .update(snakeCaseRecord)
                    .eq('id', id)
                    .eq('user_id', userId); // Убедитесь, что пользователь владеет записью

                if (error) throw error;
                showMessageBox('Успех', 'Данные успешно обновлены!');
            } catch (e) {
                console.error("Ошибка при обновлении документа: ", e);
                showMessageBox('Ошибка', `Не удалось обновить данные: ${e.message}`);
            }
        }

        /**
         * Удаляет документ из таблицы Supabase.
         * @param {string} tableName - Имя таблицы.
         * @param {string} id - ID записи для удаления.
         */
        async function deleteDocument(tableName, id) {
            if (!userId) {
                showMessageBox('Ошибка', 'Система не готова. Пожалуйста, войдите в систему.');
                return;
            }
            try {
                const { error } = await supabase
                    .from(tableName)
                    .delete()
                    .eq('id', id)
                    .eq('user_id', userId); // Убедитесь, что пользователь владеет записью

                if (error) throw error;
                showMessageBox('Успех', 'Данные успешно удалены!');
            } catch (e) {
                console.error("Ошибка при удалении документа: ", e);
                showMessageBox('Ошибка', `Не удалось удалить данные: ${e.message}`);
            }
        }

        // --- Функции рендеринга страниц ---

        /**
         * Рендерит страницу "Главная".
         */
        async function renderDashboard() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Начало сегодняшнего дня

            const upcomingAppointments = appointments.filter(app => {
                const appDate = new Date(app.date + 'T' + app.time);
                return appDate >= today && app.status !== 'completed' && app.status !== 'cancelled';
            }).sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));

            const totalSalesAmount = sales.reduce((sum, sale) => sum + sale.totalPrice, 0);
            const totalExpensesAmount = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const netProfit = totalSalesAmount - totalExpensesAmount;

            const lowStockMaterials = materials.filter(mat => mat.quantity <= mat.minStock);

            loadContent(`
                <div class="space-y-8 p-4">
                    <h1 class="text-3xl font-bold text-gray-100 mb-6">Dashboard</h1>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="card text-center">
                            <p class="text-sm text-gray-400">Total Revenue</p>
                            <p class="text-3xl font-bold text-green-400">${formatCurrency(totalSalesAmount)}</p>
                        </div>
                        <div class="card text-center">
                            <p class="text-sm text-gray-400">Upcoming Appointments</p>
                            <p class="text-3xl font-bold text-blue-400">${upcomingAppointments.length}</p>
                        </div>
                        <div class="card text-center">
                            <p class="text-sm text-gray-400">Total Clients</p>
                            <p class="text-3xl font-bold text-purple-400">${clients.length}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card">
                            <h2 class="card-header">Upcoming Appointments</h2>
                            ${upcomingAppointments.length > 0 ? `
                                <div class="space-y-4">
                                    ${upcomingAppointments.slice(0, 3).map(app => `
                                        <div class="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                                            <div>
                                                <p class="font-semibold text-gray-100">${clients.find(c => c.id === app.clientId)?.name || 'Неизвестно'}</p>
                                                <p class="text-sm text-gray-400">${formatDate(app.date)} at ${formatTime(app.time)}</p>
                                            </div>
                                            <button data-id="${app.id}" class="btn-primary text-sm px-3 py-1 confirm-visit-btn">Confirm</button>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="mt-6 text-center">
                                    <button onclick="window.location.hash='#appointments'" class="btn-secondary text-sm">View All Appointments</button>
                                </div>
                            ` : '<p class="text-gray-400 text-center">No upcoming appointments.</p>'}
                        </div>

                        <div class="card">
                            <h2 class="card-header">Recent Clients</h2>
                            ${clients.length > 0 ? `
                                <div class="space-y-4">
                                    ${clients.slice(0, 3).map(client => `
                                        <div class="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                                            <div>
                                                <p class="font-semibold text-gray-100">${client.name}</p>
                                                <p class="text-sm text-gray-400">${client.phone || client.email || '-'}</p>
                                            </div>
                                            <button data-id="${client.id}" class="btn-secondary text-sm px-3 py-1 edit-client-btn">View</button>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="mt-6 text-center">
                                    <button onclick="window.location.hash='#clients'" class="btn-secondary text-sm">View All Clients</button>
                                </div>
                            ` : '<p class="text-gray-400 text-center">No clients yet.</p>'}
                        </div>
                    </div>

                    <div class="card mt-8">
                        <h2 class="card-header flex items-center text-red-400">
                            <i class="fas fa-exclamation-triangle mr-2"></i> Low Stock Alert
                        </h2>
                        ${lowStockMaterials.length > 0 ? `
                            <ul class="list-disc list-inside space-y-2 text-gray-300">
                                ${lowStockMaterials.map(mat => `
                                    <li>${mat.name} (remaining: ${mat.quantity} units, min: ${mat.minStock} units)</li>
                                `).join('')}
                            </ul>
                        ` : '<p class="text-gray-400">All materials are in sufficient quantity.</p>'}
                    </div>
                </div>
            `);

            // Прикрепление слушателей событий для быстрых действий (если они будут добавлены)
            // document.getElementById('add-appointment-btn-dashboard').addEventListener('click', () => { openAppointmentModal(); });
            // document.getElementById('add-expense-btn-dashboard').addEventListener('click', () => { openExpenseModal(); });
            // document.getElementById('add-material-btn-dashboard').addEventListener('click', () => { openMaterialModal(); });

            // Прикрепление слушателей событий для кнопок "Confirm"
            document.querySelectorAll('.confirm-visit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const appointmentId = e.currentTarget.dataset.id;
                    const appointment = appointments.find(app => app.id === appointmentId);
                    if (appointment) {
                        openSessionCalculatorModal(appointment);
                    }
                });
            });

            document.querySelectorAll('.edit-client-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const clientId = e.currentTarget.dataset.id;
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        openClientModal(client);
                    }
                });
            });
        }

        /**
         * Рендерит страницу "Записи".
         */
        async function renderAppointments(searchTerm = '') {
            let filteredAppointments = appointments;

            if (searchTerm) {
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                filteredAppointments = appointments.filter(app => {
                    const client = clients.find(c => c.id === app.clientId);
                    return (client && client.name.toLowerCase().includes(lowerCaseSearchTerm)) ||
                           (client && client.phone && client.phone.toLowerCase().includes(lowerCaseSearchTerm)) ||
                           (app.sketch && app.sketch.toLowerCase().includes(lowerCaseSearchTerm)) ||
                           (app.status && app.status.toLowerCase().includes(lowerCaseSearchTerm));
                });
            }

            loadContent(`
                <div class="space-y-6 p-4">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-100">Appointments</h1>
                        <button id="add-appointment-btn" class="btn-primary">
                            <i class="fas fa-plus-circle mr-2"></i> New Appointment
                        </button>
                    </div>

                    <div class="mb-6">
                        <input type="text" id="appointment-search-input" placeholder="Search by client name, phone, or status..." class="input-field w-full">
                    </div>

                    <div class="flex space-x-2 mb-6">
                        <button class="filter-btn active bg-blue-600 text-white px-4 py-2 rounded-lg" data-filter="all">All</button>
                        <button class="filter-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg" data-filter="pending">Scheduled</button>
                        <button class="filter-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg" data-filter="completed">Completed</button>
                        <button class="filter-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg" data-filter="cancelled">Cancelled</button>
                    </div>

                    <div id="appointments-list" class="space-y-4">
                        ${filteredAppointments.length > 0 ? `
                            ${filteredAppointments.sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time)).map(app => {
                                const client = clients.find(c => c.id === app.clientId);
                                const statusClass = app.status === 'pending' ? 'bg-yellow-500' : app.status === 'completed' ? 'bg-green-500' : 'bg-red-500';
                                const statusText = app.status === 'pending' ? 'Scheduled' : app.status === 'completed' ? 'Completed' : 'Cancelled';
                                return `
                                    <div class="card flex flex-col md:flex-row justify-between items-start md:items-center p-4">
                                        <div>
                                            <p class="font-semibold text-gray-100">${client ? client.name : 'Unknown Client'}</p>
                                            <p class="text-sm text-gray-400">${formatDate(app.date)} at ${formatTime(app.time)} - ${app.duration} hours</p>
                                        </div>
                                         
                                        <div class="flex items-center space-x-3 mt-3 md:mt-0">
                                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass} text-white">${statusText}</span>
                                            <button data-id="${app.id}" class="btn-primary text-sm px-3 py-1 confirm-visit-btn">Confirm</button>
                                            <button data-id="${app.id}" class="btn-secondary text-sm px-3 py-1 edit-appointment-btn">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button data-id="${app.id}" class="btn-danger text-sm px-3 py-1 delete-appointment-btn">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        ` : '<p class="text-gray-400 text-center">No appointments found.</p>'}
                    </div>
                </div>
            `);
        document.querySelectorAll('.confirm-visit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const appointmentId = e.currentTarget.dataset.id;
                    const appointment = appointments.find(app => app.id === appointmentId);
                    if (appointment) {
                        openSessionCalculatorModal(appointment);
                    }
                });
            });

            document.querySelectorAll('.edit-client-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const clientId = e.currentTarget.dataset.id;
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        openClientModal(client);
                    }
                });
            });
        }
            document.getElementById('add-appointment-btn').addEventListener('click', () => {
                openAppointmentModal();
            });

            // Search functionality
            const appointmentSearchInput = document.getElementById('appointment-search-input');
            let searchTimeout;
            appointmentSearchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    renderAppointments(appointmentSearchInput.value.trim());
                }, 300);
            });

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active', 'bg-blue-600', 'text-white');
                        btn.classList.add('bg-gray-700', 'text-gray-300');
                    });
                    e.currentTarget.classList.add('active', 'bg-blue-600', 'text-white');
                    e.currentTarget.classList.remove('bg-gray-700', 'text-gray-300');

                    const filter = e.currentTarget.dataset.filter;
                    let filtered = appointments;
                    if (filter !== 'all') {
                        filtered = appointments.filter(app => app.status === filter);
                    }
                    updateAppointmentsList(filtered);
                });
            });

            function updateAppointmentsList(filtered) {
                const appointmentsListContainer = document.getElementById('appointments-list');
                if (!appointmentsListContainer) return;

                if (filtered.length === 0) {
                    appointmentsListContainer.innerHTML = '<p class="text-gray-400 text-center">No appointments found for this filter.</p>';
                    return;
                }

                appointmentsListContainer.innerHTML = filtered.sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time)).map(app => {
                    const client = clients.find(c => c.id === app.clientId);
                    const statusClass = app.status === 'pending' ? 'bg-yellow-500' : app.status === 'completed' ? 'bg-green-500' : 'bg-red-500';
                    const statusText = app.status === 'pending' ? 'Scheduled' : app.status === 'completed' ? 'Completed' : 'Cancelled';
                    return `
                        <div class="card flex flex-col md:flex-row justify-between items-start md:items-center p-4">
                            <div>
                                <p class="font-semibold text-gray-100">${client ? client.name : 'Unknown Client'}</p>
                                <p class="text-sm text-gray-400">${formatDate(app.date)} at ${formatTime(app.time)} - ${app.duration} hours</p>
                            </div>
                            <div class="flex items-center space-x-3 mt-3 md:mt-0">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass} text-white">${statusText}</span>
                                <button data-id="${app.id}" class="btn-secondary text-sm px-3 py-1 edit-appointment-btn">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button data-id="${app.id}" class="btn-danger text-sm px-3 py-1 delete-appointment-btn">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                attachAppointmentActionListeners();
            }


            // Attach listeners after rendering
            attachAppointmentActionListeners();
      

        function attachAppointmentActionListeners() {
            document.querySelectorAll('.edit-appointment-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const appointmentId = e.currentTarget.dataset.id;
                    const appointment = appointments.find(app => app.id === appointmentId);
                    if (appointment) {
                        openAppointmentModal(appointment);
                    }
                });
            });

            document.querySelectorAll('.delete-appointment-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const appointmentId = e.currentTarget.dataset.id;
                    showMessageBox('Confirmation', 'Are you sure you want to delete this appointment?');
                    document.getElementById('message-box-ok').onclick = async () => {
                        await deleteDocument('appointments', appointmentId);
                        hideModal(document.getElementById('message-box-modal'), document.getElementById('message-box-modal-content'));
                    };
                });
            });

        /**
         * Рендерит страницу "Клиенты".
         */
        async function renderClients() {
            loadContent(`
                <div class="space-y-6 p-4">
                    <h1 class="text-3xl font-bold text-gray-100 mb-6">Clients</h1>
                    <button id="add-client-btn" class="btn-primary mb-6">
                        <i class="fas fa-user-plus mr-2"></i> Add New Client
                    </button>

                    <div class="card">
                        <h2 class="card-header">Client List</h2>
                        <input type="text" id="client-search-input" class="input-field w-full mb-4" placeholder="Search by name or phone number...">
                        <div id="clients-list-container">
                            ${clients.length > 0 ? `
                                <div class="overflow-x-auto rounded-lg border border-gray-700">
                                    <table class="min-w-full divide-y divide-gray-700">
                                        <thead class="table-header">
                                            <tr>
                                                <th class="table-cell">Name</th>
                                                <th class="table-cell">Phone</th>
                                                <th class="table-cell">Email</th>
                                                <th class="table-cell">Instagram</th>
                                                <th class="table-cell">Notes</th>
                                                <th class="table-cell">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-gray-800 divide-y divide-gray-700" id="clients-table-body">
                                            ${clients.map(client => `
                                                <tr class="table-row">
                                                    <td class="table-cell">${client.name}</td>
                                                    <td class="table-cell">${client.phone || '-'}</td>
                                                    <td class="table-cell">${client.email || '-'}</td>
                                                    <td class="table-cell">
                                                        ${client.instagram ? `<a href="${client.instagram.startsWith('http') ? client.instagram : 'https://instagram.com/' + client.instagram.replace('@', '')}" target="_blank" class="text-blue-400 hover:underline"><i class="fab fa-instagram"></i> ${client.instagram}</a>` : '-'}
                                                    </td>
                                                    <td class="table-cell max-w-xs truncate">${client.notes || '-'}</td>
                                                    <td class="table-cell flex space-x-2">
                                                        <button data-id="${client.id}" class="btn-secondary text-sm px-3 py-1 edit-client-btn">
                                                            <i class="fas fa-edit mr-1"></i> Edit
                                                        </button>
                                                        <button data-id="${client.id}" class="btn-danger text-sm px-3 py-1 delete-client-btn">
                                                            <i class="fas fa-trash mr-1"></i> Delete
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p class="text-gray-400">No clients in the database.</p>'}
                        </div>
                    </div>
                </div>
            `);

            document.getElementById('add-client-btn').addEventListener('click', () => {
                openClientModal();
            });

            // Функциональность поиска клиентов
            const clientSearchInput = document.getElementById('client-search-input');
            clientSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredClients = clients.filter(client =>
                    client.name.toLowerCase().includes(searchTerm) ||
                    (client.phone && client.phone.toLowerCase().includes(searchTerm))
                );
                updateClientsTable(filteredClients);
            });

            function updateClientsTable(filteredClients) {
                const clientsTableBody = document.getElementById('clients-table-body');
                if (!clientsTableBody) return; // Убедитесь, что элемент существует

                clientsTableBody.innerHTML = filteredClients.map(client => `
                    <tr class="table-row">
                        <td class="table-cell">${client.name}</td>
                        <td class="table-cell">${client.phone || '-'}</td>
                        <td class="table-cell">${client.email || '-'}</td>
                        <td class="table-cell">
                            ${client.instagram ? `<a href="${client.instagram.startsWith('http') ? client.instagram : 'https://instagram.com/' + client.instagram.replace('@', '')}" target="_blank" class="text-blue-400 hover:underline"><i class="fab fa-instagram"></i> ${client.instagram}</a>` : '-'}
                        </td>
                        <td class="table-cell max-w-xs truncate">${client.notes || '-'}</td>
                        <td class="table-cell flex space-x-2">
                            <button data-id="${client.id}" class="btn-secondary text-sm px-3 py-1 edit-client-btn">
                                <i class="fas fa-edit mr-1"></i> Edit
                            </button>
                            <button data-id="${client.id}" class="btn-danger text-sm px-3 py-1 delete-client-btn">
                                <i class="fas fa-trash mr-1"></i> Delete
                            </button>
                        </td>
                    </tr>
                `).join('');

                // Повторное прикрепление слушателей событий для кнопок редактирования/удаления после повторного рендеринга
                attachClientActionListeners();
            }

            function attachClientActionListeners() {
                document.querySelectorAll('.edit-client-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const clientId = e.currentTarget.dataset.id;
                        const client = clients.find(c => c.id === clientId);
                        if (client) {
                            openClientModal(client);
                        }
                    });
                });

                document.querySelectorAll('.delete-client-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const clientId = e.currentTarget.dataset.id;
                        // Используем кастомное модальное окно вместо нативного confirm
                        showMessageBox('Confirmation', 'Are you sure you want to delete this client?');
                        document.getElementById('message-box-ok').onclick = async () => {
                            await deleteDocument('clients', clientId);
                            hideModal(document.getElementById('message-box-modal'), document.getElementById('message-box-modal-content'));
                        };
                    });
                });
            }
            attachClientActionListeners(); // Начальное прикрепление
        }

        /**
         * Рендерит страницу "Инвентарь".
         */
        async function renderInventory() {
            loadContent(`
                <div class="space-y-6 p-4">
                    <h1 class="text-3xl font-bold text-gray-100 mb-6">Inventory</h1>
                    <button id="add-material-btn" class="btn-primary mb-6">
                        <i class="fas fa-box-open mr-2"></i> Add New Material
                    </button>

                    <div class="card">
                        <h2 class="card-header">Material List</h2>
                        ${materials.length > 0 ? `
                            <div class="overflow-x-auto rounded-lg border border-gray-700">
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="table-header">
                                        <tr>
                                            <th class="table-cell">Name</th>
                                            <th class="table-cell">Type</th>
                                            <th class="table-cell">Price per Unit</th>
                                            <th class="table-cell">Quantity</th>
                                            <th class="table-cell">Min Stock</th>
                                            <th class="table-cell">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-gray-800 divide-y divide-gray-700">
                                        ${materials.map(mat => `
                                            <tr class="table-row ${mat.quantity <= mat.minStock ? 'bg-red-900/20' : ''}">
                                                <td class="table-cell">${mat.name}</td>
                                                <td class="table-cell">${mat.type || '-'}</td>
                                                <td class="table-cell">${formatCurrency(mat.pricePerUnit)}</td>
                                                <td class="table-cell">${mat.quantity} units.</td>
                                                <td class="table-cell">${mat.minStock} units.</td>
                                                <td class="table-cell flex space-x-2">
                                                    <button data-id="${mat.id}" class="btn-secondary text-sm px-3 py-1 edit-material-btn">
                                                        <i class="fas fa-edit mr-1"></i> Edit
                                                    </button>
                                                    <button data-id="${mat.id}" class="btn-danger text-sm px-3 py-1 delete-material-btn">
                                                        <i class="fas fa-trash mr-1"></i> Delete
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p class="text-gray-400">No materials in inventory.</p>'}
                    </div>
                </div>
            `);

            document.getElementById('add-material-btn').addEventListener('click', () => {
                openMaterialModal();
            });

            document.querySelectorAll('.edit-material-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const materialId = e.currentTarget.dataset.id;
                    const material = materials.find(m => m.id === materialId);
                    if (material) {
                        openMaterialModal(material);
                    }
                });
            });

            document.querySelectorAll('.delete-material-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const materialId = e.currentTarget.dataset.id;
                    // Используем кастомное модальное окно вместо нативного confirm
                    showMessageBox('Confirmation', 'Are you sure you want to delete this material?');
                    document.getElementById('message-box-ok').onclick = async () => {
                        await deleteDocument('materials', materialId);
                        hideModal(document.getElementById('message-box-modal'), document.getElementById('message-box-modal-content'));
                    };
                });
            });
        }

        /**
         * Рендерит страницу "Финансы".
         */
        async function renderFinance() {
            // Рассчитываем ежедневную/ежемесячную выручку
            const dailyRevenue = {};
            const monthlyRevenue = {};

            sales.forEach(sale => {
                const saleDate = new Date(sale.date);
                const dayKey = saleDate.toISOString().split('T')[0]; // ГГГГ-ММ-ДД
                const monthKey = saleDate.getFullYear() + '-' + (saleDate.getMonth() + 1).toString().padStart(2, '0'); // ГГГГ-ММ

                dailyRevenue[dayKey] = (dailyRevenue[dayKey] || 0) + sale.totalPrice;
                monthlyRevenue[monthKey] = (monthlyRevenue[monthKey] || 0) + sale.totalPrice;
            });

            expenses.forEach(expense => {
                const expenseDate = new Date(expense.date);
                const dayKey = expenseDate.toISOString().split('T')[0];
                const monthKey = expenseDate.getFullYear() + '-' + (expenseDate.getMonth() + 1).toString().padStart(2, '0');

                dailyRevenue[dayKey] = (dailyRevenue[dayKey] || 0) - expense.amount;
                monthlyRevenue[monthKey] = (monthlyRevenue[monthKey] || 0) - expense.amount;
            });

            const sortedDailyRevenue = Object.entries(dailyRevenue).sort((a, b) => new Date(a[0]) - new Date(b[0]));
            const sortedMonthlyRevenue = Object.entries(monthlyRevenue).sort((a, b) => new Date(a[0]) - new Date(b[0]));

            // Топ клиентов по общей сумме потраченных средств
            const clientSpending = {};
            sales.forEach(sale => {
                clientSpending[sale.clientId] = (clientSpending[sale.clientId] || 0) + sale.totalPrice;
            });
            const topClients = Object.entries(clientSpending)
                .map(([clientId, totalSpent]) => ({
                    client: clients.find(c => c.id === clientId),
                    totalSpent
                }))
                .filter(item => item.client) // Отфильтровать продажи без соответствующего клиента
                .sort((a, b) => b.totalSpent - a.totalSpent)
                .slice(0, 5); // Топ 5 клиентов

            loadContent(`
                <div class="space-y-6 p-4">
                    <h1 class="text-3xl font-bold text-gray-100 mb-6">Finances</h1>
                    <button id="add-expense-btn" class="btn-primary mb-6">
                        <i class="fas fa-plus-circle mr-2"></i> Add Expense
                    </button>

                    <div class="card grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-8">
                        <div class="bg-blue-900/20 p-4 rounded-lg shadow-sm">
                            <p class="text-sm text-gray-400">Total Revenue</p>
                            <p class="text-2xl font-bold text-blue-400">${formatCurrency(sales.reduce((sum, s) => sum + s.totalPrice, 0))}</p>
                        </div>
                        <div class="bg-red-900/20 p-4 rounded-lg shadow-sm">
                            <p class="text-sm text-gray-400">Total Expenses</p>
                            <p class="text-2xl font-bold text-red-400">${formatCurrency(expenses.reduce((sum, e) => sum + e.amount, 0))}</p>
                        </div>
                        <div class="bg-green-900/20 p-4 rounded-lg shadow-sm">
                            <p class="text-sm text-gray-400">Net Profit</p>
                            <p class="text-2xl font-bold text-green-400">${formatCurrency(sales.reduce((sum, s) => sum + s.totalPrice, 0) - expenses.reduce((sum, e) => sum + e.amount, 0))}</p>
                        </div>
                    </div>

                    <div class="card mb-8">
                        <h2 class="card-header">Daily Revenue</h2>
                        ${sortedDailyRevenue.length > 0 ? `
                            <div class="overflow-x-auto rounded-lg border border-gray-700">
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="table-header">
                                        <tr>
                                            <th class="table-cell">Date</th>
                                            <th class="table-cell">Amount (Net)</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-gray-800 divide-y divide-gray-700">
                                        ${sortedDailyRevenue.map(([date, amount]) => `
                                            <tr class="table-row">
                                                <td class="table-cell">${formatDate(date)}</td>
                                                <td class="table-cell">${formatCurrency(amount)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p class="text-gray-400">No daily revenue data.</p>'}
                    </div>

                    <div class="card mb-8">
                        <h2 class="card-header">Monthly Revenue</h2>
                        ${sortedMonthlyRevenue.length > 0 ? `
                            <div class="overflow-x-auto rounded-lg border border-gray-700">
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="table-header">
                                        <tr>
                                            <th class="table-cell">Month</th>
                                            <th class="table-cell">Amount (Net)</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-gray-800 divide-y divide-gray-700">
                                        ${sortedMonthlyRevenue.map(([month, amount]) => `
                                            <tr class="table-row">
                                                <td class="table-cell">${month}</td>
                                                <td class="table-cell">${formatCurrency(amount)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p class="text-gray-400">No monthly revenue data.</p>'}
                    </div>

                    <div class="card mb-8">
                        <h2 class="card-header">Expense List</h2>
                        ${expenses.length > 0 ? `
                            <div class="overflow-x-auto rounded-lg border border-gray-700">
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="table-header">
                                        <tr>
                                            <th class="table-cell">Date</th>
                                            <th class="table-cell">Description</th>
                                            <th class="table-cell">Amount</th>
                                            <th class="table-cell">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-gray-800 divide-y divide-gray-700">
                                        ${expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(expense => `
                                            <tr class="table-row">
                                                <td class="table-cell">${formatDate(expense.date)}</td>
                                                <td class="table-cell">${expense.description}</td>
                                                <td class="table-cell">${formatCurrency(expense.amount)}</td>
                                                <td class="table-cell">
                                                    <button data-id="${expense.id}" class="btn-danger text-sm px-3 py-1 delete-expense-btn">
                                                        <i class="fas fa-trash mr-1"></i> Delete
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p class="text-gray-400">No expenses recorded.</p>'}
                    </div>

                    <div class="card mb-8">
                        <h2 class="card-header">Sales List</h2>
                        ${sales.length > 0 ? `
                            <div class="overflow-x-auto rounded-lg border border-gray-700">
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="table-header">
                                        <tr>
                                            <th class="table-cell">Order #</th>
                                            <th class="table-cell">Date</th>
                                            <th class="table-cell">Client</th>
                                            <th class="table-cell">Amount</th>
                                            <th class="table-cell">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-gray-800 divide-y divide-gray-700">
                                        ${sales.sort((a, b) => b.orderNumber - a.orderNumber).map(sale => `
                                            <tr class="table-row">
                                                <td class="table-cell">${sale.orderNumber || '-'}</td>
                                                <td class="table-cell">${formatDate(sale.date)} ${formatTime(sale.time)}</td>
                                                <td class="table-cell">${clients.find(c => c.id === sale.clientId)?.name || 'Unknown'}</td>
                                                <td class="table-cell">${formatCurrency(sale.totalPrice)}</td>
                                                <td class="table-cell">
                                                    <button data-id="${sale.id}" class="btn-secondary text-sm px-3 py-1 print-existing-receipt-btn">
                                                        <i class="fas fa-print mr-1"></i> Print
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p class="text-gray-400">No sales recorded.</p>'}
                    </div>

                    <div class="card">
                        <h2 class="card-header">Top Clients</h2>
                        ${topClients.length > 0 ? `
                            <div class="overflow-x-auto rounded-lg border border-gray-700">
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="table-header">
                                        <tr>
                                            <th class="table-cell">Client</th>
                                            <th class="table-cell">Amount Spent</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-gray-800 divide-y divide-gray-700">
                                        ${topClients.map(item => `
                                            <tr class="table-row">
                                                <td class="table-cell">${item.client.name}</td>
                                                <td class="table-cell">${formatCurrency(item.totalSpent)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p class="text-gray-400">No top clients data.</p>'}
                    </div>
                </div>
            `);

            document.getElementById('add-expense-btn').addEventListener('click', () => {
                openExpenseModal();
            });

            document.querySelectorAll('.delete-expense-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const expenseId = e.currentTarget.dataset.id;
                    showMessageBox('Confirmation', 'Are you sure you want to delete this expense?');
                    document.getElementById('message-box-ok').onclick = async () => {
                        await deleteDocument('expenses', expenseId);
                        hideModal(document.getElementById('message-box-modal'), document.getElementById('message-box-modal-content'));
                    };
                });
            });

            document.querySelectorAll('.print-existing-receipt-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const saleId = e.currentTarget.dataset.id;
                    const sale = sales.find(s => s.id === saleId);
                    if (sale) {
                        generateReceiptImage(sale);
                    }
                });
            });
        }

        /**
         * Рендерит страницу "Настройки".
         */
        async function renderSettings() {
            loadContent(`
                <div class="space-y-6 p-4">
                    <h1 class="text-3xl font-bold text-gray-100 mb-6">Settings</h1>

                    <div class="card mb-8">
                        <h2 class="card-header">General Settings</h2>
                        <form id="general-settings-form" class="space-y-4">
                            <div>
                                <label for="studio-name-setting" class="block text-sm font-medium text-gray-300 mb-1">Studio Name</label>
                                <input type="text" id="studio-name-setting" class="input-field w-full" value="${settings.studioName || ''}">
                            </div>
                            <div>
                                <label for="hourly-rate-setting" class="block text-sm font-medium text-gray-300 mb-1">Hourly Rate (UAH)</label>
                                <input type="number" id="hourly-rate-setting" class="input-field w-full" min="0" step="0.01" value="${settings.hourlyRate}">
                            </div>
                            <div>
                                <label for="low-stock-threshold-setting" class="block text-sm font-medium text-gray-300 mb-1">Low Stock Notification Threshold</label>
                                <input type="number" id="low-stock-threshold-setting" class="input-field w-full" min="0" step="0.01" value="${settings.lowStockThreshold}">
                            </div>
                            <button type="submit" class="btn-primary">Save General Settings</button>
                        </form>
                    </div>

                    <div class="card">
                        <h2 class="card-header">Material Categories</h2>
                        <div id="material-categories-list" class="space-y-2 mb-4">
                            ${settings.materialCategories.map((cat, index) => `
                                <div class="flex items-center space-x-3">
                                    <input type="text" value="${cat}" class="input-field flex-grow material-category-input" data-index="${index}">
                                    <button type="button" class="btn-danger text-sm px-3 py-1 remove-category-btn" data-index="${index}">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="new-category-input" class="input-field flex-grow" placeholder="New category">
                            <button id="add-category-btn" class="btn-secondary">Add</button>
                        </div>
                        <button id="save-categories-btn" class="btn-primary mt-4">Save Categories</button>
                    </div>
                </div>
            `);

            // Форма общих настроек
            document.getElementById('general-settings-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newStudioName = document.getElementById('studio-name-setting').value.trim();
                const newHourlyRate = parseFloat(document.getElementById('hourly-rate-setting').value);
                const newLowStockThreshold = parseFloat(document.getElementById('low-stock-threshold-setting').value);
                if (!isNaN(newHourlyRate) && !isNaN(newLowStockThreshold)) {
                    settings.studioName = newStudioName;
                    settings.hourlyRate = newHourlyRate;
                    settings.lowStockThreshold = newLowStockThreshold;
                    // Предполагается, что существует один документ настроек, его ID может быть 'app-settings' или производным от userId
                    // Для простоты, давайте предположим 'user-settings' как фиксированный ID для настроек текущего пользователя.
                    // В реальном приложении вы можете получить ID существующего документа настроек.
                    const { data: existingSettings, error: fetchError } = await supabase.from('settings').select('id').eq('user_id', userId).single();
                    if (fetchError && fetchError.code !== 'PGRST116') { // PGRST116 means no rows found
                        console.error("Error fetching existing settings:", fetchError.message);
                        showMessageBox('Error', `Failed to load settings: ${fetchError.message}`);
                        return;
                    }

                    if (existingSettings) {
                        await updateDocument('settings', existingSettings.id, settings);
                    } else {
                        await addDocument('settings', settings);
                    }
                } else {
                    showMessageBox('Error', 'Please enter valid numeric values.');
                }
            });

            // Категории материалов
            document.getElementById('add-category-btn').addEventListener('click', () => {
                const newCategoryInput = document.getElementById('new-category-input');
                const newCategory = newCategoryInput.value.trim();
                if (newCategory && !settings.materialCategories.includes(newCategory)) {
                    settings.materialCategories.push(newCategory);
                    newCategoryInput.value = '';
                    renderSettings(); // Повторный рендеринг для обновления списка
                } else if (settings.materialCategories.includes(newCategory)) {
                    showMessageBox('Error', 'This category already exists.');
                }
            });

            document.getElementById('material-categories-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-category-btn') || e.target.closest('.remove-category-btn')) {
                    const index = parseInt(e.target.dataset.index || e.target.closest('.remove-category-btn').dataset.index);
                    settings.materialCategories.splice(index, 1);
                    renderSettings(); // Повторный рендеринг для обновления списка
                }
            });

            document.getElementById('save-categories-btn').addEventListener('click', async () => {
                // Обновляем категории из полей ввода перед сохранением
                const updatedCategories = Array.from(document.querySelectorAll('.material-category-input')).map(input => input.value.trim()).filter(Boolean);
                settings.materialCategories = [...new Set(updatedCategories)]; // Удаляем дубликаты
                const { data: existingSettings, error: fetchError } = await supabase.from('settings').select('id').eq('user_id', userId).single();
                if (fetchError && fetchError.code !== 'PGRST116') {
                    console.error("Error fetching existing settings for categories:", fetchError.message);
                    showMessageBox('Error', `Failed to load category settings: ${fetchError.message}`);
                    return;
                }

                if (existingSettings) {
                    await updateDocument('settings', existingSettings.id, settings);
                } else {
                    await addDocument('settings', settings);
                }
            });
        }


        // --- Логика модальных окон ---

        /**
         * Открывает модальное окно для добавления/редактирования записи.
         * @param {object} [appointment=null] - Объект записи для редактирования.
         */
        async function openAppointmentModal(appointment = null) {
            const modal = document.getElementById('appointment-modal');
            const content = document.getElementById('appointment-modal-content');
            const form = document.getElementById('appointment-form');
            const title = document.getElementById('appointment-modal-title');
            const clientPhoneInput = document.getElementById('appointment-client-phone');
            const clientSelect = document.getElementById('appointment-client');
            const clientStatusMessage = document.getElementById('client-status-message');
            const newClientDetails = document.getElementById('new-client-details');
            const newClientNameInput = document.getElementById('new-client-name');
            const newClientEmailInput = document.getElementById('new-client-email');
            const newClientInstagramInput = document.getElementById('new-client-instagram');

            // Сброс формы и скрытие деталей нового клиента
            form.reset();
            newClientDetails.classList.add('hidden');
            clientStatusMessage.textContent = '';
            clientSelect.innerHTML = ''; // Очистка существующих опций

            if (appointment) {
                title.textContent = 'Edit Appointment';
                form.dataset.id = appointment.id;
                const existingClient = clients.find(c => c.id === appointment.clientId);
                if (existingClient) {
                    clientPhoneInput.value = existingClient.phone || '';
                    // Заполнение списка клиентов всеми клиентами и выбор существующего
                    clientSelect.innerHTML = clients.map(client => `<option value="${client.id}">${client.name} (${client.phone || 'no phone'})</option>`).join('');
                    clientSelect.value = existingClient.id;
                    clientSelect.disabled = true; // Отключение выбора, если клиент найден по телефону
                    clientPhoneInput.disabled = true; // Отключение ввода телефона для существующей записи
                    clientStatusMessage.textContent = `Client found: ${existingClient.name}`;
                    clientStatusMessage.classList.remove('text-red-500');
                    clientStatusMessage.classList.add('text-green-500');
                } else {
                    clientPhoneInput.value = ''; // Клиент не найден или не связан
                    clientSelect.innerHTML = clients.map(client => `<option value="${client.id}">${client.name} (${client.phone || 'no phone'})</option>`).join('');
                    clientSelect.disabled = false;
                    clientPhoneInput.disabled = false;
                    clientStatusMessage.textContent = 'Client not found for this appointment. Select or enter new phone.';
                    clientStatusMessage.classList.remove('text-green-500');
                    clientStatusMessage.classList.add('text-red-500');
                }

                document.getElementById('appointment-date').value = appointment.date;
                document.getElementById('appointment-time').value = appointment.time;
                document.getElementById('appointment-duration').value = appointment.duration;
                document.getElementById('appointment-complexity').value = appointment.complexity;
                document.getElementById('appointment-sketch').value = appointment.sketch || '';
            } else {
                title.textContent = 'Create Appointment';
                delete form.dataset.id;
                clientPhoneInput.disabled = false;
                clientSelect.disabled = false;
                // Установка даты по умолчанию на сегодня
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('appointment-date').value = today;

                // Заполнение списка клиентов всеми клиентами
                clientSelect.innerHTML = clients.map(client => `<option value="${client.id}">${client.name} (${client.phone || 'no phone'})</option>`).join('');
                clientSelect.value = ''; // Нет выбора по умолчанию
                clientSelect.prepend(new Option('Select client (optional)', '')); // Добавление опции-заполнителя
            }
            showModal(modal, content);
        }

        /**
         * Настраивает обработчики для модального окна записи.
         */
        function setupAppointmentModal() {
            const modal = document.getElementById('appointment-modal');
            const content = document.getElementById('appointment-modal-content');
            const form = document.getElementById('appointment-form');
            const clientPhoneInput = document.getElementById('appointment-client-phone');
            const clientSelect = document.getElementById('appointment-client');
            const clientStatusMessage = document.getElementById('client-status-message');
            const newClientDetails = document.getElementById('new-client-details');
            const newClientNameInput = document.getElementById('new-client-name');
            const newClientEmailInput = document.getElementById('new-client-email');
            const newClientInstagramInput = document.getElementById('new-client-instagram');

            document.getElementById('cancel-appointment-modal').addEventListener('click', () => {
                hideModal(modal, content);
            });

            // Обработка потери фокуса поля телефона для проверки существующего клиента
            clientPhoneInput.addEventListener('blur', () => {
                const phoneNumber = clientPhoneInput.value.trim();
                if (phoneNumber) {
                    const existingClient = clients.find(c => c.phone === phoneNumber);
                    if (existingClient) {
                        clientSelect.value = existingClient.id;
                        clientSelect.disabled = true;
                        newClientDetails.classList.add('hidden');
                        newClientNameInput.required = false; // Не требуется, если клиент существует
                        clientStatusMessage.textContent = `Client found: ${existingClient.name}`;
                        clientStatusMessage.classList.remove('text-red-500');
                        clientStatusMessage.classList.add('text-green-500');
                    } else {
                        clientSelect.value = ''; // Очистка выбора, если клиент не найден
                        clientSelect.disabled = false; // Включение выбора для нового клиента
                        newClientDetails.classList.remove('hidden');
                        newClientNameInput.required = true; // Сделать имя обязательным для нового клиента
                        clientStatusMessage.textContent = 'Client not found. Fill in new client details.';
                        clientStatusMessage.classList.remove('text-green-500');
                        clientStatusMessage.classList.add('text-red-500');
                    }
                } else {
                    // Если телефон пуст, разрешить выбор существующего или добавление нового
                    clientSelect.disabled = false;
                    newClientDetails.classList.add('hidden');
                    newClientNameInput.required = false;
                    clientStatusMessage.textContent = 'Enter phone or select existing client.';
                    clientStatusMessage.classList.remove('text-green-500', 'text-red-500');
                }
            });

            // Если клиент выбран вручную, отключить детали нового клиента
            clientSelect.addEventListener('change', () => {
                if (clientSelect.value) {
                    clientPhoneInput.value = clients.find(c => c.id === clientSelect.value)?.phone || '';
                    clientPhoneInput.disabled = true; // Отключение ввода телефона, если клиент выбран
                    newClientDetails.classList.add('hidden');
                    newClientNameInput.required = false;
                    clientStatusMessage.textContent = `Selected client: ${clientSelect.options[clientSelect.selectedIndex].text}`;
                    clientStatusMessage.classList.remove('text-red-500');
                    clientStatusMessage.classList.add('text-green-500');
                } else {
                    clientPhoneInput.disabled = false; // Включение ввода телефона, если клиент не выбран
                    clientPhoneInput.value = '';
                    clientStatusMessage.textContent = 'Enter phone or select existing client.';
                    clientStatusMessage.classList.remove('text-green-500', 'text-red-500');
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                let selectedClientId = clientSelect.value;
                const phoneNumber = clientPhoneInput.value.trim();

                // Если клиент не выбран и номер телефона введен, попытаться найти или создать
                if (!selectedClientId && phoneNumber) {
                    const existingClient = clients.find(c => c.phone === phoneNumber);
                    if (existingClient) {
                        selectedClientId = existingClient.id;
                    } else {
                        // Создать нового клиента, если номер телефона не найден и детали нового клиента видны
                        if (!newClientDetails.classList.contains('hidden')) {
                            const newClientData = {
                                name: newClientNameInput.value.trim(),
                                phone: phoneNumber,
                                email: newClientEmailInput.value.trim(),
                                instagram: newClientInstagramInput.value.trim(),
                                notes: ''
                            };
                            if (!newClientData.name) {
                                showMessageBox('Error', 'New client name is required.');
                                return;
                            }
                            const newClientId = await addDocument('clients', newClientData);
                            if (newClientId) {
                                selectedClientId = newClientId;
                            } else {
                                showMessageBox('Error', 'Failed to add new client.');
                                return;
                            }
                        } else {
                            showMessageBox('Error', 'Please select a client or fill in new client details.');
                            return;
                        }
                    }
                } else if (!selectedClientId && !phoneNumber) {
                    showMessageBox('Error', 'Please enter client phone or select from list.');
                    return;
                }


                const appointmentData = {
                    clientId: selectedClientId,
                    date: document.getElementById('appointment-date').value,
                    time: document.getElementById('appointment-time').value,
                    duration: parseFloat(document.getElementById('appointment-duration').value),
                    complexity: parseInt(document.getElementById('appointment-complexity').value),
                    sketch: document.getElementById('appointment-sketch').value,
                    status: 'pending' // Статус по умолчанию
                };

                const appointmentId = form.dataset.id;
                if (appointmentId) {
                    await updateDocument('appointments', appointmentId, appointmentData);
                } else {
                    await addDocument('appointments', appointmentData);
                }
                hideModal(modal, content);
                renderAppointments(); // Повторный рендеринг списка записей
                renderDashboard(); // Повторный рендеринг главной страницы для обновления предстоящих записей
            });
        }

        /**
         * Вычисляет себестоимость и итоговую цену сеанса.
         * @param {object} currentAppointmentForSession - Текущая запись для расчета.
         */
        function calculateSessionPrice() {
            let costPrice = 0;
            const workTime = parseFloat(document.getElementById('session-work-time').value) || 0;
            const hourlyRate = parseFloat(document.getElementById('session-hourly-rate').value) || 0;
            const complexityMarkup = parseFloat(document.getElementById('session-complexity-markup').value) || 0;
            const discount = parseFloat(document.getElementById('session-discount').value) || 0;

            const consumablesUsed = [];
            document.querySelectorAll('#session-consumables-list > div').forEach(item => {
                const materialId = item.dataset.materialId;
                const quantity = parseFloat(item.querySelector('.consumable-qty').value) || 0;
                const material = materials.find(m => m.id === materialId);
                if (material && quantity > 0) {
                    costPrice += material.pricePerUnit * quantity;
                    consumablesUsed.push({
                        materialId: material.id,
                        name: material.name,
                        quantity: quantity,
                        pricePerUnit: material.pricePerUnit
                    });
                }
            });

            let totalPrice = (workTime * hourlyRate) + costPrice;
            totalPrice += totalPrice * (complexityMarkup / 100); // Применение наценки за сложность
            totalPrice -= totalPrice * (discount / 100); // Применение скидки

            document.getElementById('session-cost-price').textContent = formatCurrency(costPrice);
            document.getElementById('session-total-price').textContent = formatCurrency(totalPrice);

            // Сохранение текущего расчета для оплаты
            currentAppointmentForSession.calculatedPrice = totalPrice;
            currentAppointmentForSession.costPrice = costPrice;
            currentAppointmentForSession.consumablesUsed = consumablesUsed;
        }

        /**
         * Открывает модальное окно калькулятора сеанса.
         * @param {object} appointment - Объект записи.
         */
        async function openSessionCalculatorModal(appointment) {
            currentAppointmentForSession = appointment;
            const modal = document.getElementById('session-calculator-modal');
            const content = document.getElementById('session-calculator-modal-content');
            const form = document.getElementById('session-calculator-form');

            const client = clients.find(c => c.id === appointment.clientId);
            document.getElementById('session-client-info').textContent = `Client: ${client ? client.name : 'Unknown'}`;
            document.getElementById('session-appointment-info').textContent = `Appointment: ${formatDate(appointment.date)} at ${formatTime(appointment.time)}, ${appointment.duration} hours, Complexity: ${appointment.complexity}`;

            document.getElementById('session-sketch-preview').src = appointment.sketch || 'https://placehold.co/150x150/2a2a2a/e0e0e0?text=Sketch';
            document.getElementById('session-sketch-preview').onerror = function() {
                this.src = 'https://placehold.co/150x150/2a2a2a/e0e0e0?text=Sketch';
            };

            document.getElementById('session-work-time').value = appointment.duration;
            document.getElementById('session-hourly-rate').value = settings.hourlyRate;
            // Наценка за сложность: 0% для 1, до 90% для 10 (например, (сложность - 1) * 10)
            const complexityMarkup = (appointment.complexity - 1) * 10;
            document.getElementById('session-complexity-markup').value = complexityMarkup;
            document.getElementById('session-discount').value = 0; // Сброс скидки

            // Очистка предыдущих расходников и пересчет
            document.getElementById('session-consumables-list').innerHTML = '';
            calculateSessionPrice(); // Начальный расчет

            showModal(modal, content);
        }

        /**
         * Настраивает обработчики для модального окна калькулятора сеанса.
         */
        function setupSessionCalculatorModal() {
            const modal = document.getElementById('session-calculator-modal');
            const content = document.getElementById('session-calculator-modal-content');

            document.getElementById('cancel-session-modal').addEventListener('click', () => {
                hideModal(modal, content);
            });

            // Пересчет при изменении ввода
            document.getElementById('session-work-time').addEventListener('input', calculateSessionPrice);
            document.getElementById('session-discount').addEventListener('input', calculateSessionPrice);
            document.getElementById('session-consumables-list').addEventListener('input', (e) => {
                if (e.target.classList.contains('consumable-qty')) {
                    calculateSessionPrice();
                }
            });
            document.getElementById('session-consumables-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-consumable-btn') || e.target.closest('.remove-consumable-btn')) {
                    e.target.closest('.flex.items-center.justify-between').remove();
                    calculateSessionPrice();
                }
            });

            // Логика кнопки "Добавить расходник"
            const addConsumableBtn = document.getElementById('add-consumable-btn');
            const addConsumableDropdown = document.getElementById('add-consumable-dropdown');
            const consumableSearchInput = document.getElementById('consumable-search');
            const consumableSearchResults = document.getElementById('consumable-search-results');

            addConsumableBtn.addEventListener('click', () => {
                addConsumableDropdown.classList.toggle('hidden');
                consumableSearchInput.value = '';
                renderConsumableSearchResults('');
                consumableSearchInput.focus();
            });

            consumableSearchInput.addEventListener('input', (e) => {
                renderConsumableSearchResults(e.target.value);
            });

            function renderConsumableSearchResults(searchTerm) {
                consumableSearchResults.innerHTML = '';
                const filteredMaterials = materials.filter(mat =>
                    mat.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (mat.type && mat.type.toLowerCase().includes(searchTerm.toLowerCase()))
                );

                if (filteredMaterials.length > 0) {
                    filteredMaterials.forEach(mat => {
                        const div = document.createElement('div');
                        div.classList.add('p-2', 'hover:bg-gray-700', 'cursor-pointer', 'rounded-md');
                        div.textContent = `${mat.name} (${formatCurrency(mat.pricePerUnit)}/unit)`;
                        div.dataset.materialId = mat.id;
                        div.addEventListener('click', () => {
                            addConsumableToSession(mat);
                            addConsumableDropdown.classList.add('hidden');
                        });
                        consumableSearchResults.appendChild(div);
                    });
                } else {
                    consumableSearchResults.innerHTML = '<p class="p-2 text-gray-500">No materials found.</p>';
                }
            }

            function addConsumableToSession(material) {
                const consumablesList = document.getElementById('session-consumables-list');
                const existingItem = consumablesList.querySelector(`[data-material-id="${material.id}"]`);

                if (existingItem) {
                    // Если материал уже существует, увеличить количество
                    const qtyInput = existingItem.querySelector('.consumable-qty');
                    qtyInput.value = parseFloat(qtyInput.value) + 1;
                } else {
                    // Добавить новый элемент материала
                    const div = document.createElement('div');
                    div.classList.add('flex', 'items-center', 'justify-between', 'p-2', 'bg-gray-800', 'rounded-lg', 'shadow-sm');
                    div.dataset.materialId = material.id;
                    div.innerHTML = `
                        <span class="text-gray-300">${material.name}</span>
                        <div class="flex items-center space-x-2">
                            <input type="number" value="1" min="0.1" step="0.1" class="w-20 input-field text-center consumable-qty">
                            <span class="text-gray-400">units.</span>
                            <span class="font-semibold text-gray-100 consumable-price">${formatCurrency(material.pricePerUnit)}</span>
                            <button type="button" class="text-red-500 hover:text-red-700 remove-consumable-btn"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                    consumablesList.appendChild(div);
                }
                calculateSessionPrice();
            }

            document.getElementById('pay-session-btn').addEventListener('click', async () => {
                if (!currentAppointmentForSession) {
                    showMessageBox('Error', 'No active session to pay for.');
                    return;
                }

                const paymentMethod = 'cash'; // Заполнитель для выбора способа оплаты (может быть выпадающим списком)
                const saleData = {
                    appointmentId: currentAppointmentForSession.id,
                    clientId: currentAppointmentForSession.clientId,
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toTimeString().split(' ')[0].substring(0, 5),
                    totalPrice: currentAppointmentForSession.calculatedPrice,
                    costPrice: currentAppointmentForSession.costPrice,
                    consumables: currentAppointmentForSession.consumablesUsed,
                    paymentMethod: paymentMethod,
                    notes: `Tattoo session from ${formatDate(currentAppointmentForSession.date)}.`
                };

                // Вычитание расходников из инвентаря
                for (const item of currentAppointmentForSession.consumablesUsed) {
                    const material = materials.find(m => m.id === item.materialId);
                    if (material) {
                        const newQuantity = material.quantity - item.quantity;
                        await updateDocument('materials', material.id, { quantity: newQuantity });
                    }
                }

                const newSaleId = await addDocument('sales', saleData);
                if (newSaleId) {
                    await updateDocument('appointments', currentAppointmentForSession.id, { status: 'completed' });
                }


                hideModal(modal, content);
                renderDashboard();
                renderAppointments();
                renderFinance();
                showMessageBox('Success', `Session successfully paid: ${formatCurrency(saleData.totalPrice)}`);
            });

            document.getElementById('print-receipt-btn').addEventListener('click', () => {
                if (currentAppointmentForSession && currentAppointmentForSession.calculatedPrice) {
                    const client = clients.find(c => c.id === currentAppointmentForSession.clientId);
                    // Создаем фиктивный объект продажи для печати, если он еще не сохранен
                    const dummySale = {
                        orderNumber: 'Preview #', // Заполнитель для несохраненных продаж
                        date: new Date().toISOString().split('T')[0],
                        time: new Date().toTimeString().split(' ')[0].substring(0, 5),
                        clientName: client ? client.name : 'Unknown',
                        totalPrice: currentAppointmentForSession.calculatedPrice,
                        consumables: currentAppointmentForSession.consumablesUsed,
                        workTime: currentAppointmentForSession.duration,
                        hourlyRate: settings.hourlyRate,
                        complexityMarkup: (currentAppointmentForSession.complexity - 1) * 10,
                        discount: parseFloat(document.getElementById('session-discount').value) || 0
                    };
                    generateReceiptImage(dummySale);
                } else {
                    showMessageBox('Information', 'First, calculate the session cost.');
                }
            });
        }

        /**
         * Открывает модальное окно для добавления расхода.
         */
        function openExpenseModal() {
            const modal = document.getElementById('expense-modal');
            const content = document.getElementById('expense-modal-content');
            const form = document.getElementById('expense-form');
            form.reset();
            document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
            showModal(modal, content);
        }

        /**
         * Настраивает обработчики для модального окна расходов.
         */
        function setupExpenseModal() {
            const modal = document.getElementById('expense-modal');
            const content = document.getElementById('expense-modal-content');
            const form = document.getElementById('expense-form');

            document.getElementById('cancel-expense-modal').addEventListener('click', () => {
                hideModal(modal, content);
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const expenseData = {
                    description: document.getElementById('expense-description').value,
                    amount: parseFloat(document.getElementById('expense-amount').value),
                    date: document.getElementById('expense-date').value
                };
                await addDocument('expenses', expenseData);
                hideModal(modal, content);
                renderFinance();
                renderDashboard();
            });
        }

        /**
         * Открывает модальное окно для добавления/редактирования материала.
         * @param {object} [material=null] - Объект материала для редактирования.
         */
        function openMaterialModal(material = null) {
            const modal = document.getElementById('material-modal');
            const content = document.getElementById('material-modal-content');
            const form = document.getElementById('material-form');
            const title = document.getElementById('material-modal-title');

            if (material) {
                title.textContent = 'Edit Material';
                form.dataset.id = material.id;
                document.getElementById('material-name').value = material.name;
                document.getElementById('material-price-unit').value = material.pricePerUnit;
                document.getElementById('material-quantity').value = material.quantity;
                document.getElementById('material-type').value = material.type || '';
                document.getElementById('material-min-stock').value = material.minStock || settings.lowStockThreshold;
            } else {
                title.textContent = 'Add Material';
                delete form.dataset.id;
                form.reset();
                document.getElementById('material-min-stock').value = settings.lowStockThreshold; // По умолчанию из настроек
            }
            showModal(modal, content);
        }

        /**
         * Настраивает обработчики для модального окна материалов.
         */
        function setupMaterialModal() {
            const modal = document.getElementById('material-modal');
            const content = document.getElementById('material-modal-content');
            const form = document.getElementById('material-form');

            document.getElementById('cancel-material-modal').addEventListener('click', () => {
                hideModal(modal, content);
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const materialData = {
                    name: document.getElementById('material-name').value,
                    pricePerUnit: parseFloat(document.getElementById('material-price-unit').value),
                    quantity: parseFloat(document.getElementById('material-quantity').value),
                    type: document.getElementById('material-type').value,
                    minStock: parseFloat(document.getElementById('material-min-stock').value)
                };

                const materialId = form.dataset.id;
                if (materialId) {
                    await updateDocument('materials', materialId, materialData);
                } else {
                    await addDocument('materials', materialData);
                }
                hideModal(modal, content);
                renderInventory();
                renderDashboard(); // Для обновления уведомлений о низком запасе
            });
        }

        /**
         * Открывает модальное окно для добавления/редактирования клиента.
         * @param {object} [client=null] - Объект клиента для редактирования.
         */
        function openClientModal(client = null) {
            const modal = document.getElementById('client-modal');
            const content = document.getElementById('client-modal-content');
            const form = document.getElementById('client-form');
            const title = document.getElementById('client-modal-title');

            if (client) {
                title.textContent = 'Edit Client';
                form.dataset.id = client.id;
                document.getElementById('client-name').value = client.name;
                document.getElementById('client-phone').value = client.phone || '';
                document.getElementById('client-email').value = client.email || '';
                document.getElementById('client-instagram').value = client.instagram || '';
                document.getElementById('client-notes').value = client.notes || '';
            } else {
                title.textContent = 'Add Client';
                delete form.dataset.id;
                form.reset();
            }
            showModal(modal, content);
        }

        /**
         * Настраивает обработчики для модального окна клиентов.
         */
        function setupClientModal() {
            const modal = document.getElementById('client-modal');
            const content = document.getElementById('client-modal-content');
            const form = document.getElementById('client-form');

            document.getElementById('cancel-client-modal').addEventListener('click', () => {
                hideModal(modal, content);
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const clientData = {
                    name: document.getElementById('client-name').value,
                    phone: document.getElementById('client-phone').value,
                    email: document.getElementById('client-email').value,
                    instagram: document.getElementById('client-instagram').value,
                    notes: document.getElementById('client-notes').value
                };

                const clientId = form.dataset.id;
                if (clientId) {
                    await updateDocument('clients', clientId, clientData);
                } else {
                    await addDocument('clients', clientData);
                }
                hideModal(modal, content);
                renderClients();
                // Повторный рендеринг главной страницы/записей, если данные клиента отображаются там
                renderDashboard();
                renderAppointments();
            });
        }

        /**
         * Настраивает обработчики для модального окна сообщений.
         */
        function setupMessageBox() {
            const modal = document.getElementById('message-box-modal');
            const content = document.getElementById('message-box-modal-content');
            document.getElementById('message-box-ok').addEventListener('click', () => {
                hideModal(modal, content);
            });
        }

        /**
         * Генерирует изображение чека на Canvas и предлагает его для скачивания.
         * @param {object} sale - Объект продажи или временный объект для предпросмотра.
         */
        function generateReceiptImage(sale) {
            const canvas = document.getElementById('receipt-canvas');
            const ctx = canvas.getContext('2d');

            const receiptWidth = 580; // Стандартная ширина чека (например, 58 мм * 10 пикс/мм)
            let currentY = 50;
            const lineHeight = 45;
            const marginX = 30;

            // Расчет динамической высоты
            let contentHeight = 0;
            contentHeight += 4 * lineHeight; // Название студии
            contentHeight += 4 * lineHeight; // Номер заказа, Дата, Время
            contentHeight += lineHeight; // Имя клиента
            contentHeight += 50; // Разделитель
            contentHeight += lineHeight; // Заголовок услуги
            contentHeight += lineHeight; // Строка времени работы
            if (sale.consumables && sale.consumables.length > 0) {
                contentHeight += lineHeight * (sale.consumables.length + 1); // Строки расходников + заголовок
            }
            contentHeight += 50; // Разделитель
            contentHeight += 4 * lineHeight; // Общая цена
            contentHeight += 4 * lineHeight; // Сообщение благодарности

            canvas.width = receiptWidth;
            canvas.height = contentHeight + 150; // Добавить отступы

            ctx.fillStyle = '#e0e0e0'; // Темный фон чека
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#1a1a1a'; // Светлый текст

            ctx.font = 'bold 42px Inter';
            ctx.textAlign = 'center';
            ctx.fillText(settings.studioName, receiptWidth / 2, currentY);
            currentY += lineHeight * 4;

            ctx.font = '32px Inter';
            ctx.textAlign = 'left';
            ctx.fillText(`Receipt #: ${sale.orderNumber || 'N/A'}`, marginX, currentY);
            currentY += lineHeight;
            ctx.fillText(`Date: ${formatDate(sale.date)} ${formatTime(sale.time)}`, marginX, currentY);
            currentY += lineHeight;
            ctx.fillText(`Client: ${sale.clientName || clients.find(c => c.id === sale.clientId)?.name || 'Unknown'}`, marginX, currentY);
            currentY += lineHeight * 3;

            // Элементы строки
            ctx.font = 'bold 28px Inter';
            ctx.fillText('Сервіс та матеріали:', marginX, currentY);
            currentY += lineHeight;

            ctx.font = '22px Inter';
            const workTimeCost = sale.workTime * sale.hourlyRate;
            ctx.fillText(`Робота (${sale.workTime} hr х ${formatCurrency(sale.hourlyRate)}): ${formatCurrency(workTimeCost)}`, marginX, currentY);
            currentY += lineHeight;

            if (sale.consumables && sale.consumables.length > 0) {
                sale.consumables.forEach(item => {
                    ctx.fillText(`Матеріали: ${item.name} (${item.quantity} units.): ${formatCurrency(item.pricePerUnit * item.quantity)}`, marginX + 10, currentY);
                    currentY += lineHeight;
                });
            }

            // Сложность и скидка (если применимо)
            if (sale.complexityMarkup > 0) {
                const markupAmount = (workTimeCost + (sale.consumables ? sale.consumables.reduce((sum, c) => sum + (c.pricePerUnit * c.quantity), 0) : 0)) * (sale.complexityMarkup / 100);
                 ctx.fillText(`Важкість (${sale.complexityMarkup}%): ${formatCurrency(markupAmount)}`, marginX, currentY);
                 currentY += lineHeight;
            }
            if (sale.discount > 0) {
                const preDiscountTotal = (workTimeCost + (sale.consumables ? sale.consumables.reduce((sum, c) => sum + (c.pricePerUnit * c.quantity), 0) : 0));
                const discountAmount = preDiscountTotal * (sale.discount / 100);
                ctx.fillText(`Discount (${sale.discount}%): -${formatCurrency(discountAmount)}`, marginX, currentY);
                currentY += lineHeight;
            }


            currentY += 30; // Разделитель

            ctx.font = 'bold 45px Inter';
            ctx.textAlign = 'right';
            ctx.fillText(`Всього: ${formatCurrency(sale.totalPrice)}`, receiptWidth - marginX, currentY);
            currentY += lineHeight * 1.5;

            ctx.font = '22px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('Дякуємо за довіру!', receiptWidth / 2, currentY);
            currentY += lineHeight;
            ctx.fillText('Чекатимо на Вас!!', receiptWidth / 2, currentY);

            // Преобразование в JPG и скачивание
            const dataURL = canvas.toDataURL('image/jpeg', 0.9);
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = `receipt_order_${sale.orderNumber || 'preview'}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        // --- Логика маршрутизации ---

        /**
         * Обрабатывает изменения хэша URL для навигации между страницами.
         */
        function handleRouteChange() {
            const hash = window.location.hash || '#dashboard';
            updateNavLinkActiveState(hash);

            // Скрыть мобильное меню при изменении маршрута
            const mobileNavMenu = document.getElementById('mobile-nav-menu');
            if (mobileNavMenu.classList.contains('open')) {
                mobileNavMenu.classList.remove('open');
            }


            if (!isAuthReady) {
                console.warn('Аутентификация не готова, откладываем рендеринг контента.');
                return;
            }

            switch (hash) {
                case '#dashboard':
                    renderDashboard();
                    break;
                case '#appointments':
                    renderAppointments();
                    break;
                case '#clients':
                    renderClients();
                    break;
                case '#inventory':
                    renderInventory();
                    break;
                case '#finance':
                    renderFinance();
                    break;
                case '#settings':
                    renderSettings();
                    break;
                default:
                    renderDashboard();
                    break;
            }
        }

        // --- Аутентификация Supabase ---
        async function handleSupabaseAuthChange(event, session) {
            const loginModal = document.getElementById('login-modal');
            const loginModalContent = document.getElementById('login-modal-content');
            const signupModal = document.getElementById('signup-modal');
            const signupModalContent = document.getElementById('signup-modal-content');

            if (session) {
                userId = session.user.id;
                console.log("Supabase user logged in:", userId);
                document.getElementById('current-user-id').textContent = userId;

                // Настраиваем слушатели ТОЛЬКО ОДИН РАЗ после первоначальной аутентификации
                if (!isAuthReady) { // Проверяем, были ли слушатели уже настроены
                    isAuthReady = true;

                    await setupSupabaseListener('clients', (data) => {
                        clients = data;
                        handleRouteChange(); // Повторный рендеринг текущей страницы для отражения изменений
                    });
                    await setupSupabaseListener('appointments', (data) => {
                        appointments = data;
                        handleRouteChange();
                    });
                    await setupSupabaseListener('materials', (data) => {
                        materials = data;
                        handleRouteChange();
                    });
                    await setupSupabaseListener('expenses', (data) => {
                        expenses = data;
                        handleRouteChange();
                    });
                    await setupSupabaseListener('sales', (data) => {
                        sales = data;
                        handleRouteChange();
                    });
                    await setupSupabaseListener('settings', async (data) => {
                        if (data.length > 0) {
                            settings = { ...settings, ...data[0] };
                        } else {
                            // Если настроек нет, создать настройки по умолчанию для этого пользователя
                            await addDocument('settings', {
                                hourlyRate: 500,
                                materialCategories: ['Иглы', 'Краска', 'Средства', 'Прочее'],
                                lowStockThreshold: 5,
                                studioName: 'RDNCK.TATTOO'
                            });
                        }
                        handleRouteChange();
                    });

                    // Начальная обработка маршрута после загрузки данных и настройки слушателей
                    handleRouteChange();
                } else {
                    // Если уже аутентифицирован и слушатели настроены, просто повторно рендерим текущий маршрут
                    handleRouteChange();
                }

                hideModal(loginModal, loginModalContent);
                hideModal(signupModal, signupModalContent);

            } else {
                console.log("User not logged in with Supabase.");
                document.getElementById('current-user-id').textContent = 'Not Authenticated';
                userId = null; // Очистить userId
                isAuthReady = false;
                loadContent('<div class="flex items-center justify-center h-full text-gray-500 text-xl">Please log in.</div>');
                showModal(loginModal, loginModalContent); // Показать модальное окно входа, если нет пользователя

                // Очистить все подписки, если пользователь выходит
                for (const channelName in activeSupabaseSubscriptions) {
                    supabase.removeChannel(activeSupabaseSubscriptions[channelName]);
                    delete activeSupabaseSubscriptions[channelName];
                }
            }
        }

        // --- Инициализация ---

        document.addEventListener('DOMContentLoaded', async () => {
            // Настройка слушателей событий модальных окон (они статичны и не зависят от состояния аутентификации или данных)
            setupAppointmentModal();
            setupSessionCalculatorModal();
            setupExpenseModal();
            setupMaterialModal();
            setupClientModal();
            setupMessageBox();

            // Слушатель изменений хэша (это вызовет handleRouteChange, который теперь зависит от уже настроенных слушателей)
            window.addEventListener('hashchange', handleRouteChange);

            // Настройка слушателя аутентификации Supabase. Это будет обрабатывать начальное состояние аутентификации и последующие изменения.
            supabase.auth.onAuthStateChange(handleSupabaseAuthChange);

            // --- Слушатели событий форм аутентификации ---
            const loginModal = document.getElementById('login-modal');
            const loginModalContent = document.getElementById('login-modal-content');
            const signupModal = document.getElementById('signup-modal');
            const signupModalContent = document.getElementById('signup-modal-content');

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                document.getElementById('login-error-message').classList.add('hidden');
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) {
                    document.getElementById('login-error-message').textContent = error.message;
                    document.getElementById('login-error-message').classList.remove('hidden');
                    console.error("Login error:", error.message);
                }
            });

            document.getElementById('signup-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                document.getElementById('signup-error-message').classList.add('hidden');
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const passwordConfirm = document.getElementById('signup-password-confirm').value;

                if (password !== passwordConfirm) {
                    document.getElementById('signup-error-message').textContent = 'Passwords do not match.';
                    document.getElementById('signup-error-message').classList.remove('hidden');
                    return;
                }

                const { data, error } = await supabase.auth.signUp({ email, password });
                if (error) {
                    document.getElementById('signup-error-message').textContent = error.message;
                    document.getElementById('signup-error-message').classList.remove('hidden');
                    console.error("Signup error:", error.message);
                } else {
                    showMessageBox('Success', 'Registration successful! Please check your email for confirmation.');
                    hideModal(signupModal, signupModalContent);
                    showModal(loginModal, loginModalContent);
                }
            });

            document.getElementById('logout-btn').addEventListener('click', async () => {
                const { error } = await supabase.auth.signOut();
                if (error) {
                    console.error("Logout error:", error.message);
                    showMessageBox('Error', `Failed to log out: ${error.message}`);
                } else {
                    showMessageBox('Success', 'You have successfully logged out.');
                }
            });

            // Show/hide login/signup modals
            document.getElementById('show-signup').addEventListener('click', (e) => {
                e.preventDefault();
                hideModal(loginModal, loginModalContent);
                showModal(signupModal, signupModalContent);
            });

            document.getElementById('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                hideModal(signupModal, signupModalContent);
                showModal(loginModal, loginModalContent);
            });

            // Mobile navigation toggle
            const mobileNavToggle = document.getElementById('mobile-nav-toggle');
            const mobileNavMenu = document.getElementById('mobile-nav-menu');
            const appContent = document.getElementById('app-content');

            mobileNavToggle.addEventListener('click', () => {
                mobileNavMenu.classList.toggle('open');
                // Adjust main content margin to push it when sidebar opens
                if (mobileNavMenu.classList.contains('open')) {
                    appContent.classList.remove('md:ml-64');
                    appContent.classList.add('ml-64'); // Push content right
                } else {
                    appContent.classList.remove('ml-64');
                    appContent.classList.add('md:ml-64'); // Reset for desktop
                }
            });

            // Close mobile nav when a link is clicked
            document.querySelectorAll('#mobile-nav-menu .nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (mobileNavMenu.classList.contains('open')) {
                        mobileNavMenu.classList.remove('open');
                        appContent.classList.remove('ml-64');
                        appContent.classList.add('md:ml-64');
                    }
                });
            });
        });
    </script>
</body>
</html>
