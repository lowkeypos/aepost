<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM/POS для Тату-мастера</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
        .container {
            max-width: 100vw; /* Full width for tablet landscape */
            min-height: 100vh; /* Full height */
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex-grow: 1;
            overflow-y: auto; /* Enable scrolling for content if needed */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #a0a0a0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #808080;
        }
        .nav-link.active {
            background-color: #4a5568;
            color: #ffffff;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5); /* Adjust color for visibility */
        }
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        /* Style for custom modal */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            width: 90%;
            max-width: 500px;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <div class="container bg-white shadow-lg rounded-lg overflow-hidden md:flex md:flex-row">
        <nav class="bg-gray-800 text-white p-4 md:w-48 md:min-h-screen flex flex-col justify-start items-center md:items-stretch">
            <h1 class="text-2xl font-bold mb-6 text-center">Тату CRM</h1>
            <ul class="flex flex-row md:flex-col space-x-4 md:space-x-0 md:space-y-2 w-full justify-center md:justify-start">
                <li><a href="#dashboard" class="nav-link block p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">Панель</a></li>
                <li><a href="#appointments" class="nav-link block p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">Записи</a></li>
                <li><a href="#clients" class="nav-link block p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">Клиенты</a></li>
                <li><a href="#inventory" class="nav-link block p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">Инвентарь</a></li>
                <li><a href="#finance" class="nav-link block p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">Финансы</a></li>
                <li><a href="#settings" class="nav-link block p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">Настройки</a></li>
            </ul>
        </nav>

        <main id="app-content" class="main-content p-6 flex-1">
            <div class="flex justify-center items-center h-full">
                <div class="spinner" id="loading-spinner"></div>
            </div>
        </main>
    </div>

    <div id="custom-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="modal-close-button">&times;</span>
            <h3 id="modal-title" class="text-xl font-semibold mb-4"></h3>
            <p id="modal-message" class="mb-6"></p>
            <div id="modal-actions" class="flex justify-end space-x-3">
                </div>
        </div>
    </div>

    <script>
    const SUPABASE_CONFIG = {
    url: 'https://iedrcmbvegttznaxpevd.supabase.co',
    key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllZHJjbWJ2ZWd0dHpuYXhwZXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc0MDQyMzEsImV4cCI6MjA2Mjk4MDIzMX0.5K7nHzHI10tXQRP1ha8iH1CD-gjTtpzFSQSRIPofj1A'
};
        // Исправлено: Supabase.createClient на supabase.createClient
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global state variables
        let appState = {
            hourlyRate: 0,
            materialCategories: [],
            materials: [],
            clients: [],
            appointments: [],
            expenses: [],
            sessions: [],
            isDataLoaded: false
        };

        // Utility function to show custom modal
        function showModal(title, message, type = 'alert', onConfirm = null) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalActions = document.getElementById('modal-actions');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalActions.innerHTML = ''; // Clear previous buttons

            if (type === 'alert') {
                const okButton = document.createElement('button');
                okButton.textContent = 'ОК';
                okButton.className = 'px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors';
                okButton.onclick = () => modal.classList.add('hidden');
                modalActions.appendChild(okButton);
            } else if (type === 'confirm') {
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Отмена';
                cancelButton.className = 'px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors';
                cancelButton.onclick = () => modal.classList.add('hidden');

                const confirmButton = document.createElement('button');
                confirmButton.textContent = 'Подтвердить';
                confirmButton.className = 'px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors';
                confirmButton.onclick = () => {
                    if (onConfirm) onConfirm();
                    modal.classList.add('hidden');
                };
                modalActions.appendChild(cancelButton);
                modalActions.appendChild(confirmButton);
            }
            modal.classList.remove('hidden');
        }

        // Close modal button
        document.getElementById('modal-close-button').onclick = () => {
            document.getElementById('custom-modal').classList.add('hidden');
        };

        // Helper to format currency
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('uk-UA', { style: 'currency', currency: 'UAH' }).format(amount);
        };

        // Helper to format date
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('uk-UA');
        };

        // Helper to format time
        const formatTime = (timeString) => {
            if (!timeString) return '';
            // Assuming timeString is in HH:MM:SS format from Supabase
            const [hours, minutes] = timeString.split(':');
            return `${hours}:${minutes}`;
        };

        // --- Data Fetching and Realtime Subscriptions ---
        async function fetchData() {
            document.getElementById('loading-spinner').classList.remove('hidden');
            try {
                const { data: settingsData, error: settingsError } = await supabase.from('settings').select('*').limit(1);
                if (settingsError) throw settingsError;
                if (settingsData.length > 0) {
                    appState.hourlyRate = settingsData[0].hourly_rate || 0;
                    appState.materialCategories = settingsData[0].material_categories || [];
                } else {
                    // Initialize default settings if none exist
                    await supabase.from('settings').insert([{ hourly_rate: 500, material_categories: ['Краски', 'Иглы', 'Средства гигиены', 'Другое'] }]);
                    appState.hourlyRate = 500;
                    appState.materialCategories = ['Краски', 'Иглы', 'Средства гигиены', 'Другое'];
                }

                const { data: materials, error: materialsError } = await supabase.from('materials').select('*');
                if (materialsError) throw materialsError;
                appState.materials = materials;

                const { data: clients, error: clientsError } = await supabase.from('clients').select('*');
                if (clientsError) throw clientsError;
                appState.clients = clients;

                const { data: appointments, error: appointmentsError } = await supabase.from('appointments').select('*, clients(*)'); // Fetch client details
                if (appointmentsError) throw appointmentsError;
                appState.appointments = appointments;

                const { data: expenses, error: expensesError } = await supabase.from('expenses').select('*');
                if (expensesError) throw expensesError;
                appState.expenses = expenses;

                const { data: sessions, error: sessionsError } = await supabase.from('sessions').select('*');
                if (sessionsError) throw sessionsError;
                appState.sessions = sessions;

                appState.isDataLoaded = true;
                document.getElementById('loading-spinner').classList.add('hidden');
                handleRouteChange(); // Render content after data is loaded
            } catch (error) {
                console.error('Ошибка загрузки данных:', error.message);
                showModal('Ошибка', `Не удалось загрузить данные: ${error.message}. Пожалуйста, проверьте подключение к Supabase и настройки таблиц.`, 'alert');
                document.getElementById('loading-spinner').classList.add('hidden');
            }
        }

        // Realtime subscriptions
        function setupRealtimeSubscriptions() {
            supabase.channel('public:materials')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'materials' }, payload => {
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();

            supabase.channel('public:clients')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'clients' }, payload => {
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();

            supabase.channel('public:appointments')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'appointments' }, payload => {
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();

            supabase.channel('public:expenses')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'expenses' }, payload => {
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();

            supabase.channel('public:sessions')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'sessions' }, payload => {
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();

            supabase.channel('public:settings')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'settings' }, payload => {
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();
        }

        async function fetchDataAndRerenderCurrentPage() {
            await fetchData(); // Re-fetch all data
            handleRouteChange(); // Re-render the current view
        }

        // --- Routing ---
        const routes = {
            'dashboard': renderDashboard,
            'appointments': renderAppointments,
            'clients': renderClients,
            'inventory': renderInventory,
            'finance': renderFinance,
            'settings': renderSettings,
            'session': renderSessionCalculator // This will handle /session/[id]
        };

        function handleRouteChange() {
            const path = window.location.hash.substring(1);
            const appContent = document.getElementById('app-content');
            appContent.innerHTML = ''; // Clear content

            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            const [basePath, id] = path.split('/');

            if (routes[basePath]) {
                routes[basePath](id); // Pass ID if available
                // Add active class to current nav link
                const activeLink = document.querySelector(`.nav-link[href="#${basePath}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
            } else {
                // Default to dashboard if path is not found or empty
                window.location.hash = '#dashboard';
                renderDashboard();
                document.querySelector('.nav-link[href="#dashboard"]').classList.add('active');
            }
        }

        // --- Module Rendering Functions ---

        // 1. Dashboard Module
        function renderDashboard() {
            const appContent = document.getElementById('app-content');
            appContent.innerHTML = `
                <div class="p-4 md:p-8 bg-white rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Панель управления</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="bg-blue-100 p-5 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-blue-800 mb-2">Предстоящие визиты</h3>
                            <p class="text-3xl font-bold text-blue-900">${appState.appointments.filter(a => a.status === 'pending' || a.status === 'confirmed').length}</p>
                        </div>
                        <div class="bg-green-100 p-5 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-green-800 mb-2">Выручка за месяц</h3>
                            <p class="text-3xl font-bold text-green-900" id="monthly-revenue">${formatCurrency(calculateMonthlyRevenue())}</p>
                        </div>
                        <div class="bg-yellow-100 p-5 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-yellow-800 mb-2">Низкий остаток материалов</h3>
                            <p class="text-3xl font-bold text-yellow-900">${appState.materials.filter(m => m.stock <= m.low_stock_threshold).length}</p>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-800">Последние записи</h3>
                        <div id="latest-appointments-list" class="overflow-x-auto">
                            </div>
                    </div>

                    <div>
                        <h3 class="text-2xl font-semibold mb-4 text-gray-800">Последние расходы</h3>
                        <div id="latest-expenses-list" class="overflow-x-auto">
                            </div>
                    </div>
                </div>
            `;
            renderLatestAppointments();
            renderLatestExpenses();
        }

        function calculateMonthlyRevenue() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            return appState.sessions.reduce((sum, session) => {
                const sessionDate = new Date(session.start_time);
                if (sessionDate.getMonth() === currentMonth && sessionDate.getFullYear() === currentYear) {
                    return sum + session.total_price;
                }
                return sum;
            }, 0);
        }

        function renderLatestAppointments() {
            const listContainer = document.getElementById('latest-appointments-list');
            const latestAppointments = appState.appointments
                .filter(a => a.status === 'pending' || a.status === 'confirmed')
                .sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time))
                .slice(0, 5); // Show top 5

            if (latestAppointments.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-600">Нет предстоящих записей.</p>';
                return;
            }

            listContainer.innerHTML = `
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Дата</th>
                            <th class="py-3 px-6 text-left">Время</th>
                            <th class="py-3 px-6 text-left">Клиент</th>
                            <th class="py-3 px-6 text-left rounded-tr-lg">Статус</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-sm">
                        ${latestAppointments.map(app => `
                            <tr class="border-b border-gray-200 hover:bg-gray-100">
                                <td class="py-3 px-6 text-left whitespace-nowrap">${formatDate(app.date)}</td>
                                <td class="py-3 px-6 text-left">${formatTime(app.time)}</td>
                                <td class="py-3 px-6 text-left">${app.clients ? app.clients.name : 'Неизвестно'}</td>
                                <td class="py-3 px-6 text-left">
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${app.status === 'confirmed' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">
                                        ${app.status === 'pending' ? 'Ожидает' : 'Подтверждено'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderLatestExpenses() {
            const listContainer = document.getElementById('latest-expenses-list');
            const latestExpenses = appState.expenses
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5); // Show top 5

            if (latestExpenses.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-600">Нет недавних расходов.</p>';
                return;
            }

            listContainer.innerHTML = `
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Дата</th>
                            <th class="py-3 px-6 text-left">Описание</th>
                            <th class="py-3 px-6 text-left">Категория</th>
                            <th class="py-3 px-6 text-left rounded-tr-lg">Сумма</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-sm">
                        ${latestExpenses.map(exp => `
                            <tr class="border-b border-gray-200 hover:bg-gray-100">
                                <td class="py-3 px-6 text-left whitespace-nowrap">${formatDate(exp.date)}</td>
                                <td class="py-3 px-6 text-left">${exp.description}</td>
                                <td class="py-3 px-6 text-left">${exp.category}</td>
                                <td class="py-3 px-6 text-left font-semibold text-red-600">${formatCurrency(exp.amount)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }


        // 2. Appointment System
        function renderAppointments() {
            const appContent = document.getElementById('app-content');
            appContent.innerHTML = `
                <div class="p-4 md:p-8 bg-white rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Система записи и подтверждения визита</h2>

                    <button id="add-appointment-btn" class="mb-6 px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                        Добавить новую запись
                    </button>

                    <div id="appointment-form-container" class="hidden bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Создать новую запись</h3>
                        <form id="appointment-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="appointment-client" class="block text-sm font-medium text-gray-700">Клиент</label>
                                <select id="appointment-client" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Выберите клиента</option>
                                    ${appState.clients.map(client => `<option value="${client.id}">${client.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="appointment-date" class="block text-sm font-medium text-gray-700">Дата</label>
                                <input type="date" id="appointment-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="appointment-time" class="block text-sm font-medium text-gray-700">Время</label>
                                <input type="time" id="appointment-time" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="appointment-duration" class="block text-sm font-medium text-gray-700">Предполагаемая длительность (часов)</label>
                                <input type="number" id="appointment-duration" step="0.5" min="0.5" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="appointment-complexity" class="block text-sm font-medium text-gray-700">Сложность (1-10)</label>
                                <input type="number" id="appointment-complexity" min="1" max="10" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="appointment-sketch" class="block text-sm font-medium text-gray-700">Эскиз (URL)</label>
                                <input type="url" id="appointment-sketch" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="http://example.com/sketch.jpg">
                            </div>
                            <div class="md:col-span-2 flex justify-end space-x-3">
                                <button type="button" id="cancel-appointment-form" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors">Отмена</button>
                                <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Сохранить запись</button>
                            </div>
                        </form>
                    </div>

                    <h3 class="text-2xl font-semibold mb-4 text-gray-800">Предстоящие визиты</h3>
                    <div id="upcoming-appointments-list" class="overflow-x-auto">
                        </div>
                </div>
            `;

            document.getElementById('add-appointment-btn').addEventListener('click', () => {
                document.getElementById('appointment-form-container').classList.toggle('hidden');
            });

            document.getElementById('cancel-appointment-form').addEventListener('click', () => {
                document.getElementById('appointment-form-container').classList.add('hidden');
                document.getElementById('appointment-form').reset();
            });

            document.getElementById('appointment-form').addEventListener('submit', handleAddAppointment);
            renderUpcomingAppointments();
        }

        async function handleAddAppointment(event) {
            event.preventDefault();
            const form = event.target;
            const clientId = form['appointment-client'].value;
            const date = form['appointment-date'].value;
            const time = form['appointment-time'].value;
            const duration = parseFloat(form['appointment-duration'].value);
            const complexity = parseInt(form['appointment-complexity'].value);
            const sketchUrl = form['appointment-sketch'].value;

            if (!clientId || !date || !time || isNaN(duration) || isNaN(complexity)) {
                showModal('Ошибка', 'Пожалуйста, заполните все обязательные поля (Клиент, Дата, Время, Длительность, Сложность).', 'alert');
                return;
            }

            try {
                const { data, error } = await supabase.from('appointments').insert([
                    {
                        client_id: clientId,
                        date: date,
                        time: time,
                        duration: duration,
                        complexity: complexity,
                        sketch_url: sketchUrl,
                        status: 'pending'
                    }
                ]);
                if (error) throw error;
                showModal('Успех', 'Запись успешно добавлена!', 'alert');
                form.reset();
                document.getElementById('appointment-form-container').classList.add('hidden');
                fetchDataAndRerenderCurrentPage(); // Re-fetch and re-render
            } catch (error) {
                console.error('Ошибка добавления записи:', error.message);
                showModal('Ошибка', `Не удалось добавить запись: ${error.message}`, 'alert');
            }
        }

        function renderUpcomingAppointments() {
            const listContainer = document.getElementById('upcoming-appointments-list');
            const upcomingAppointments = appState.appointments
                .filter(app => app.status === 'pending' || app.status === 'confirmed')
                .sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));

            if (upcomingAppointments.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-600">Нет предстоящих визитов.</p>';
                return;
            }

            listContainer.innerHTML = `
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Дата</th>
                            <th class="py-3 px-6 text-left">Время</th>
                            <th class="py-3 px-6 text-left">Клиент</th>
                            <th class="py-3 px-6 text-left">Длительность</th>
                            <th class="py-3 px-6 text-left">Сложность</th>
                            <th class="py-3 px-6 text-left">Статус</th>
                            <th class="py-3 px-6 text-center rounded-tr-lg">Действия</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-sm">
                        ${upcomingAppointments.map(app => `
                            <tr class="border-b border-gray-200 hover:bg-gray-100">
                                <td class="py-3 px-6 text-left whitespace-nowrap">${formatDate(app.date)}</td>
                                <td class="py-3 px-6 text-left">${formatTime(app.time)}</td>
                                <td class="py-3 px-6 text-left">${app.clients ? app.clients.name : 'Неизвестно'}</td>
                                <td class="py-3 px-6 text-left">${app.duration} ч</td>
                                <td class="py-3 px-6 text-left">${app.complexity}</td>
                                <td class="py-3 px-6 text-left">
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${app.status === 'confirmed' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">
                                        ${app.status === 'pending' ? 'Ожидает' : 'Подтверждено'}
                                    </span>
                                </td>
                                <td class="py-3 px-6 text-center">
                                    ${app.status === 'pending' ? `
                                        <button data-id="${app.id}" class="confirm-appointment-btn bg-green-500 text-white px-3 py-1 rounded-md text-xs hover:bg-green-600 transition-colors mr-2">Подтвердить</button>
                                        <button data-id="${app.id}" class="cancel-appointment-btn bg-red-500 text-white px-3 py-1 rounded-md text-xs hover:bg-red-600 transition-colors">Отменить</button>
                                    ` : `
                                        <a href="#session/${app.id}" class="bg-purple-500 text-white px-3 py-1 rounded-md text-xs hover:bg-purple-600 transition-colors">Открыть калькулятор</a>
                                    `}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            listContainer.querySelectorAll('.confirm-appointment-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const appointmentId = e.target.dataset.id;
                    showModal('Подтверждение', 'Вы уверены, что хотите подтвердить этот визит? Он будет перенесен в калькулятор сеанса.', 'confirm', async () => {
                        try {
                            const { error } = await supabase.from('appointments').update({ status: 'confirmed' }).eq('id', appointmentId);
                            if (error) throw error;
                            showModal('Успех', 'Визит подтвержден!', 'alert');
                            window.location.hash = `#session/${appointmentId}`; // Redirect to session calculator
                        } catch (error) {
                            console.error('Ошибка подтверждения визита:', error.message);
                            showModal('Ошибка', `Не удалось подтвердить визит: ${error.message}`, 'alert');
                        }
                    });
                });
            });

            listContainer.querySelectorAll('.cancel-appointment-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const appointmentId = e.target.dataset.id;
                    showModal('Отмена визита', 'Вы уверены, что хотите отменить этот визит?', 'confirm', async () => {
                        try {
                            const { error } = await supabase.from('appointments').update({ status: 'cancelled' }).eq('id', appointmentId);
                            if (error) throw error;
                            showModal('Успех', 'Визит отменен.', 'alert');
                            fetchDataAndRerenderCurrentPage(); // Re-fetch and re-render
                        } catch (error) {
                            console.error('Ошибка отмены визита:', error.message);
                            showModal('Ошибка', `Не удалось отменить визит: ${error.message}`, 'alert');
                        }
                    });
                });
            });
        }

        // 3. Tattoo Session Calculator
        async function renderSessionCalculator(appointmentId) {
            const appContent = document.getElementById('app-content');
            const appointment = appState.appointments.find(app => app.id === appointmentId);

            if (!appointment) {
                appContent.innerHTML = `<div class="p-4 bg-red-100 text-red-800 rounded-lg">Визит не найден или не подтвержден.</div>`;
                return;
            }

            const client = appState.clients.find(c => c.id === appointment.client_id);
            const hourlyRate = appState.hourlyRate;

            appContent.innerHTML = `
                <div class="p-4 md:p-8 bg-white rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Калькулятор тату-сеанса</h2>
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Визит клиента: ${client ? client.name : 'Неизвестно'} (${formatDate(appointment.date)} ${formatTime(appointment.time)})</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="space-y-4">
                            <div>
                                <label for="session-start-time" class="block text-sm font-medium text-gray-700">Время начала</label>
                                <input type="datetime-local" id="session-start-time" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="session-end-time" class="block text-sm font-medium text-gray-700">Время окончания</label>
                                <input type="datetime-local" id="session-end-time" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="session-complexity" class="block text-sm font-medium text-gray-700">Сложность (1-10)</label>
                                <input type="number" id="session-complexity" min="1" max="10" value="${appointment.complexity}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="session-discount" class="block text-sm font-medium text-gray-700">Скидка (%)</label>
                                <input type="number" id="session-discount" min="0" max="100" value="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="session-notes" class="block text-sm font-medium text-gray-700">Заметки по сеансу</label>
                                <textarea id="session-notes" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            ${appointment.sketch_url ? `
                                <div class="mt-4">
                                    <h4 class="text-lg font-semibold mb-2">Эскиз:</h4>
                                    <img src="${appointment.sketch_url}" alt="Эскиз тату" class="w-full h-48 object-contain rounded-lg shadow-md border border-gray-200" onerror="this.onerror=null;this.src='https://placehold.co/300x200/cccccc/333333?text=Нет+эскиза';">
                                </div>
                            ` : `<p class="text-gray-600 mt-4">Эскиз не прикреплен.</p>`}
                        </div>

                        <div class="space-y-4">
                            <div>
                                <h4 class="text-lg font-semibold mb-2 text-gray-800">Использованные расходники</h4>
                                <div id="materials-used-list" class="space-y-3">
                                    </div>
                                <button id="add-material-btn" class="mt-3 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                                    Добавить расходник
                                </button>
                            </div>

                            <div class="bg-blue-50 p-5 rounded-lg shadow-inner mt-6">
                                <h4 class="text-xl font-bold mb-3 text-blue-800">Итого:</h4>
                                <p class="text-lg text-blue-700">Время работы: <span id="calculated-work-time">0</span> ч</p>
                                <p class="text-lg text-blue-700">Себестоимость материалов: <span id="calculated-cost-price">${formatCurrency(0)}</span></p>
                                <p class="text-lg text-blue-700">Наценка за сложность: <span id="calculated-complexity-markup">${formatCurrency(0)}</span></p>
                                <p class="text-lg text-blue-700">Стоимость работы: <span id="calculated-work-cost">${formatCurrency(0)}</span></p>
                                <p class="text-2xl font-bold text-blue-900 mt-4">Итоговая цена: <span id="calculated-total-price">${formatCurrency(0)}</span></p>
                            </div>

                            <div class="mt-6">
                                <label for="payment-method" class="block text-sm font-medium text-gray-700">Метод оплаты</label>
                                <select id="payment-method" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="cash">Наличные</option>
                                    <option value="card">Карта</option>
                                    <option value="transfer">Перевод</option>
                                </select>
                            </div>

                            <div class="flex justify-end mt-6 space-x-3">
                                <button id="save-session-btn" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-colors">
                                    Оплата и завершение
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Pre-fill start time with appointment date and time
            const appointmentDateTime = new Date(`${appointment.date}T${appointment.time}`);
            document.getElementById('session-start-time').value = appointmentDateTime.toISOString().slice(0, 16);

            const materialsUsedList = document.getElementById('materials-used-list');
            let usedMaterials = []; // Array to store {material_id, quantity}

            function addMaterialInput(material = null) {
                const materialDiv = document.createElement('div');
                materialDiv.className = 'flex items-center space-x-2';
                materialDiv.innerHTML = `
                    <select class="material-select block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Выберите материал</option>
                        ${appState.materials.map(m => `<option value="${m.id}" data-price="${m.unit_price}" ${material && material.material_id === m.id ? 'selected' : ''}>${m.name} (${formatCurrency(m.unit_price)}/ед.)</option>`).join('')}
                    </select>
                    <input type="number" min="0.01" step="0.01" placeholder="Кол-во" value="${material ? material.quantity : ''}" class="material-quantity w-24 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <button class="remove-material-btn text-red-500 hover:text-red-700 p-2 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                materialsUsedList.appendChild(materialDiv);

                const selectElement = materialDiv.querySelector('.material-select');
                const quantityElement = materialDiv.querySelector('.material-quantity');

                selectElement.addEventListener('change', calculateSessionPrice);
                quantityElement.addEventListener('input', calculateSessionPrice);
                materialDiv.querySelector('.remove-material-btn').addEventListener('click', () => {
                    materialsUsedList.removeChild(materialDiv);
                    calculateSessionPrice();
                });
            }

            document.getElementById('add-material-btn').addEventListener('click', () => addMaterialInput());

            // Load existing materials if session was already calculated (e.g., editing a completed session)
            const existingSession = appState.sessions.find(s => s.appointment_id === appointmentId);
            if (existingSession && existingSession.materials_used) {
                try {
                    const parsedMaterials = JSON.parse(existingSession.materials_used);
                    parsedMaterials.forEach(mat => addMaterialInput(mat));
                    document.getElementById('session-start-time').value = new Date(existingSession.start_time).toISOString().slice(0, 16);
                    document.getElementById('session-end-time').value = new Date(existingSession.end_time).toISOString().slice(0, 16);
                    document.getElementById('session-complexity').value = existingSession.complexity_score;
                    document.getElementById('session-discount').value = existingSession.discount;
                    document.getElementById('payment-method').value = existingSession.payment_method;
                    document.getElementById('session-notes').value = existingSession.notes || '';
                } catch (e) {
                    console.error("Error parsing materials_used:", e);
                }
            } else {
                // Add one empty material input by default for new sessions
                addMaterialInput();
            }


            // Event listeners for calculations
            document.getElementById('session-start-time').addEventListener('input', calculateSessionPrice);
            document.getElementById('session-end-time').addEventListener('input', calculateSessionPrice);
            document.getElementById('session-complexity').addEventListener('input', calculateSessionPrice);
            document.getElementById('session-discount').addEventListener('input', calculateSessionPrice);

            // Initial calculation
            calculateSessionPrice();

            document.getElementById('save-session-btn').addEventListener('click', async () => {
                const startTime = document.getElementById('session-start-time').value;
                const endTime = document.getElementById('session-end-time').value;
                const complexity = parseInt(document.getElementById('session-complexity').value);
                const discount = parseFloat(document.getElementById('session-discount').value);
                const paymentMethod = document.getElementById('payment-method').value;
                const notes = document.getElementById('session-notes').value;

                if (!startTime || !endTime || isNaN(complexity) || isNaN(discount)) {
                    showModal('Ошибка', 'Пожалуйста, заполните все поля времени, сложности и скидки.', 'alert');
                    return;
                }

                const start = new Date(startTime);
                const end = new Date(endTime);

                if (end <= start) {
                    showModal('Ошибка', 'Время окончания должно быть позже времени начала.', 'alert');
                    return;
                }

                const { totalWorkTime, costPriceMaterials, complexityMarkup, workCost, finalPrice } = calculateSessionPrice(true);

                const materialsUsed = Array.from(materialsUsedList.children).map(div => {
                    const select = div.querySelector('.material-select');
                    const quantity = div.querySelector('.material-quantity');
                    return {
                        material_id: select.value,
                        quantity: parseFloat(quantity.value)
                    };
                }).filter(m => m.material_id && m.quantity > 0); // Filter out empty or zero quantity materials

                // Check for duplicate materials
                const materialCounts = {};
                for (const mat of materialsUsed) {
                    materialCounts[mat.material_id] = (materialCounts[mat.material_id] || 0) + 1;
                    if (materialCounts[mat.material_id] > 1) {
                        showModal('Ошибка', 'Обнаружены дубликаты материалов. Пожалуйста, объедините их или удалите лишние.', 'alert');
                        return;
                    }
                }

                showModal('Подтверждение оплаты', `Итого к оплате: ${formatCurrency(finalPrice)}. Подтвердить?`, 'confirm', async () => {
                    try {
                        let sessionId = existingSession ? existingSession.id : null;
                        let sessionData = {
                            appointment_id: appointmentId,
                            start_time: startTime,
                            end_time: endTime,
                            hourly_rate_used: hourlyRate,
                            complexity_score: complexity,
                            materials_used: JSON.stringify(materialsUsed), // Store as JSON string
                            total_price: finalPrice,
                            cost_price: costPriceMaterials,
                            discount: discount,
                            payment_method: paymentMethod,
                            notes: notes
                        };

                        if (sessionId) {
                            // Update existing session
                            const { error: updateError } = await supabase.from('sessions').update(sessionData).eq('id', sessionId);
                            if (updateError) throw updateError;
                        } else {
                            // Insert new session
                            const { data: newSession, error: insertError } = await supabase.from('sessions').insert([sessionData]).select();
                            if (insertError) throw insertError;
                            sessionId = newSession[0].id;
                            // Link session to appointment
                            const { error: appUpdateError } = await supabase.from('appointments').update({ status: 'completed', session_id: sessionId }).eq('id', appointmentId);
                            if (appUpdateError) throw appUpdateError;
                        }

                        // Deduct materials from inventory and record movements
                        for (const item of materialsUsed) {
                            const material = appState.materials.find(m => m.id === item.material_id);
                            if (material) {
                                const newStock = material.stock - item.quantity;
                                await supabase.from('materials').update({ stock: newStock }).eq('id', item.material_id);
                                await supabase.from('material_movements').insert([
                                    {
                                        material_id: item.material_id,
                                        type: 'out',
                                        quantity: item.quantity,
                                        source_target: `session_${sessionId}`
                                    }
                                ]);
                            }
                        }

                        showModal('Успех', 'Сеанс успешно сохранен и оплачен!', 'alert');
                        fetchDataAndRerenderCurrentPage(); // Re-fetch and re-render
                        window.location.hash = '#appointments'; // Go back to appointments
                    } catch (error) {
                        console.error('Ошибка сохранения сеанса:', error.message);
                        showModal('Ошибка', `Не удалось сохранить сеанс: ${error.message}`, 'alert');
                    }
                });
            });

            function calculateSessionPrice(returnValues = false) {
                const startTime = document.getElementById('session-start-time').value;
                const endTime = document.getElementById('session-end-time').value;
                const complexity = parseInt(document.getElementById('session-complexity').value);
                const discount = parseFloat(document.getElementById('session-discount').value);

                let totalWorkTime = 0;
                if (startTime && endTime) {
                    const start = new Date(startTime);
                    const end = new Date(endTime);
                    if (end > start) {
                        totalWorkTime = (end - start) / (1000 * 60 * 60); // in hours
                    }
                }

                let costPriceMaterials = 0;
                const materialInputs = materialsUsedList.querySelectorAll('.material-select');
                const quantityInputs = materialsUsedList.querySelectorAll('.material-quantity');

                for (let i = 0; i < materialInputs.length; i++) {
                    const materialId = materialInputs[i].value;
                    const quantity = parseFloat(quantityInputs[i].value);
                    if (materialId && !isNaN(quantity) && quantity > 0) {
                        const material = appState.materials.find(m => m.id === materialId);
                        if (material) {
                            costPriceMaterials += material.unit_price * quantity;
                        }
                    }
                }

                const workCost = totalWorkTime * hourlyRate;
                const complexityMarkup = workCost * (complexity / 100); // Simple markup based on complexity (e.g., 10% for complexity 10)
                const subtotal = workCost + complexityMarkup + costPriceMaterials;
                const finalPrice = subtotal * (1 - (discount / 100));

                document.getElementById('calculated-work-time').textContent = totalWorkTime.toFixed(2);
                document.getElementById('calculated-cost-price').textContent = formatCurrency(costPriceMaterials);
                document.getElementById('calculated-complexity-markup').textContent = formatCurrency(complexityMarkup);
                document.getElementById('calculated-work-cost').textContent = formatCurrency(workCost);
                document.getElementById('calculated-total-price').textContent = formatCurrency(finalPrice);

                if (returnValues) {
                    return { totalWorkTime, costPriceMaterials, complexityMarkup, workCost, finalPrice };
                }
            }
        }


        // 4. Clients Module
        function renderClients() {
            const appContent = document.getElementById('app-content');
            appContent.innerHTML = `
                <div class="p-4 md:p-8 bg-white rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">База клиентов</h2>

                    <button id="add-client-btn" class="mb-6 px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                        Добавить нового клиента
                    </button>

                    <div id="client-form-container" class="hidden bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Добавить/Редактировать клиента</h3>
                        <form id="client-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="client-id">
                            <div>
                                <label for="client-name" class="block text-sm font-medium text-gray-700">Имя</label>
                                <input type="text" id="client-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="client-contact" class="block text-sm font-medium text-gray-700">Контакты (телефон/email)</label>
                                <input type="text" id="client-contact" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="md:col-span-2">
                                <label for="client-social" class="block text-sm font-medium text-gray-700">Ссылки на соцсети</label>
                                <input type="text" id="client-social" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="https://instagram.com/user">
                            </div>
                            <div class="md:col-span-2">
                                <label for="client-notes" class="block text-sm font-medium text-gray-700">Заметки</label>
                                <textarea id="client-notes" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label for="client-tags" class="block text-sm font-medium text-gray-700">Метки (через запятую)</label>
                                <input type="text" id="client-tags" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Постоянный, Пропускал">
                            </div>
                            <div class="md:col-span-2 flex justify-end space-x-3">
                                <button type="button" id="cancel-client-form" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors">Отмена</button>
                                <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Сохранить клиента</button>
                            </div>
                        </form>
                    </div>

                    <h3 class="text-2xl font-semibold mb-4 text-gray-800">Список клиентов</h3>
                    <div id="clients-list" class="overflow-x-auto">
                        </div>
                </div>
            `;

            document.getElementById('add-client-btn').addEventListener('click', () => {
                document.getElementById('client-form-container').classList.toggle('hidden');
                document.getElementById('client-form').reset();
                document.getElementById('client-id').value = ''; // Clear ID for new client
            });

            document.getElementById('cancel-client-form').addEventListener('click', () => {
                document.getElementById('client-form-container').classList.add('hidden');
                document.getElementById('client-form').reset();
            });

            document.getElementById('client-form').addEventListener('submit', handleAddEditClient);
            renderClientList();
        }

        async function handleAddEditClient(event) {
            event.preventDefault();
            const form = event.target;
            const clientId = form['client-id'].value;
            const name = form['client-name'].value;
            const contact = form['client-contact'].value;
            const socialLinks = form['client-social'].value;
            const notes = form['client-notes'].value;
            const tags = form['client-tags'].value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');

            if (!name || !contact) {
                showModal('Ошибка', 'Имя и контакты клиента обязательны.', 'alert');
                return;
            }

            try {
                if (clientId) {
                    // Update existing client
                    const { error } = await supabase.from('clients').update({ name, contact, social_links: socialLinks, notes, tags }).eq('id', clientId);
                    if (error) throw error;
                    showModal('Успех', 'Данные клиента успешно обновлены!', 'alert');
                } else {
                    // Add new client
                    const { error } = await supabase.from('clients').insert([{ name, contact, social_links: socialLinks, notes, tags }]);
                    if (error) throw error;
                    showModal('Успех', 'Новый клиент успешно добавлен!', 'alert');
                }
                form.reset();
                document.getElementById('client-form-container').classList.add('hidden');
                fetchDataAndRerenderCurrentPage();
            } catch (error) {
                console.error('Ошибка сохранения клиента:', error.message);
                showModal('Ошибка', `Не удалось сохранить клиента: ${error.message}`, 'alert');
            }
        }

        function renderClientList() {
            const listContainer = document.getElementById('clients-list');
            if (appState.clients.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-600">Нет зарегистрированных клиентов.</p>';
                return;
            }

            listContainer.innerHTML = `
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Имя</th>
                            <th class="py-3 px-6 text-left">Контакты</th>
                            <th class="py-3 px-6 text-left">Соцсети</th>
                            <th class="py-3 px-6 text-left">Метки</th>
                            <th class="py-3 px-6 text-center rounded-tr-lg">Действия</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-sm">
                        ${appState.clients.map(client => `
                            <tr class="border-b border-gray-200 hover:bg-gray-100">
                                <td class="py-3 px-6 text-left font-medium">${client.name}</td>
                                <td class="py-3 px-6 text-left">${client.contact}</td>
                                <td class="py-3 px-6 text-left">
                                    ${client.social_links ? `<a href="${client.social_links}" target="_blank" class="text-blue-500 hover:underline">Ссылка</a>` : 'N/A'}
                                </td>
                                <td class="py-3 px-6 text-left">
                                    ${client.tags && client.tags.length > 0 ? client.tags.map(tag => `<span class="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full mr-1">${tag}</span>`).join('') : 'Нет'}
                                </td>
                                <td class="py-3 px-6 text-center">
                                    <button data-id="${client.id}" class="edit-client-btn bg-yellow-500 text-white px-3 py-1 rounded-md text-xs hover:bg-yellow-600 transition-colors mr-2">Редактировать</button>
                                    <button data-id="${client.id}" class="view-client-history-btn bg-purple-500 text-white px-3 py-1 rounded-md text-xs hover:bg-purple-600 transition-colors mr-2">История</button>
                                    <button data-id="${client.id}" class="delete-client-btn bg-red-500 text-white px-3 py-1 rounded-md text-xs hover:bg-red-600 transition-colors">Удалить</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            listContainer.querySelectorAll('.edit-client-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const clientId = e.target.dataset.id;
                    const client = appState.clients.find(c => c.id === clientId);
                    if (client) {
                        document.getElementById('client-id').value = client.id;
                        document.getElementById('client-name').value = client.name;
                        document.getElementById('client-contact').value = client.contact;
                        document.getElementById('client-social').value = client.social_links || '';
                        document.getElementById('client-notes').value = client.notes || '';
                        document.getElementById('client-tags').value = client.tags ? client.tags.join(', ') : '';
                        document.getElementById('client-form-container').classList.remove('hidden');
                    }
                });
            });

            listContainer.querySelectorAll('.delete-client-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const clientId = e.target.dataset.id;
                    showModal('Удалить клиента', 'Вы уверены, что хотите удалить этого клиента? Все связанные записи и сеансы останутся, но клиент будет удален из базы.', 'confirm', async () => {
                        try {
                            const { error } = await supabase.from('clients').delete().eq('id', clientId);
                            if (error) throw error;
                            showModal('Успех', 'Клиент успешно удален!', 'alert');
                            fetchDataAndRerenderCurrentPage();
                        } catch (error) {
                            console.error('Ошибка удаления клиента:', error.message);
                            showModal('Ошибка', `Не удалось удалить клиента: ${error.message}`, 'alert');
                        }
                    });
                });
            });

            listContainer.querySelectorAll('.view-client-history-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const clientId = e.target.dataset.id;
                    showClientHistoryModal(clientId);
                });
            });
        }

        function showClientHistoryModal(clientId) {
            const client = appState.clients.find(c => c.id === clientId);
            if (!client) {
                showModal('Ошибка', 'Клиент не найден.', 'alert');
                return;
            }

            const clientAppointments = appState.appointments.filter(app => app.client_id === clientId)
                .sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time)); // Latest first

            let historyHtml = '';
            if (clientAppointments.length === 0) {
                historyHtml = '<p class="text-gray-600">У этого клиента нет истории визитов.</p>';
            } else {
                historyHtml = `
                    <div class="overflow-x-auto max-h-96">
                        <table class="min-w-full bg-white rounded-lg shadow-sm text-sm">
                            <thead>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-xs leading-normal">
                                    <th class="py-2 px-4 text-left rounded-tl-lg">Дата</th>
                                    <th class="py-2 px-4 text-left">Время</th>
                                    <th class="py-2 px-4 text-left">Статус</th>
                                    <th class="py-2 px-4 text-left">Цена</th>
                                    <th class="py-2 px-4 text-left">Эскиз</th>
                                    <th class="py-2 px-4 text-left rounded-tr-lg">Заметки</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">
                                ${clientAppointments.map(app => {
                                    const session = appState.sessions.find(s => s.appointment_id === app.id);
                                    return `
                                        <tr class="border-b border-gray-200 hover:bg-gray-100">
                                            <td class="py-2 px-4 whitespace-nowrap">${formatDate(app.date)}</td>
                                            <td class="py-2 px-4">${formatTime(app.time)}</td>
                                            <td class="py-2 px-4">
                                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                                    app.status === 'completed' ? 'bg-green-200 text-green-800' :
                                                    app.status === 'confirmed' ? 'bg-blue-200 text-blue-800' :
                                                    app.status === 'pending' ? 'bg-yellow-200 text-yellow-800' :
                                                    'bg-red-200 text-red-800'
                                                }">
                                                    ${app.status === 'completed' ? 'Завершено' :
                                                      app.status === 'confirmed' ? 'Подтверждено' :
                                                      app.status === 'pending' ? 'Ожидает' :
                                                      'Отменено'}
                                                </span>
                                            </td>
                                            <td class="py-2 px-4 font-semibold">${session ? formatCurrency(session.total_price) : 'N/A'}</td>
                                            <td class="py-2 px-4">
                                                ${app.sketch_url ? `<a href="${app.sketch_url}" target="_blank" class="text-blue-500 hover:underline">Показать</a>` : 'Нет'}
                                            </td>
                                            <td class="py-2 px-4">${session ? (session.notes || 'Нет') : 'Нет'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            showModal(
                `История визитов для ${client.name}`,
                `<div class="mb-4">
                    <p><strong>Контакты:</strong> ${client.contact}</p>
                    <p><strong>Соцсети:</strong> ${client.social_links ? `<a href="${client.social_links}" target="_blank" class="text-blue-500 hover:underline">${client.social_links}</a>` : 'N/A'}</p>
                    <p><strong>Заметки:</strong> ${client.notes || 'Нет'}</p>
                    <p><strong>Метки:</strong> ${client.tags && client.tags.length > 0 ? client.tags.join(', ') : 'Нет'}</p>
                </div>
                <h4 class="text-lg font-semibold mb-2">История сеансов:</h4>
                ${historyHtml}`,
                'alert' // Using alert type, but with rich HTML content
            );
        }


        // 5. Inventory Module
        function renderInventory() {
            const appContent = document.getElementById('app-content');
            appContent.innerHTML = `
                <div class="p-4 md:p-8 bg-white rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Учёт расходников и инвентаризация</h2>

                    <button id="add-material-btn" class="mb-6 px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                        Добавить новый материал
                    </button>

                    <div id="material-form-container" class="hidden bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Добавить/Редактировать материал</h3>
                        <form id="material-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="material-id">
                            <div>
                                <label for="material-name" class="block text-sm font-medium text-gray-700">Название</label>
                                <input type="text" id="material-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="material-price" class="block text-sm font-medium text-gray-700">Цена за единицу (грн)</label>
                                <input type="number" id="material-price" step="0.01" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="material-stock" class="block text-sm font-medium text-gray-700">Остаток</label>
                                <input type="number" id="material-stock" step="0.01" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="material-type" class="block text-sm font-medium text-gray-700">Вид</label>
                                <select id="material-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    ${appState.materialCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="material-low-threshold" class="block text-sm font-medium text-gray-700">Порог низкого остатка</label>
                                <input type="number" id="material-low-threshold" step="0.01" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="md:col-span-2 flex justify-end space-x-3">
                                <button type="button" id="cancel-material-form" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors">Отмена</button>
                                <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Сохранить материал</button>
                            </div>
                        </form>
                    </div>

                    <h3 class="text-2xl font-semibold mb-4 text-gray-800">Список материалов</h3>
                    <div id="materials-list" class="overflow-x-auto mb-8">
                        </div>

                    <h3 class="text-2xl font-semibold mb-4 text-gray-800">История движений материалов</h3>
                    <div id="material-movements-list" class="overflow-x-auto">
                        </div>
                </div>
            `;

            document.getElementById('add-material-btn').addEventListener('click', () => {
                document.getElementById('material-form-container').classList.toggle('hidden');
                document.getElementById('material-form').reset();
                document.getElementById('material-id').value = ''; // Clear ID for new material
            });

            document.getElementById('cancel-material-form').addEventListener('click', () => {
                document.getElementById('material-form-container').classList.add('hidden');
                document.getElementById('material-form').reset();
            });

            document.getElementById('material-form').addEventListener('submit', handleAddEditMaterial);
            renderMaterialsList();
            renderMaterialMovements();
            checkLowStock();
        }

        async function handleAddEditMaterial(event) {
            event.preventDefault();
            const form = event.target;
            const materialId = form['material-id'].value;
            const name = form['material-name'].value;
            const unitPrice = parseFloat(form['material-price'].value);
            const stock = parseFloat(form['material-stock'].value);
            const type = form['material-type'].value;
            const lowStockThreshold = parseFloat(form['material-low-threshold'].value);

            if (!name || isNaN(unitPrice) || isNaN(stock) || !type || isNaN(lowStockThreshold)) {
                showModal('Ошибка', 'Пожалуйста, заполните все обязательные поля.', 'alert');
                return;
            }

            try {
                if (materialId) {
                    // Update existing material
                    const { error } = await supabase.from('materials').update({ name, unit_price: unitPrice, stock, type, low_stock_threshold: lowStockThreshold }).eq('id', materialId);
                    if (error) throw error;
                    showModal('Успех', 'Материал успешно обновлен!', 'alert');
                } else {
                    // Add new material
                    const { error } = await supabase.from('materials').insert([{ name, unit_price: unitPrice, stock, type, low_stock_threshold: lowStockThreshold }]);
                    if (error) throw error;
                    showModal('Успех', 'Новый материал успешно добавлен!', 'alert');
                }
                form.reset();
                document.getElementById('material-form-container').classList.add('hidden');
                fetchDataAndRerenderCurrentPage();
            } catch (error) {
                console.error('Ошибка сохранения материала:', error.message);
                showModal('Ошибка', `Не удалось сохранить материал: ${error.message}`, 'alert');
            }
        }

        function renderMaterialsList() {
            const listContainer = document.getElementById('materials-list');
            if (appState.materials.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-600">Нет зарегистрированных материалов.</p>';
                return;
            }

            listContainer.innerHTML = `
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Название</th>
                            <th class="py-3 px-6 text-left">Цена за ед.</th>
                            <th class="py-3 px-6 text-left">Остаток</th>
                            <th class="py-3 px-6 text-left">Вид</th>
                            <th class="py-3 px-6 text-left">Порог низкого остатка</th>
                            <th class="py-3 px-6 text-center rounded-tr-lg">Действия</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-sm">
                        ${appState.materials.map(material => `
                            <tr class="border-b border-gray-200 hover:bg-gray-100 ${material.stock <= material.low_stock_threshold ? 'bg-red-50' : ''}">
                                <td class="py-3 px-6 text-left font-medium">${material.name}</td>
                                <td class="py-3 px-6 text-left">${formatCurrency(material.unit_price)}</td>
                                <td class="py-3 px-6 text-left">${material.stock}</td>
                                <td class="py-3 px-6 text-left">${material.type}</td>
                                <td class="py-3 px-6 text-left">${material.low_stock_threshold}</td>
                                <td class="py-3 px-6 text-center">
                                    <button data-id="${material.id}" class="edit-material-btn bg-yellow-500 text-white px-3 py-1 rounded-md text-xs hover:bg-yellow-600 transition-colors mr-2">Редактировать</button>
                                    <button data-id="${material.id}" class="delete-material-btn bg-red-500 text-white px-3 py-1 rounded-md text-xs hover:bg-red-600 transition-colors">Удалить</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            listContainer.querySelectorAll('.edit-material-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const materialId = e.target.dataset.id;
                    const material = appState.materials.find(m => m.id === materialId);
                    if (material) {
                        document.getElementById('material-id').value = material.id;
                        document.getElementById('material-name').value = material.name;
                        document.getElementById('material-price').value = material.unit_price;
                        document.getElementById('material-stock').value = material.stock;
                        document.getElementById('material-type').value = material.type;
                        document.getElementById('material-low-threshold').value = material.low_stock_threshold;
                        document.getElementById('material-form-container').classList.remove('hidden');
                    }
                });
            });

            listContainer.querySelectorAll('.delete-material-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const materialId = e.target.dataset.id;
                    showModal('Удалить материал', 'Вы уверены, что хотите удалить этот материал? Это действие необратимо.', 'confirm', async () => {
                        try {
                            const { error } = await supabase.from('materials').delete().eq('id', materialId);
                            if (error) throw error;
                            showModal('Успех', 'Материал успешно удален!', 'alert');
                            fetchDataAndRerenderCurrentPage();
                        } catch (error) {
                            console.error('Ошибка удаления материала:', error.message);
                            showModal('Ошибка', `Не удалось удалить материал: ${error.message}`, 'alert');
                        }
                    });
                });
            });
        }

        async function renderMaterialMovements() {
            const listContainer = document.getElementById('material-movements-list');
            try {
                const { data: movements, error } = await supabase.from('material_movements').select('*, materials(name)').order('date', { ascending: false });
                if (error) throw error;

                if (movements.length === 0) {
                    listContainer.innerHTML = '<p class="text-gray-600">Нет истории движений материалов.</p>';
                    return;
                }

                listContainer.innerHTML = `
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left rounded-tl-lg">Дата</th>
                                <th class="py-3 px-6 text-left">Материал</th>
                                <th class="py-3 px-6 text-left">Тип</th>
                                <th class="py-3 px-6 text-left">Кол-во</th>
                                <th class="py-3 px-6 text-left rounded-tr-lg">Источник/Цель</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700 text-sm">
                            ${movements.map(move => `
                                <tr class="border-b border-gray-200 hover:bg-gray-100">
                                    <td class="py-3 px-6 text-left whitespace-nowrap">${new Date(move.date).toLocaleString('uk-UA')}</td>
                                    <td class="py-3 px-6 text-left">${move.materials ? move.materials.name : 'Неизвестно'}</td>
                                    <td class="py-3 px-6 text-left">
                                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${move.type === 'in' ? 'bg-blue-200 text-blue-800' : 'bg-orange-200 text-orange-800'}">
                                            ${move.type === 'in' ? 'Приход' : 'Расход'}
                                        </span>
                                    </td>
                                    <td class="py-3 px-6 text-left">${move.quantity}</td>
                                    <td class="py-3 px-6 text-left">${move.source_target || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Ошибка загрузки истории движений материалов:', error.message);
                listContainer.innerHTML = `<p class="text-red-600">Ошибка загрузки истории: ${error.message}</p>`;
            }
        }

        function checkLowStock() {
            const lowStockMaterials = appState.materials.filter(m => m.stock <= m.low_stock_threshold);
            if (lowStockMaterials.length > 0) {
                const materialNames = lowStockMaterials.map(m => m.name).join(', ');
                showModal('Низкий остаток материалов', `Следующие материалы имеют низкий остаток: ${materialNames}. Пожалуйста, пополните запасы.`, 'alert');
            }
        }


        // 6. Finance Module
        function renderFinance() {
            const appContent = document.getElementById('app-content');
            appContent.innerHTML = `
                <div class="p-4 md:p-8 bg-white rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Финансовый модуль</h2>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-indigo-100 p-5 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-indigo-800 mb-2">Общая выручка</h3>
                            <p class="text-3xl font-bold text-indigo-900" id="total-revenue">${formatCurrency(calculateTotalRevenue())}</p>
                        </div>
                        <div class="bg-rose-100 p-5 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-rose-800 mb-2">Общие расходы</h3>
                            <p class="text-3xl font-bold text-rose-900" id="total-expenses">${formatCurrency(calculateTotalExpenses())}</p>
                        </div>
                        <div class="bg-teal-100 p-5 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-teal-800 mb-2">Чистая прибыль</h3>
                            <p class="text-3xl font-bold text-teal-900" id="net-profit">${formatCurrency(calculateNetProfit())}</p>
                        </div>
                    </div>

                    <button id="add-expense-btn" class="mb-6 px-6 py-3 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors">
                        Добавить расход
                    </button>

                    <div id="expense-form-container" class="hidden bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Добавить новый расход</h3>
                        <form id="expense-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="expense-date" class="block text-sm font-medium text-gray-700">Дата</label>
                                <input type="date" id="expense-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="expense-amount" class="block text-sm font-medium text-gray-700">Сумма (грн)</label>
                                <input type="number" id="expense-amount" step="0.01" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="md:col-span-2">
                                <label for="expense-description" class="block text-sm font-medium text-gray-700">Описание</label>
                                <input type="text" id="expense-description" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="expense-category" class="block text-sm font-medium text-gray-700">Категория</label>
                                <input type="text" id="expense-category" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Аренда, Реклама, Коммунальные">
                            </div>
                            <div class="md:col-span-2 flex justify-end space-x-3">
                                <button type="button" id="cancel-expense-form" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors">Отмена</button>
                                <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Добавить расход</button>
                            </div>
                        </form>
                    </div>

                    <h3 class="text-2xl font-semibold mb-4 text-gray-800">Таблица доходов и расходов</h3>
                    <div id="finance-table" class="overflow-x-auto mb-8">
                        </div>

                    <h3 class="text-2xl font-semibold mb-4 text-gray-800">Отчёты</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-5 rounded-lg shadow-inner">
                            <h4 class="text-lg font-semibold mb-3">Выручка по месяцам</h4>
                            <div id="monthly-revenue-report"></div>
                        </div>
                        <div class="bg-gray-50 p-5 rounded-lg shadow-inner">
                            <h4 class="text-lg font-semibold mb-3">Выручка по методам оплаты</h4>
                            <div id="payment-method-report"></div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('add-expense-btn').addEventListener('click', () => {
                document.getElementById('expense-form-container').classList.toggle('hidden');
                document.getElementById('expense-form').reset();
            });

            document.getElementById('cancel-expense-form').addEventListener('click', () => {
                document.getElementById('expense-form-container').classList.add('hidden');
                document.getElementById('expense-form').reset();
            });

            document.getElementById('expense-form').addEventListener('submit', handleAddExpense);
            renderFinanceTable();
            renderMonthlyRevenueReport();
            renderPaymentMethodReport();
        }

        function calculateTotalRevenue() {
            return appState.sessions.reduce((sum, session) => sum + session.total_price, 0);
        }

        function calculateTotalExpenses() {
            return appState.expenses.reduce((sum, expense) => sum + expense.amount, 0);
        }

        function calculateNetProfit() {
            return calculateTotalRevenue() - calculateTotalExpenses();
        }

        async function handleAddExpense(event) {
            event.preventDefault();
            const form = event.target;
            const date = form['expense-date'].value;
            const amount = parseFloat(form['expense-amount'].value);
            const description = form['expense-description'].value;
            const category = form['expense-category'].value;

            if (!date || isNaN(amount) || !description || !category) {
                showModal('Ошибка', 'Пожалуйста, заполните все поля расхода.', 'alert');
                return;
            }

            try {
                const { error } = await supabase.from('expenses').insert([{ date, amount, description, category }]);
                if (error) throw error;
                showModal('Успех', 'Расход успешно добавлен!', 'alert');
                form.reset();
                document.getElementById('expense-form-container').classList.add('hidden');
                fetchDataAndRerenderCurrentPage();
            } catch (error) {
                console.error('Ошибка добавления расхода:', error.message);
                showModal('Ошибка', `Не удалось добавить расход: ${error.message}`, 'alert');
            }
        }

        function renderFinanceTable() {
            const tableContainer = document.getElementById('finance-table');
            const combinedData = [];

            appState.sessions.forEach(session => {
                const sessionDate = new Date(session.start_time);
                combinedData.push({
                    type: 'Доход',
                    date: sessionDate.toISOString().split('T')[0],
                    description: `Сеанс (${appState.clients.find(c => c.id === appState.appointments.find(a => a.id === session.appointment_id)?.client_id)?.name || 'Неизвестно'})`,
                    amount: session.total_price,
                    category: 'Тату-сеанс',
                    paymentMethod: session.payment_method
                });
            });

            appState.expenses.forEach(expense => {
                combinedData.push({
                    type: 'Расход',
                    date: expense.date,
                    description: expense.description,
                    amount: expense.amount,
                    category: expense.category,
                    paymentMethod: 'N/A'
                });
            });

            combinedData.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date, newest first

            if (combinedData.length === 0) {
                tableContainer.innerHTML = '<p class="text-gray-600">Нет финансовых операций.</p>';
                return;
            }

            tableContainer.innerHTML = `
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Дата</th>
                            <th class="py-3 px-6 text-left">Тип</th>
                            <th class="py-3 px-6 text-left">Описание</th>
                            <th class="py-3 px-6 text-left">Категория</th>
                            <th class="py-3 px-6 text-left">Метод оплаты</th>
                            <th class="py-3 px-6 text-left rounded-tr-lg">Сумма</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-sm">
                        ${combinedData.map(item => `
                            <tr class="border-b border-gray-200 hover:bg-gray-100">
                                <td class="py-3 px-6 text-left whitespace-nowrap">${formatDate(item.date)}</td>
                                <td class="py-3 px-6 text-left">
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${item.type === 'Доход' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                                        ${item.type}
                                    </span>
                                </td>
                                <td class="py-3 px-6 text-left">${item.description}</td>
                                <td class="py-3 px-6 text-left">${item.category}</td>
                                <td class="py-3 px-6 text-left">${item.paymentMethod === 'cash' ? 'Наличные' : item.paymentMethod === 'card' ? 'Карта' : item.paymentMethod === 'transfer' ? 'Перевод' : item.paymentMethod}</td>
                                <td class="py-3 px-6 text-left font-semibold ${item.type === 'Доход' ? 'text-green-600' : 'text-red-600'}">${formatCurrency(item.amount)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderMonthlyRevenueReport() {
            const reportContainer = document.getElementById('monthly-revenue-report');
            const monthlyData = {};

            appState.sessions.forEach(session => {
                const sessionDate = new Date(session.start_time);
                const monthYear = `${sessionDate.getFullYear()}-${(sessionDate.getMonth() + 1).toString().padStart(2, '0')}`;
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = 0;
                }
                monthlyData[monthYear] += session.total_price;
            });

            const sortedMonths = Object.keys(monthlyData).sort();

            if (sortedMonths.length === 0) {
                reportContainer.innerHTML = '<p class="text-gray-600">Нет данных о выручке по месяцам.</p>';
                return;
            }

            reportContainer.innerHTML = `
                <ul class="list-disc list-inside space-y-1">
                    ${sortedMonths.map(month => `
                        <li>${month}: <span class="font-semibold">${formatCurrency(monthlyData[month])}</span></li>
                    `).join('')}
                </ul>
            `;
        }

        function renderPaymentMethodReport() {
            const reportContainer = document.getElementById('payment-method-report');
            const paymentMethodData = {
                cash: 0,
                card: 0,
                transfer: 0
            };

            appState.sessions.forEach(session => {
                if (paymentMethodData.hasOwnProperty(session.payment_method)) {
                    paymentMethodData[session.payment_method] += session.total_price;
                }
            });

            const totalRevenue = calculateTotalRevenue();

            if (totalRevenue === 0) {
                reportContainer.innerHTML = '<p class="text-gray-600">Нет данных о выручке по методам оплаты.</p>';
                return;
            }

            reportContainer.innerHTML = `
                <ul class="list-disc list-inside space-y-1">
                    <li>Наличные: <span class="font-semibold">${formatCurrency(paymentMethodData.cash)} (${((paymentMethodData.cash / totalRevenue) * 100).toFixed(1)}%)</span></li>
                    <li>Карта: <span class="font-semibold">${formatCurrency(paymentMethodData.card)} (${((paymentMethodData.card / totalRevenue) * 100).toFixed(1)}%)</span></li>
                    <li>Перевод: <span class="font-semibold">${formatCurrency(paymentMethodData.transfer)} (${((paymentMethodData.transfer / totalRevenue) * 100).toFixed(1)}%)</span></li>
                </ul>
            `;
        }


        // 7. Settings Module
        function renderSettings() {
            const appContent = document.getElementById('app-content');
            appContent.innerHTML = `
                <div class="p-4 md:p-8 bg-white rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Настройки</h2>

                    <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Основные настройки</h3>
                        <form id="settings-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="hourly-rate" class="block text-sm font-medium text-gray-700">Ставка за час (грн)</label>
                                <input type="number" id="hourly-rate" step="0.01" min="0" value="${appState.hourlyRate}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="md:col-span-2">
                                <label for="material-categories" class="block text-sm font-medium text-gray-700">Категории материалов (через запятую)</label>
                                <input type="text" id="material-categories" value="${appState.materialCategories.join(', ')}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Краски, Иглы, Средства гигиены">
                            </div>
                            <div class="md:col-span-2 flex justify-end">
                                <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-colors">
                                    Сохранить настройки
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('settings-form').addEventListener('submit', handleSaveSettings);
        }

        async function handleSaveSettings(event) {
            event.preventDefault();
            const form = event.target;
            const hourlyRate = parseFloat(form['hourly-rate'].value);
            const materialCategories = form['material-categories'].value.split(',').map(cat => cat.trim()).filter(cat => cat !== '');

            if (isNaN(hourlyRate) || hourlyRate < 0) {
                showModal('Ошибка', 'Ставка за час должна быть положительным числом.', 'alert');
                return;
            }

            try {
                // Assuming there's only one settings row, update it
                const { data, error } = await supabase.from('settings').update({ hourly_rate: hourlyRate, material_categories: materialCategories }).eq('id', appState.settings && appState.settings.length > 0 ? appState.settings[0].id : null);
                if (error) {
                    // If no settings row exists, insert one
                    if (error.code === 'PGRST116') { // Specific error for no row found on update
                        const { error: insertError } = await supabase.from('settings').insert([{ hourly_rate: hourlyRate, material_categories: materialCategories }]);
                        if (insertError) throw insertError;
                    } else {
                        throw error;
                    }
                }
                showModal('Успех', 'Настройки успешно сохранены!', 'alert');
                fetchDataAndRerenderCurrentPage();
            } catch (error) {
                console.error('Ошибка сохранения настроек:', error.message);
                showModal('Ошибка', `Не удалось сохранить настройки: ${error.message}`, 'alert');
            }
        }


        // Initial load and event listeners
        window.addEventListener('hashchange', handleRouteChange);
        window.addEventListener('load', async () => {
            await fetchData();
            setupRealtimeSubscriptions();
            handleRouteChange(); // Initial route handling after data is loaded
        });
    </script>
</body>
</html>
