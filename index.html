<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM/POS для Тату-мастера</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Темный фон */
            color: #e2e8f0; /* Светлый текст */
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #2d3748; /* Чуть светлее темного */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15); /* Темная тень */
        }
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #4a5568; /* Темный трек */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #718096; /* Темный скролл */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0; /* Светлее при наведении */
        }
        .nav-link.active {
            background-color: #374151; /* Активный пункт навигации */
            color: #ffffff;
        }
        /* Adjust calendar/time picker indicator for dark theme */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(0.8); /* Инвертировать и затемнить для видимости */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2); /* Светлый спиннер */
            border-left-color: #63b3ed; /* Синий цвет */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        /* Style for custom modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* Более темный оверлей */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #2d3748; /* Фон модального окна */
            color: #e2e8f0; /* Текст модального окна */
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem; /* Более округлые углы */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
        }
        .close-button {
            color: #a0aec0; /* Цвет кнопки закрытия */
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #ffffff; /* Светлее при наведении */
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col">
    <div class="container bg-gray-800 shadow-xl rounded-lg overflow-hidden md:flex md:flex-row">
        <nav class="bg-gray-950 text-white p-4 md:w-48 md:min-h-screen flex flex-col justify-start items-center md:items-stretch">
            <h1 class="text-2xl font-bold mb-6 text-center text-blue-300">Tattoo CRM</h1>
            <ul class="flex flex-row md:flex-col space-x-4 md:space-x-0 md:space-y-2 w-full justify-center md:justify-start">
                <li><a href="#dashboard" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">
                    <i class="fas fa-tachometer-alt mr-3"></i>Панель
                </a></li>
                <li><a href="#appointments" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">
                    <i class="fas fa-calendar-alt mr-3"></i>Записи
                </a></li>
                <li><a href="#clients" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">
                    <i class="fas fa-users mr-3"></i>Клиенты
                </a></li>
                <li><a href="#inventory" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">
                    <i class="fas fa-box-open mr-3"></i>Инвентарь
                </a></li>
                <li><a href="#finance" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">
                    <i class="fas fa-dollar-sign mr-3"></i>Финансы
                </a></li>
                <li><a href="#settings" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">
                    <i class="fas fa-cog mr-3"></i>Настройки
                </a></li>
            </ul>
            <div class="mt-auto pt-4 border-t border-gray-700 w-full">
                <a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors text-center md:text-left">
                    <i class="fas fa-sign-out-alt mr-3"></i>Выйти
                </a>
            </div>
        </nav>

        <main class="main-content p-6 flex-1">
            <div class="bg-gray-900 p-4 rounded-lg shadow-md mb-6 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h2 id="page-title" class="text-xl font-semibold text-blue-300">Панель</h2>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input type="text" placeholder="Пошук ..." class="bg-gray-700 text-gray-200 border border-gray-600 rounded-full py-2 px-4 pl-10 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button class="text-gray-400 hover:text-white transition-colors">
                        <i class="fas fa-bell text-xl"></i>
                    </button>
                    <div class="flex items-center space-x-2 bg-gray-700 rounded-full px-3 py-1">
                        <div class="bg-blue-500 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold">TM</div>
                        <span class="text-gray-200">Tattoo Master</span>
                    </div>
                </div>
            </div>

            <div id="dynamic-content-area">
                <div class="flex justify-center items-center h-full" id="initial-loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="custom-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="modal-close-button">&times;</span>
            <h3 id="modal-title" class="text-xl font-semibold mb-4"></h3>
            <p id="modal-message" class="mb-6"></p>
            <div id="modal-actions" class="flex justify-end space-x-3">
                </div>
        </div>
    </div>

    <div id="input-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="input-modal-close-button">&times;</span>
            <h3 id="input-modal-title" class="text-xl font-semibold mb-4"></h3>
            <p id="input-modal-message" class="mb-6"></p>
            <input type="text" id="input-modal-field" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200 mb-4">
            <div id="input-modal-actions" class="flex justify-end space-x-3">
                <button type="button" id="input-modal-cancel-btn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Отмена</button>
                <button type="button" id="input-modal-confirm-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">ОК</button>
            </div>
        </div>
    </div>

    <div id="quick-add-client-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="quick-add-client-modal-close-button">&times;</span>
            <h3 class="text-xl font-semibold mb-4 text-blue-300">Создать нового клиента</h3>
            <form id="quick-client-form" class="grid grid-cols-1 gap-4">
                <div>
                    <label for="quick-client-name" class="block text-sm font-medium text-gray-300">Имя</label>
                    <input type="text" id="quick-client-name" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                </div>
                <div>
                    <label for="quick-client-contact" class="block text-sm font-medium text-gray-300">Контакты (телефон/email)</label>
                    <input type="text" id="quick-client-contact" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                </div>
                <div class="flex justify-end space-x-3 mt-4">
                    <button type="button" id="cancel-quick-client-form" class="px-5 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Отмена</button>
                    <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Сохранить клиента</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Supabase Client Initialization
        var SUPABASE_URL = 'https://iedrcmbvegttznaxpevd.supabase.co';
        // Вставьте ваш Supabase Anon Key здесь. Вы можете найти его в настройках проекта Supabase -> API.
        // Убедитесь, что ваш ключ имеет разрешения на чтение для всех таблиц, используемых в приложении.
        // Также проверьте политики RLS (Row Level Security) в вашей базе данных Supabase.
        // Для начала разработки, вы можете отключить RLS для таблиц 'clients', 'materials', 'appointments', 'expenses', 'sessions', 'settings'
        // или настроить политики, разрешающие SELECT для 'anon' роли.
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllZHJjbWJ2ZWd0dHpuYXhwZXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc0MDQyMzEsImV4cCI6MjA2Mjk4MDIzMX0.5K7nHzHI10tXQRP1ha8iH1CD-gjTtpzFSQSRIPofj1A';

        var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global state variables
        var appState = {
            hourlyRate: 0,
            materialCategories: [],
            expenseCategories: [], // New: Separate array for expense categories
            materials: [],
            clients: [],
            appointments: [],
            expenses: [],
            sessions: [],
            settings: [], // Added to store settings data directly
            isDataLoaded: false
        };

        var pendingAppointmentData = null; // Global variable to store pending appointment data

        // Function to replace String.prototype.padStart
        function customPadStart(str, targetLength, padString) {
            str = String(str);
            padString = String(padString);
            if (str.length >= targetLength) {
                return str;
            }
            targetLength = targetLength - str.length;
            if (targetLength > padString.length) {
                padString += padString.repeat(Math.ceil(targetLength / padString.length)); // Ensure enough padding
            }
            return padString.slice(0, targetLength) + str;
        }

        // Helper to format currency
        var formatCurrency = function(amount) {
            // Intl.NumberFormat is ES2015. For very old iPads, this might fail.
            // A fallback would be manual string formatting if this causes issues.
            try {
                return new Intl.NumberFormat('uk-UA', { style: 'currency', currency: 'UAH' }).format(amount);
            } catch (e) {
                console.warn("Intl.NumberFormat not fully supported, falling back to basic format.");
                return amount.toFixed(2) + ' грн'; // Basic fallback
            }
        };

        // Helper to format date
        var formatDate = function(dateString) {
            if (!dateString) return '';
            var date = new Date(dateString);
            // toLocaleDateString is ES1, generally well-supported, but locale might vary.
            return date.toLocaleDateString('uk-UA');
        };

        // Helper to format time (replacing padStart)
        var formatTime = function(timeString) {
            if (!timeString) return '';
            // Assuming timeString is in HH:MM:SS format from Supabase
            var parts = timeString.split(':');
            var hours = parts[0];
            var minutes = parts[1];
            return customPadStart(hours, 2, '0') + ':' + customPadStart(minutes, 2, '0');
        };

        // Helper to find an element in an array (replacing Array.prototype.find)
        var findInArray = function(array, predicate) {
            for (var i = 0; i < array.length; i++) {
                if (predicate(array[i])) {
                    return array[i];
                }
            }
            return undefined;
        };

        // Helper to filter an array (replacing Array.prototype.filter)
        var filterArray = function(array, predicate) {
            var result = [];
            for (var i = 0; i < array.length; i++) {
                if (predicate(array[i])) {
                    result.push(array[i]);
                }
            }
            return result;
        }
        // Helper to map an array (replacing Array.prototype.map)
        var mapArray = function(array, callback) {
            var result = [];
            for (var i = 0; i < array.length; i++) {
                result.push(callback(array[i], i, array));
            }
            return result;
        };

        // Helper to reduce an array (replacing Array.prototype.reduce)
        var reduceArray = function(array, callback, initialValue) {
            var accumulator = initialValue;
            var startIndex = 0;
            if (arguments.length < 3) {
                if (array.length === 0) {
                    throw new TypeError('Reduce of empty array with no initial value');
                }
                accumulator = array[0];
                startIndex = 1;
            }
            for (var i = startIndex; i < array.length; i++) {
                accumulator = callback(accumulator, array[i], i, array);
            }
            return accumulator;
        };

        // Helper for includes (replacing Array.prototype.includes)
        var arrayIncludes = function(arr, value) {
            for (var i = 0; i < arr.length; i++) {
                if (arr[i] === value) {
                    return true;
                }
            }
            return false;
        };

        // Helper to escape HTML characters for safe display
        var escapeHtml = function(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
                .replace(/`/g, "&#96;"); // Escape backticks too
        };

        // Utility function to show custom modal (alert/confirm)
        var showModal = function(title, message, type, onConfirm) {
            if (type === undefined) type = 'alert';

            var modal = document.getElementById('custom-modal');
            var modalTitle = document.getElementById('modal-title');
            var modalMessage = document.getElementById('modal-message');
            var modalActions = document.getElementById('modal-actions');

            if (modalTitle) modalTitle.textContent = title;
            if (modalMessage) modalMessage.innerHTML = message; // Use innerHTML for rich content
            if (modalActions) modalActions.innerHTML = ''; // Clear previous buttons

            if (type === 'alert') {
                var okButton = document.createElement('button');
                okButton.textContent = 'ОК';
                okButton.className = 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors';
                okButton.onclick = function() { if (modal) modal.classList.add('hidden'); };
                if (modalActions) modalActions.appendChild(okButton);
            } else if (type === 'confirm') {
                var cancelButton = document.createElement('button');
                cancelButton.textContent = 'Отмена';
                cancelButton.className = 'px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors';
                var confirmButton = document.createElement('button');
                confirmButton.textContent = 'Подтвердить';
                confirmButton.className = 'px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors';
                cancelButton.onclick = function() { if (modal) modal.classList.add('hidden'); };
                confirmButton.onclick = function() {
                    if (onConfirm) onConfirm();
                    if (modal) modal.classList.add('hidden');
                };
                if (modalActions) {
                    modalActions.appendChild(cancelButton);
                    modalActions.appendChild(confirmButton);
                }
            }
            if (modal) modal.classList.remove('hidden');
        };

        // Close custom modal button
        var modalCloseButton = document.getElementById('modal-close-button');
        if (modalCloseButton) {
            modalCloseButton.onclick = function() {
                var modal = document.getElementById('custom-modal');
                if (modal) modal.classList.add('hidden');
            };
        }

        // Utility function to show custom input modal
        var showInputModal = function(title, message, defaultValue, onConfirmCallback) {
            var modal = document.getElementById('input-modal');
            var modalTitle = document.getElementById('input-modal-title');
            var modalMessage = document.getElementById('input-modal-message');
            var inputField = document.getElementById('input-modal-field');
            var confirmBtn = document.getElementById('input-modal-confirm-btn');
            var cancelBtn = document.getElementById('input-modal-cancel-btn');
            var closeBtn = document.getElementById('input-modal-close-button');

            if (modalTitle) modalTitle.textContent = title;
            if (modalMessage) modalMessage.textContent = message;
            if (inputField) inputField.value = defaultValue || '';

            var cleanup = function() {
                if (modal) modal.classList.add('hidden');
                confirmBtn.onclick = null;
                cancelBtn.onclick = null;
                closeBtn.onclick = null;
            };

            if (confirmBtn) {
                confirmBtn.onclick = function() {
                    if (onConfirmCallback) onConfirmCallback(inputField ? inputField.value : '');
                    cleanup();
                };
            }
            if (cancelBtn) {
                cancelBtn.onclick = function() {
                    cleanup();
                };
            }
            if (closeBtn) {
                closeBtn.onclick = function() {
                    cleanup();
                };
            }

            if (modal) modal.classList.remove('hidden');
            if (inputField) inputField.focus();
        };

        // New modal function for handling client contact conflicts
        var showConflictModal = function(newClientName, existingClient) {
            var modal = document.getElementById('custom-modal'); // Reusing the custom-modal for flexibility
            var modalTitle = document.getElementById('modal-title');
            var modalMessage = document.getElementById('modal-message');
            var modalActions = document.getElementById('modal-actions');

            if (modalTitle) modalTitle.textContent = 'Конфликт клиента';
            if (modalMessage) modalMessage.innerHTML = `
                <p class="mb-2">Клиент с контактом <strong>${escapeHtml(existingClient.contact)}</strong> уже существует под именем <strong>"${escapeHtml(existingClient.name)}"</strong>.</p>
                <p class="mb-4">Что вы хотите сделать?</p>
            `;
            if (modalActions) modalActions.innerHTML = '';

            var useExistingButton = document.createElement('button');
            useExistingButton.textContent = 'Использовать существующего клиента';
            useExistingButton.className = 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors mr-2';
            useExistingButton.onclick = function() {
                if (modal) modal.classList.add('hidden');
                // Proceed with appointment using existing client's ID
                createAppointment(existingClient.id,
                                  pendingAppointmentData.date,
                                  pendingAppointmentData.time,
                                  pendingAppointmentData.duration,
                                  pendingAppointmentData.complexity,
                                  pendingAppointmentData.sketchUrl);
                pendingAppointmentData = null; // Clear pending data
            };
            if (modalActions) modalActions.appendChild(useExistingButton);

            var updateNameButton = document.createElement('button');
            updateNameButton.textContent = `Обновить имя на "${escapeHtml(newClientName)}"`;
            updateNameButton.className = 'px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition-colors mr-2';
            updateNameButton.onclick = function() {
                if (modal) modal.classList.add('hidden');
                // Update client name in DB, then proceed with appointment
                supabase.from('clients').update({ name: newClientName }).eq('id', existingClient.id)
                    .then(function(response) {
                        if (response.error) throw response.error;
                        showModal('Успех', 'Имя клиента обновлено!', 'alert', function() {
                            fetchData().then(function() { // Re-fetch data to update appState.clients
                                createAppointment(existingClient.id,
                                                  pendingAppointmentData.date,
                                                  pendingAppointmentData.time,
                                                  pendingAppointmentData.duration,
                                                  pendingAppointmentData.complexity,
                                                  pendingAppointmentData.sketchUrl);
                                pendingAppointmentData = null; // Clear pending data
                            });
                        });
                    })
                    .catch(function(error) {
                        console.error('Ошибка обновления имени клиента:', error.message);
                        showModal('Ошибка', 'Не удалось обновить имя клиента: ' + escapeHtml(error.message), 'alert');
                    });
            };
            if (modalActions) modalActions.appendChild(updateNameButton);

            var cancelButton = document.createElement('button');
            cancelButton.textContent = 'Отмена';
            cancelButton.className = 'px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors';
            cancelButton.onclick = function() {
                if (modal) modal.classList.add('hidden');
                pendingAppointmentData = null; // Clear pending data if user cancels
            };
            if (modalActions) modalActions.appendChild(cancelButton);

            if (modal) modal.classList.remove('hidden');
        };


        // --- Data Fetching and Realtime Subscriptions ---
        var fetchData = function() {
            return new Promise(function(resolve, reject) {
                var spinner = document.getElementById('initial-loading-spinner');
                if (spinner) {
                    spinner.classList.remove('hidden'); // Ensure spinner is visible during fetch
                }
                console.log("Starting data fetch...");
                console.log("Supabase URL:", SUPABASE_URL);
                console.log("Supabase Anon Key (first 10 chars):", SUPABASE_ANON_KEY.substring(0, 10));

                supabase.from('settings').select('*').limit(1)
                    .then(function(settingsResponse) {
                        console.log("Settings fetch response:", settingsResponse);
                        if (settingsResponse.error) throw settingsResponse.error;
                        if (settingsResponse.data && settingsResponse.data.length > 0) {
                            appState.settings = settingsResponse.data[0]; // Store the entire settings object
                            appState.hourlyRate = appState.settings.hourly_rate || 0;
                            appState.materialCategories = appState.settings.material_categories || [];
                            appState.expenseCategories = appState.settings.expense_categories || [];
                            console.log("Settings loaded:", appState.hourlyRate, appState.materialCategories, appState.expenseCategories, appState.settings.sms_api_key, appState.settings.sms_sender_name);
                        } else {
                            console.log("No settings found, inserting default settings.");
                            return supabase.from('settings').insert([{
                                    hourly_rate: 500,
                                    material_categories: ['Краски', 'Иглы', 'Средства гигиены', 'Другое'],
                                    expense_categories: ['Аренда', 'Реклама', 'Коммунальные', 'Зарплата'],
                                    sms_api_key: '', // Default empty SMS API key
                                    sms_sender_name: '' // Default empty SMS sender name
                                }]).select() // Select the inserted data to update appState.settings
                                .then(function(insertResponse) {
                                    console.log("Default settings insert response:", insertResponse);
                                    if (insertResponse.error) throw insertResponse.error;
                                    appState.settings = insertResponse.data[0]; // Store the newly inserted settings
                                    appState.hourlyRate = appState.settings.hourly_rate;
                                    appState.materialCategories = appState.settings.material_categories;
                                    appState.expenseCategories = appState.settings.expense_categories;
                                    return {};
                                });
                        }
                        return {};
                    })
                    .then(function() {
                        console.log("Fetching materials...");
                        return supabase.from('materials').select('*');
                    })
                    .then(function(materialsResponse) {
                        console.log("Materials fetch response:", materialsResponse);
                        if (materialsResponse.error) throw materialsResponse.error;
                        appState.materials = materialsResponse.data;
                        console.log("Materials loaded:", appState.materials.length);
                        console.log("Fetching clients...");
                        return supabase.from('clients').select('*');
                    })
                    .then(function(clientsResponse) {
                        console.log("Clients fetch response:", clientsResponse);
                        if (clientsResponse.error) throw clientsResponse.error;
                        appState.clients = clientsResponse.data;
                        console.log("Clients loaded:", appState.clients.length);
                        console.log("Fetching appointments...");
                        return supabase.from('appointments').select('*, clients(*)');
                    })
                    .then(function(appointmentsResponse) {
                        console.log("Appointments fetch response:", appointmentsResponse);
                        if (appointmentsResponse.error) throw appointmentsResponse.error;
                        appState.appointments = appointmentsResponse.data;
                        console.log("Appointments loaded:", appState.appointments.length);
                        console.log("Fetching expenses...");
                        return supabase.from('expenses').select('*');
                    })
                    .then(function(expensesResponse) {
                        console.log("Expenses fetch response:", expensesResponse);
                        if (expensesResponse.error) throw expensesResponse.error;
                        appState.expenses = expensesResponse.data;
                        console.log("Expenses loaded:", appState.expenses.length);
                        console.log("Fetching sessions...");
                        return supabase.from('sessions').select('*');
                    })
                    .then(function(sessionsResponse) {
                        console.log("Sessions fetch response:", sessionsResponse);
                        if (sessionsResponse.error) throw sessionsResponse.error;
                        appState.sessions = sessionsResponse.data;
                        console.log("Sessions loaded:", appState.sessions.length);

                        appState.isDataLoaded = true;
                        if (spinner) {
                            spinner.classList.add('hidden'); // Hide spinner on success
                        }
                        console.log("All data loaded successfully. Current appState:", appState);
                        handleRouteChange(); // Render content after data is loaded
                        resolve();
                    })
                    .catch(function(error) {
                        console.error('Ошибка загрузки данных:', error); // Log full error object
                        showModal('Ошибка', 'Не удалось загрузить данные: ' + escapeHtml(error.message) + '. Пожалуйста, проверьте подключение к Supabase, ваш Anon Key и настройки RLS (Row Level Security) для всех таблиц.', 'alert');
                        if (spinner) {
                            spinner.classList.add('hidden'); // Hide spinner on error
                        }
                        reject(error);
                    });
            });
        };

        var setupRealtimeSubscriptions = function() {
            // Only subscribe if supabase object is valid and key is present
            if (!supabase || !SUPABASE_ANON_KEY) {
                console.warn("Supabase client not fully initialized, skipping realtime subscriptions.");
                return;
            }

            supabase.channel('public:materials')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'materials' }, function(payload) {
                    console.log("Realtime update for materials:", payload);
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();

            supabase.channel('public:clients')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'clients' }, function(payload) {
                    console.log("Realtime update for clients:", payload);
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();

            supabase.channel('public:appointments')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'appointments' }, function(payload) {
                    console.log("Realtime update for appointments:", payload);
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();

            supabase.channel('public:expenses')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'expenses' }, function(payload) {
                    console.log("Realtime update for expenses:", payload);
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();

            supabase.channel('public:sessions')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'sessions' }, function(payload) {
                    console.log("Realtime update for sessions:", payload);
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();

            supabase.channel('public:settings')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'settings' }, function(payload) {
                    console.log("Realtime update for settings:", payload);
                    fetchDataAndRerenderCurrentPage();
                })
                .subscribe();
        };

        var fetchDataAndRerenderCurrentPage = function() {
            return fetchData().then(function() {
                handleRouteChange(); // Re-render the current view
            });
        };

        // --- SMS Integration Function ---
        var sendSms = function(phoneNumber, message) {
            console.log("sendSms: Attempting to send SMS to", phoneNumber);
            var smsApiKey = appState.settings.sms_api_key;
            var smsSenderName = appState.settings.sms_sender_name;

            if (!smsApiKey || !smsSenderName) {
                showModal('Ошибка SMS', 'API-ключ SMS или имя отправителя не настроены в разделе "Настройки".', 'alert');
                console.warn("sendSms: SMS API key or sender name missing.");
                return;
            }
            if (!phoneNumber) {
                showModal('Ошибка SMS', 'Номер телефона для отправки SMS не указан.', 'alert');
                console.warn("sendSms: Phone number is missing.");
                return;
            }
            if (!message) {
                showModal('Ошибка SMS', 'Сообщение SMS не может быть пустым.', 'alert');
                console.warn("sendSms: SMS message is empty.");
                return;
            }

            // --- IMPORTANT: Placeholder for real SMS API call ---
            // In a real application, you would send this request to your own backend server.
            // The backend server would then securely make the call to the SMS provider (e.g., Turbo SMS).
            // This prevents exposing your API key in the client-side code and handles CORS issues.
            // Example of a hypothetical Turbo SMS API endpoint (replace with actual if you have a backend):
            var turboSmsApiUrl = 'https://api.turbosms.ua/message/send'; // This is a hypothetical URL for demonstration

            // For demonstration, we'll just log and show a success message.
            // In a real scenario, you'd use fetch() to send data to your backend.
            console.log(`Simulating SMS send to: ${phoneNumber}, Sender: ${smsSenderName}, Message: "${message}"`);
            console.log(`Using (placeholder) API Key: ${smsApiKey.substring(0, 5)}...`);

            // Simulate network request delay
            setTimeout(function() {
                showModal('SMS отправлено', `Сообщение "${escapeHtml(message)}" отправлено на номер ${escapeHtml(phoneNumber)} от ${escapeHtml(smsSenderName)}. (Имитация)`, 'alert');
                console.log("sendSms: SMS simulation successful.");
            }, 1000);

            /*
            // Example of how a real fetch request might look if you had a backend proxy:
            fetch('/api/send-sms', { // This would be your backend endpoint
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Your backend would handle the actual SMS API key, not here
                },
                body: JSON.stringify({
                    to: phoneNumber,
                    sender: smsSenderName,
                    text: message,
                    // Potentially pass your SMS API key here if your backend expects it,
                    // but ideally the backend retrieves it securely.
                    // apiKey: smsApiKey // DO NOT DO THIS IN CLIENT-SIDE CODE FOR REAL APPS
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || 'Ошибка отправки SMS');
                    });
                }
                return response.json();
            })
            .then(data => {
                showModal('SMS отправлено', `Сообщение успешно отправлено на номер ${escapeHtml(phoneNumber)}.`, 'alert');
                console.log("sendSms: SMS sent successfully:", data);
            })
            .catch(error => {
                showModal('Ошибка SMS', `Не удалось отправить SMS: ${escapeHtml(error.message)}`, 'alert');
                console.error("sendSms: Error sending SMS:", error);
            });
            */
        };


        // --- Module Rendering Functions ---

        // 1. Dashboard Module
        var renderDashboard = function() {
            console.log("renderDashboard: Function started.");
            var dynamicContentArea = document.getElementById('dynamic-content-area');
            if (!dynamicContentArea) {
                console.error("renderDashboard: Dynamic content area not found.");
                return;
            }
            dynamicContentArea.innerHTML = `
                <div class="p-4 md:p-8 bg-gray-700 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-blue-300">Дашборд</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gray-800 p-5 rounded-lg shadow-sm flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300 mb-1">Дохід</h3>
                                <p class="text-3xl font-bold text-green-400">${formatCurrency(calculateTotalRevenue())}</p>
                                <p class="text-sm text-gray-400">+0% з минулого місяця</p>
                            </div>
                            <i class="fas fa-wallet text-4xl text-green-600"></i>
                        </div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-sm flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300 mb-1">Клієнти</h3>
                                <p class="text-3xl font-bold text-blue-400">${escapeHtml(appState.clients.length)}</p>
                                <p class="text-sm text-gray-400">+0 нових</p>
                            </div>
                            <i class="fas fa-users text-4xl text-blue-600"></i>
                        </div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-sm flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300 mb-1">Сеанси</h3>
                                <p class="text-3xl font-bold text-purple-400">${escapeHtml(appState.sessions.length)}</p>
                                <p class="text-sm text-gray-400">${escapeHtml(filterArray(appState.appointments, function(a) { return a.status === 'pending' || a.status === 'confirmed'; }).length)} заплановано</p>
                            </div>
                            <i class="fas fa-calendar-check text-4xl text-purple-600"></i>
                        </div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-sm flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300 mb-1">Матеріали</h3>
                                <p class="text-3xl font-bold text-yellow-400">${escapeHtml(filterArray(appState.materials, function(m) { return m.stock > 0; }).length)}</p>
                                <p class="text-sm text-gray-400">${escapeHtml(filterArray(appState.materials, function(m) { return m.stock <= m.low_stock_threshold; }).length)} закінчується</p>
                            </div>
                            <i class="fas fa-box-open text-4xl text-yellow-600"></i>
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-inner mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-semibold text-blue-300">Дохід за останні 30 днів</h3>
                            <select class="bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-1 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option>30 днів</option>
                                <option>90 днів</option>
                                <option>12 місяців</option>
                            </select>
                        </div>
                        <div class="h-64 bg-gray-900 rounded-md flex items-center justify-center text-gray-500">
                            Графік доходу
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-inner">
                        <h3 class="text-2xl font-semibold mb-4 text-blue-300">Найближчі сеанси</h3>
                        <div id="latest-appointments-list" class="overflow-x-auto">
                            </div>
                    </div>
                </div>
            `;
            renderLatestAppointments();
            console.log("renderDashboard: Function finished.");
        };

        var calculateTotalRevenue = function() {
            return reduceArray(appState.sessions, function(sum, session) { return sum + session.total_price; }, 0);
        };

        var calculateMonthlyRevenue = function() {
            var now = new Date();
            var currentMonth = now.getMonth();
            var currentYear = now.getFullYear();
            return reduceArray(appState.sessions, function(sum, session) {
                var sessionDate = new Date(session.start_time);
                if (sessionDate.getMonth() === currentMonth && sessionDate.getFullYear() === currentYear) {
                    return sum + session.total_price;
                }
                return sum;
            }, 0);
        };

        var renderLatestAppointments = function() {
            console.log("renderLatestAppointments: Function started.");
            var listContainer = document.getElementById('latest-appointments-list');
            if (!listContainer) {
                console.error("renderLatestAppointments: Latest appointments list container not found.");
                return;
            }
            var latestAppointments = filterArray(appState.appointments, function(a) { return a.status === 'pending' || a.status === 'confirmed'; })
                .sort(function(a, b) { return new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time); })
                .slice(0, 5); // Show top 5

            if (latestAppointments.length === 0) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                        <i class="fas fa-calendar-alt text-6xl mb-4"></i>
                        <p class="text-lg">Немає запланованих сеансів</p>
                    </div>
                `;
                console.log("renderLatestAppointments: No upcoming appointments, rendered empty state.");
                return;
            }

            listContainer.innerHTML = `
                <table class="min-w-full bg-gray-800 rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-700 text-gray-300 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Дата</th>
                            <th class="py-3 px-6 text-left">Время</th>
                            <th class="py-3 px-6 text-left">Клиент</th>
                            <th class="py-3 px-6 text-left rounded-tr-lg">Статус</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-200 text-sm">
                        ${mapArray(latestAppointments, function(app) {
                            return `
                                <tr class="border-b border-gray-600 hover:bg-gray-700">
                                    <td class="py-3 px-6 text-left whitespace-nowrap">${formatDate(app.date)}</td>
                                    <td class="py-3 px-6 text-left">${formatTime(app.time)}</td>
                                    <td class="py-3 px-6 text-left">${app.clients ? escapeHtml(app.clients.name) : 'Неизвестно'}</td>
                                    <td class="py-3 px-6 text-left">
                                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${app.status === 'confirmed' ? 'bg-green-700 text-green-100' : 'bg-yellow-700 text-yellow-100'}">
                                            ${app.status === 'pending' ? 'Ожидает' : 'Подтверждено'}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            console.log("renderLatestAppointments: Rendered table with appointments.");
        };

        // 2. Appointment System
        var renderAppointments = function() {
            console.log("renderAppointments: Function started.");
            var dynamicContentArea = document.getElementById('dynamic-content-area');
            if (!dynamicContentArea) {
                console.error("renderAppointments: Dynamic content area not found.");
                return;
            }
            dynamicContentArea.innerHTML = `
                <div class="p-4 md:p-8 bg-gray-700 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-blue-300">Записи</h2>

                    <div class="flex justify-between items-center mb-6">
                        <select class="bg-gray-800 text-gray-200 border border-gray-600 rounded-md py-2 px-4 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option>Усі дати</option>
                            <option>Сьогодні</option>
                            <option>Цей тиждень</option>
                            <option>Цей місяць</option>
                        </select>
                        <button id="add-appointment-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-plus mr-2"></i>Додати запис
                        </button>
                    </div>

                    <div id="appointment-form-container" class="hidden bg-gray-800 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-blue-300">Створити нову запис</h3>
                        <form id="appointment-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="appointment-client-name" class="block text-sm font-medium text-gray-300">Имя клиента</label>
                                <input type="text" id="appointment-client-name" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-200" placeholder="Имя клиента">
                            </div>
                            <div>
                                <label for="appointment-client-contact" class="block text-sm font-medium text-gray-300">Контакты клиента (телефон/email)</label>
                                <input type="text" id="appointment-client-contact" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-200" placeholder="Телефон или email">
                            </div>
                            <div>
                                <label for="appointment-date" class="block text-sm font-medium text-gray-300">Дата</label>
                                <input type="date" id="appointment-date" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-200">
                            </div>
                            <div>
                                <label for="appointment-time" class="block text-sm font-medium text-gray-300">Время</label>
                                <input type="time" id="appointment-time" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-200">
                            </div>
                            <div>
                                <label for="appointment-duration" class="block text-sm font-medium text-gray-300">Предполагаемая длительность (часов)</label>
                                <input type="number" id="appointment-duration" step="0.5" min="0.5" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-200">
                            </div>
                            <div>
                                <label for="appointment-complexity" class="block text-sm font-medium text-gray-300">Сложность (1-10)</label>
                                <input type="number" id="appointment-complexity" min="1" max="10" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-200">
                            </div>
                            <div>
                                <label for="appointment-sketch" class="block text-sm font-medium text-gray-300">Эскиз (URL)</label>
                                <input type="url" id="appointment-sketch" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-200" placeholder="http://example.com/sketch.jpg">
                            </div>
                            <div class="md:col-span-2 flex justify-end space-x-3">
                                <button type="button" id="cancel-appointment-form" class="px-5 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Отмена</button>
                                <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Сохранить запись</button>
                            </div>
                        </form>
                    </div>

                    <h3 class="text-2xl font-semibold mb-4 text-blue-300">Предстоящие визиты</h3>
                    <div id="upcoming-appointments-list" class="overflow-x-auto">
                        </div>
                </div>
            `;

            var addAppointmentBtn = document.getElementById('add-appointment-btn');
            if (addAppointmentBtn) {
                console.log("renderAppointments: Found #add-appointment-btn, attaching listener.");
                addAppointmentBtn.addEventListener('click', function() {
                    console.log("Event: #add-appointment-btn clicked.");
                    var formContainer = document.getElementById('appointment-form-container');
                    if (formContainer) {
                        formContainer.classList.toggle('hidden');
                        console.log("Event: Toggled #appointment-form-container visibility.");
                    }
                });
            } else {
                console.warn("renderAppointments: #add-appointment-btn not found.");
            }

            var cancelAppointmentForm = document.getElementById('cancel-appointment-form');
            if (cancelAppointmentForm) {
                console.log("renderAppointments: Found #cancel-appointment-form, attaching listener.");
                cancelAppointmentForm.addEventListener('click', function() {
                    console.log("Event: #cancel-appointment-form clicked.");
                    var formContainer = document.getElementById('appointment-form-container');
                    var appointmentForm = document.getElementById('appointment-form');
                    if (formContainer) formContainer.classList.add('hidden');
                    if (appointmentForm) appointmentForm.reset();
                    console.log("Event: Appointment form cancelled and hidden.");
                });
            } else {
                console.warn("renderAppointments: #cancel-appointment-form not found.");
            }

            var appointmentForm = document.getElementById('appointment-form');
            if (appointmentForm) {
                console.log("renderAppointments: Found #appointment-form, attaching submit listener.");
                appointmentForm.addEventListener('submit', handleAddAppointment);
            } else {
                console.warn("renderAppointments: #appointment-form not found.");
            }
            renderUpcomingAppointments();
            console.log("renderAppointments: Function finished.");
        };

        function createAppointment(clientId, date, time, duration, complexity, sketchUrl) {
            console.log("createAppointment: Attempting to insert appointment.");
            supabase.from('appointments').insert([
                {
                    client_id: clientId,
                    date: date,
                    time: time,
                    duration: duration,
                    complexity: complexity,
                    sketch_url: sketchUrl,
                    status: 'pending'
                }
            ])
            .then(function(response) {
                console.log("Appointment creation response:", response);
                if (response.error) throw response.error;
                showModal('Успех', 'Запись успешно добавлена!', 'alert');
                var appointmentForm = document.getElementById('appointment-form');
                if (appointmentForm) appointmentForm.reset(); // Reset original form
                var formContainer = document.getElementById('appointment-form-container');
                if (formContainer) formContainer.classList.add('hidden');
                fetchDataAndRerenderCurrentPage(); // Re-fetch and re-render
                console.log("createAppointment: Appointment added and page re-rendered.");
            })
            .catch(function(error) {
                console.error('Ошибка добавления записи:', error.message);
                showModal('Ошибка', 'Не удалось добавить запись: ' + escapeHtml(error.message), 'alert');
            });
        }

        var handleAddAppointment = function(event) {
            console.log("handleAddAppointment: Function started.");
            event.preventDefault();
            var form = event.target;
            var clientNameInput = form['appointment-client-name'];
            var clientContactInput = form['appointment-client-contact'];
            var dateInput = form['appointment-date'];
            var timeInput = form['appointment-time'];
            var durationInput = form['appointment-duration'];
            var complexityInput = form['appointment-complexity'];
            var sketchInput = form['appointment-sketch'];

            var clientName = clientNameInput ? clientNameInput.value.trim() : '';
            var clientContact = clientContactInput ? clientContactInput.value.trim() : '';
            var date = dateInput ? dateInput.value : '';
            var time = timeInput ? timeInput.value : '';
            var duration = durationInput ? parseFloat(durationInput.value) : NaN;
            var complexity = complexityInput ? parseInt(complexityInput.value) : NaN;
            var sketchUrl = sketchInput ? sketchInput.value : '';

            if (!clientName || !clientContact || !date || !time || isNaN(duration) || isNaN(complexity)) {
                console.warn("handleAddAppointment: Missing required fields.");
                showModal('Ошибка', 'Пожалуйста, заполните все обязательные поля (Имя клиента, Контакты, Дата, Время, Длительность, Сложность).', 'alert');
                return;
            }

            // Store pending appointment data globally
            pendingAppointmentData = {
                clientName: clientName,
                clientContact: clientContact,
                date: date,
                time: time,
                duration: duration,
                complexity: complexity,
                sketchUrl: sketchUrl
            };

            // First, check for client by contact (unique identifier)
            supabase.from('clients').select('*').eq('contact', clientContact).limit(1)
                .then(function(response) {
                    console.log("Search client by contact response:", response);
                    if (response.error) throw response.error;

                    var existingClientByContact = response.data && response.data.length > 0 ? response.data[0] : null;

                    if (existingClientByContact) {
                        // Client found by contact
                        if (existingClientByContact.name.toLowerCase() === clientName.toLowerCase()) {
                            // Contact and name match, proceed with appointment for this client
                            console.log("handleAddAppointment: Client found by contact and name match. Creating appointment.");
                            createAppointment(existingClientByContact.id,
                                              pendingAppointmentData.date,
                                              pendingAppointmentData.time,
                                              pendingAppointmentData.duration,
                                              pendingAppointmentData.complexity,
                                              pendingAppointmentData.sketchUrl);
                            pendingAppointmentData = null; // Clear pending data
                        } else {
                            // Contact matches, but name is different. Show conflict modal.
                            console.log("handleAddAppointment: Client found by contact, but name differs. Showing conflict modal.");
                            showConflictModal(clientName, existingClientByContact);
                        }
                    } else {
                        // No client found by contact. Now check by name (less strict, but still useful for new clients).
                        // This step is important if the user enters a new contact for an an existing name.
                        supabase.from('clients').select('*').eq('name', clientName).limit(1)
                            .then(function(nameResponse) {
                                console.log("Search client by name response (after no contact match):", nameResponse);
                                if (nameResponse.error) throw nameResponse.error;

                                var existingClientByName = nameResponse.data && nameResponse.data.length > 0 ? nameResponse.data[0] : null;

                                if (existingClientByName) {
                                    // Client found by name, but not by contact. This means the contact is new for this existing client.
                                    // We should probably update the existing client's contact, or ask the user.
                                    // For simplicity, let's assume if name exists, we update contact and proceed.
                                    // A more robust solution might involve another modal.
                                    showModal('Внимание', 'Клиент с именем "' + escapeHtml(clientName) + '" уже существует, но с другим контактом. Обновить контакт на "' + escapeHtml(clientContact) + '"?', 'confirm', function() {
                                        supabase.from('clients').update({ contact: clientContact }).eq('id', existingClientByName.id)
                                            .then(function(updateResponse) {
                                                if (updateResponse.error) throw updateResponse.error;
                                                showModal('Успех', 'Контакт клиента обновлен!', 'alert', function() {
                                                    fetchData().then(function() { // Re-fetch data to update appState.clients
                                                        createAppointment(existingClientByName.id,
                                                                          pendingAppointmentData.date,
                                                                          pendingAppointmentData.time,
                                                                          pendingAppointmentData.duration,
                                                                          pendingAppointmentData.complexity,
                                                                          pendingAppointmentData.sketchUrl);
                                                        pendingAppointmentData = null;
                                                    });
                                                });
                                            })
                                            .catch(function(error) {
                                                console.error('Ошибка обновления контакта клиента:', error.message);
                                                showModal('Ошибка', 'Не удалось обновить контакт клиента: ' + escapeHtml(error.message), 'alert');
                                            });
                                    });
                                } else {
                                    // No client found by contact or name. This is a truly new client.
                                    console.log("handleAddAppointment: No existing client found by contact or name. Prompting quick add client modal.");
                                    var quickClientNameInput = document.getElementById('quick-client-name');
                                    var quickClientContactInput = document.getElementById('quick-client-contact');
                                    var quickAddClientModal = document.getElementById('quick-add-client-modal');

                                    if (quickClientNameInput) quickClientNameInput.value = escapeHtml(clientName);
                                    if (quickClientContactInput) quickClientContactInput.value = escapeHtml(clientContact);
                                    if (quickAddClientModal) quickAddClientModal.classList.remove('hidden');
                                }
                            })
                            .catch(function(error) {
                                console.error('Ошибка поиска клиента по имени:', error.message);
                                showModal('Ошибка', 'Ошибка при поиске клиента по имени: ' + escapeHtml(error.message), 'alert');
                                pendingAppointmentData = null; // Clear pending data on error
                            });
                    }
                })
                .catch(function(error) {
                    console.error('Ошибка поиска клиента по контакту:', error.message);
                    showModal('Ошибка', 'Ошибка при поиске клиента по контакту: ' + escapeHtml(error.message), 'alert');
                    pendingAppointmentData = null; // Clear pending data on error
                });
        };

        // New function to handle quick client creation from modal
        var handleQuickAddClient = function(event) {
            console.log("handleQuickAddClient: Function started.");
            event.preventDefault();
            var form = event.target;
            var nameInput = form['quick-client-name'];
            var contactInput = form['quick-client-contact'];

            var name = nameInput ? nameInput.value.trim() : '';
            var contact = contactInput ? contactInput.value.trim() : '';

            if (!name || !contact) {
                console.warn("handleQuickAddClient: Missing client name or contact.");
                showModal('Ошибка', 'Имя и контакты клиента обязательны.', 'alert');
                return;
            }

            // Explicitly select the inserted row to ensure data is returned
            supabase.from('clients').insert([{ name: name, contact: contact, social_links: null, notes: null, tags: [] }]).select()
                .then(function(response) {
                    console.log("Quick client add response:", response);
                    if (response.error) throw response.error;
                    var newClient = response.data && response.data.length > 0 ? response.data[0] : null; // Assuming Supabase returns the inserted row
                    if (newClient) {
                        showModal('Успех', 'Новый клиент "' + escapeHtml(newClient.name) + '" успешно добавлен!', 'alert', function() {
                            var quickAddClientModal = document.getElementById('quick-add-client-modal');
                            if (quickAddClientModal) quickAddClientModal.classList.add('hidden');
                            // Re-fetch data to update appState.clients
                            console.log("handleQuickAddClient: New client added, re-fetching data.");
                            fetchData().then(function() {
                                // Now try to create the appointment with the new client's ID
                                if (pendingAppointmentData) {
                                    console.log("handleQuickAddClient: Creating pending appointment with new client.");
                                    createAppointment(newClient.id,
                                                      pendingAppointmentData.date,
                                                      pendingAppointmentData.time,
                                                      pendingAppointmentData.duration,
                                                      pendingAppointmentData.complexity,
                                                      pendingAppointmentData.sketchUrl);
                                    pendingAppointmentData = null; // Clear pending data
                                }
                            });
                        });
                    } else {
                        console.error("handleQuickAddClient: No new client data returned after insert.");
                        showModal('Ошибка', 'Не удалось получить данные нового клиента после добавления.', 'alert');
                    }
                })
                .catch(function(error) {
                    console.error('Ошибка добавления клиента:', error.message);
                    showModal('Ошибка', 'Не удалось добавить клиента: ' + escapeHtml(error.message), 'alert');
                });
        };

        // Add event listeners for the new quick client modal
        var quickAddClientModalCloseButton = document.getElementById('quick-add-client-modal-close-button');
        if (quickAddClientModalCloseButton) {
            console.log("Attaching listener to #quick-add-client-modal-close-button.");
            quickAddClientModalCloseButton.onclick = function() {
                console.log("Event: #quick-add-client-modal-close-button clicked.");
                var quickAddClientModal = document.getElementById('quick-add-client-modal');
                if (quickAddClientModal) quickAddClientModal.classList.add('hidden');
                pendingAppointmentData = null; // Clear pending data if user cancels
            };
        } else {
            console.warn("#quick-add-client-modal-close-button not found.");
        }
        var cancelQuickClientForm = document.getElementById('cancel-quick-client-form');
        if (cancelQuickClientForm) {
            console.log("Attaching listener to #cancel-quick-client-form.");
            cancelQuickClientForm.onclick = function() {
                console.log("Event: #cancel-quick-client-form clicked.");
                var quickAddClientModal = document.getElementById('quick-add-client-modal');
                if (quickAddClientModal) quickAddClientModal.classList.add('hidden');
                pendingAppointmentData = null; // Clear pending data if user cancels
            };
        } else {
            console.warn("#cancel-quick-client-form not found.");
        }
        var quickClientForm = document.getElementById('quick-client-form');
        if (quickClientForm) {
            console.log("Attaching submit listener to #quick-client-form.");
            quickClientForm.addEventListener('submit', handleQuickAddClient);
        } else {
            console.warn("#quick-client-form not found.");
        }

        var renderUpcomingAppointments = function() {
            console.log("renderUpcomingAppointments: Function started.");
            var listContainer = document.getElementById('upcoming-appointments-list');
            if (!listContainer) {
                console.error("renderUpcomingAppointments: Upcoming appointments list container not found.");
                return;
            }
            var upcomingAppointments = filterArray(appState.appointments, function(app) { return app.status === 'pending' || app.status === 'confirmed'; })
                .sort(function(a, b) { return new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time); });

            if (upcomingAppointments.length === 0) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                        <i class="fas fa-calendar-times text-6xl mb-4"></i>
                        <p class="text-lg">Немає записів</p>
                        <p class="text-md mb-4">Створіть перший запис клієнта</p>
                        <button id="add-appointment-from-empty-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-plus mr-2"></i>Додати запис
                        </button>
                    </div>
                `;
                var addAppointmentFromEmptyBtn = document.getElementById('add-appointment-from-empty-btn');
                if (addAppointmentFromEmptyBtn) {
                    console.log("renderUpcomingAppointments: Found #add-appointment-from-empty-btn, attaching listener.");
                    addAppointmentFromEmptyBtn.addEventListener('click', function() {
                        console.log("Event: #add-appointment-from-empty-btn clicked.");
                        var formContainer = document.getElementById('appointment-form-container');
                        if (formContainer) {
                            formContainer.classList.remove('hidden');
                            console.log("Event: Appointment form container shown.");
                        }
                    });
                } else {
                    console.warn("renderUpcomingAppointments: #add-appointment-from-empty-btn not found.");
                }
                console.log("renderUpcomingAppointments: No upcoming appointments, rendered empty state.");
                return;
            }

            listContainer.innerHTML = `
                <table class="min-w-full bg-gray-800 rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-700 text-gray-300 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Дата</th>
                            <th class="py-3 px-6 text-left">Время</th>
                            <th class="py-3 px-6 text-left">Клиент</th>
                            <th class="py-3 px-6 text-left">Длительность</th>
                            <th class="py-3 px-6 text-left">Сложность</th>
                            <th class="py-3 px-6 text-left">Статус</th>
                            <th class="py-3 px-6 text-center rounded-tr-lg">Действия</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-200 text-sm">
                        ${mapArray(upcomingAppointments, function(app) {
                            return `
                                <tr class="border-b border-gray-600 hover:bg-gray-700">
                                    <td class="py-3 px-6 text-left whitespace-nowrap">${formatDate(app.date)}</td>
                                    <td class="py-3 px-6 text-left">${formatTime(app.time)}</td>
                                    <td class="py-3 px-6 text-left">${app.clients ? escapeHtml(app.clients.name) : 'Неизвестно'}</td>
                                    <td class="py-3 px-6 text-left">${escapeHtml(app.duration)} ч</td>
                                    <td class="py-3 px-6 text-left">${escapeHtml(app.complexity)}</td>
                                    <td class="py-3 px-6 text-left">
                                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${app.status === 'confirmed' ? 'bg-green-700 text-green-100' : 'bg-yellow-700 text-yellow-100'}">
                                            ${app.status === 'pending' ? 'Ожидает' : 'Подтверждено'}
                                        </span>
                                    </td>
                                    <td class="py-3 px-6 text-center">
                                        ${app.status === 'pending' ? `
                                            <button data-id="${escapeHtml(app.id)}" class="confirm-appointment-btn bg-green-600 text-white px-3 py-1 rounded-md text-xs hover:bg-green-700 transition-colors mr-2">Подтвердить</button>
                                            <button data-id="${escapeHtml(app.id)}" class="cancel-appointment-btn bg-red-600 text-white px-3 py-1 rounded-md text-xs hover:bg-red-700 transition-colors">Отменить</button>
                                        ` : `
                                            <a href="#session/${escapeHtml(app.id)}" class="bg-purple-600 text-white px-3 py-1 rounded-md text-xs hover:bg-purple-700 transition-colors">Открыть калькулятор</a>
                                        `}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            var confirmButtons = listContainer.querySelectorAll('.confirm-appointment-btn');
            console.log("renderUpcomingAppointments: Found", confirmButtons.length, "confirm appointment buttons.");
            for (var i = 0; i < confirmButtons.length; i++) {
                confirmButtons[i].addEventListener('click', function(e) {
                    console.log("Event: Confirm appointment button clicked.");
                    var appointmentId = e.target.dataset.id;
                    showModal('Подтверждение', 'Вы уверены, что хотите подтвердить этот визит? Он будет перенесен в калькулятор сеанса.', 'confirm', function() {
                        supabase.from('appointments').update({ status: 'confirmed' }).eq('id', appointmentId)
                            .then(function(response) {
                                console.log("Confirm appointment response:", response);
                                if (response.error) throw response.error;
                                showModal('Успех', 'Визит подтвержден!', 'alert');
                                window.location.hash = '#session/' + escapeHtml(appointmentId); // Redirect to session calculator
                            })
                            .catch(function(error) {
                                console.error('Ошибка подтверждения визита:', error.message);
                                showModal('Ошибка', 'Не удалось подтвердить визит: ' + escapeHtml(error.message), 'alert');
                            });
                    });
                });
            }

            var cancelButtons = listContainer.querySelectorAll('.cancel-appointment-btn');
            console.log("renderUpcomingAppointments: Found", cancelButtons.length, "cancel appointment buttons.");
            for (var i = 0; i < cancelButtons.length; i++) {
                cancelButtons[i].addEventListener('click', function(e) {
                    console.log("Event: Cancel appointment button clicked.");
                    var appointmentId = e.target.dataset.id;
                    showModal('Отмена визита', 'Вы уверены, что хотите отменить этот визит?', 'confirm', function() {
                        supabase.from('appointments').update({ status: 'cancelled' }).eq('id', appointmentId)
                            .then(function(response) {
                                console.log("Cancel appointment response:", response);
                                if (response.error) throw response.error;
                                showModal('Успех', 'Визит отменен.', 'alert');
                                fetchDataAndRerenderCurrentPage(); // Re-fetch and re-render
                            })
                            .catch(function(error) {
                                console.error('Ошибка отмены визита:', error.message);
                                showModal('Ошибка', 'Не удалось отменить визит: ' + escapeHtml(error.message), 'alert');
                            });
                    });
                });
            }
            console.log("renderUpcomingAppointments: Function finished.");
        };

        // 3. Tattoo Session Calculator
        var renderSessionCalculator = function(appointmentId) {
            console.log("renderSessionCalculator: Function started for appointment ID:", appointmentId);
            var dynamicContentArea = document.getElementById('dynamic-content-area');
            if (!dynamicContentArea) {
                console.error("renderSessionCalculator: Dynamic content area not found.");
                return;
            }
            var appointment = findInArray(appState.appointments, function(app) { return app.id === appointmentId; });

            if (!appointment) {
                console.warn("renderSessionCalculator: Appointment not found or not confirmed for ID:", appointmentId);
                dynamicContentArea.innerHTML = `<div class="p-4 bg-red-900 text-red-200 rounded-lg">Визит не найден или не подтвержден.</div>`;
                return;
            }

            var client = findInArray(appState.clients, function(c) { return c.id === appointment.client_id; });
            // hourlyRate is now accessed directly from appState.hourlyRate inside calculateSessionPrice.
            // var hourlyRate = appState.hourlyRate; // This local variable is no longer needed here for calculateSessionPrice

            dynamicContentArea.innerHTML = `
                <div class="p-4 md:p-8 bg-gray-700 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-blue-300">Калькулятор тату-сеанса</h2>
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">Визит клиента: ${client ? escapeHtml(client.name) : 'Неизвестно'} (${formatDate(appointment.date)} ${formatTime(appointment.time)})</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="space-y-4">
                            <div>
                                <label for="session-start-time" class="block text-sm font-medium text-gray-300">Время начала</label>
                                <input type="datetime-local" id="session-start-time" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="session-end-time" class="block text-sm font-medium text-gray-300">Время окончания</label>
                                <input type="datetime-local" id="session-end-time" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="session-complexity" class="block text-sm font-medium text-gray-300">Сложность (1-10)</label>
                                <input type="number" id="session-complexity" min="1" max="10" value="${escapeHtml(appointment.complexity)}" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="session-discount" class="block text-sm font-medium text-gray-300">Скидка (%)</label>
                                <input type="number" id="session-discount" min="0" max="100" value="0" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="session-notes" class="block text-sm font-medium text-gray-300">Заметки по сеансу</label>
                                <textarea id="session-notes" rows="3" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200"></textarea>
                            </div>
                            ${appointment.sketch_url ? `
                                <div class="mt-4">
                                    <h4 class="text-lg font-semibold mb-2 text-gray-300">Эскиз:</h4>
                                    <img src="${escapeHtml(appointment.sketch_url)}" alt="Эскиз тату" class="w-full h-48 object-contain rounded-lg shadow-md border border-gray-600" onerror="this.onerror=null;this.src='https://placehold.co/300x200/4a5568/a0aec0?text=Нет+эскиза';">
                                </div>
                            ` : `<p class="text-gray-400 mt-4">Эскиз не прикреплен.</p>`}
                        </div>

                        <div class="space-y-4">
                            <div>
                                <h4 class="text-lg font-semibold mb-2 text-gray-300">Использованные расходники</h4>
                                <div id="materials-used-list" class="space-y-3">
                                    </div>
                                <button id="add-material-btn" class="mt-3 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                                    Добавить расходник
                                </button>
                            </div>

                            <div class="bg-blue-900 p-5 rounded-lg shadow-inner mt-6">
                                <h4 class="text-xl font-bold mb-3 text-blue-200">Итого:</h4>
                                <p class="text-lg text-blue-100">Время работы: <span id="calculated-work-time">0</span> ч</p>
                                <p class="text-lg text-blue-100">Себестоимость материалов: <span id="calculated-cost-price">${formatCurrency(0)}</span></p>
                                <p class="text-lg text-blue-100">Наценка за сложность: <span id="calculated-complexity-markup">${formatCurrency(0)}</span></p>
                                <p class="text-lg text-blue-100">Стоимость работы: <span id="calculated-work-cost">${formatCurrency(0)}</span></p>
                                <p class="text-2xl font-bold text-blue-50 mt-4">Итоговая цена: <span id="calculated-total-price">${formatCurrency(0)}</span></p>
                            </div>

                            <div class="mt-6">
                                <label for="payment-method" class="block text-sm font-medium text-gray-300">Метод оплаты</label>
                                <select id="payment-method" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                                    <option value="cash">Наличные</option>
                                    <option value="card">Карта</option>
                                    <option value="transfer">Перевод</option>
                                </select>
                            </div>

                            <div class="flex justify-end mt-6 space-x-3">
                                <button id="save-session-btn" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-colors">
                                    Оплата и завершение
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Pre-fill start time with appointment date and time
            var sessionStartTimeEl = document.getElementById('session-start-time');
            if (sessionStartTimeEl) {
                var appointmentDateTime = new Date(appointment.date + 'T' + appointment.time);
                sessionStartTimeEl.value = appointmentDateTime.toISOString().slice(0, 16);
                console.log("renderSessionCalculator: Pre-filled session start time.");
            } else {
                console.warn("renderSessionCalculator: #session-start-time not found.");
            }


            var materialsUsedList = document.getElementById('materials-used-list');
            if (!materialsUsedList) {
                console.error("renderSessionCalculator: Materials used list container not found.");
                return;
            }

            function addMaterialInput(material) {
                if (material === void 0) { material = null; }
                var materialDiv = document.createElement('div');
                materialDiv.className = 'flex items-center space-x-2';
                materialDiv.innerHTML = `
                    <select class="material-select block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                        <option value="">Выберите материал</option>
                        ${mapArray(appState.materials, function(m) { return `<option value="${escapeHtml(m.id)}" data-price="${escapeHtml(m.unit_price)}" ${material && material.material_id === m.id ? 'selected' : ''}>${escapeHtml(m.name)} (${formatCurrency(m.unit_price)}/ед.)</option>`; }).join('')}
                    </select>
                    <input type="number" min="0.01" step="0.01" placeholder="Кол-во" value="${escapeHtml(material ? material.quantity : '')}" class="material-quantity w-24 p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                    <button class="remove-material-btn text-red-500 hover:text-red-400 p-2 rounded-full">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                materialsUsedList.appendChild(materialDiv);

                var selectElement = materialDiv.querySelector('.material-select');
                var quantityElement = materialDiv.querySelector('.material-quantity');
                var removeButton = materialDiv.querySelector('.remove-material-btn');

                if (selectElement) {
                    selectElement.addEventListener('change', calculateSessionPrice);
                    console.log("renderSessionCalculator: Attached change listener to new material select.");
                }
                if (quantityElement) {
                    quantityElement.addEventListener('input', calculateSessionPrice);
                    console.log("renderSessionCalculator: Attached input listener to new material quantity.");
                }
                if (removeButton) {
                    removeButton.addEventListener('click', function() {
                        console.log("Event: Remove material button clicked.");
                        materialsUsedList.removeChild(materialDiv);
                        calculateSessionPrice();
                    });
                    console.log("renderSessionCalculator: Attached click listener to new remove material button.");
                }
            }

            var addMaterialBtn = document.getElementById('add-material-btn');
            if (addMaterialBtn) {
                console.log("renderSessionCalculator: Found #add-material-btn, attaching listener.");
                addMaterialBtn.addEventListener('click', function() {
                    console.log("Event: #add-material-btn clicked.");
                    addMaterialInput();
                });
            } else {
                console.warn("renderSessionCalculator: #add-material-btn not found.");
            }


            // Load existing materials if session was already calculated (e.g., editing a completed session)
            var existingSession = findInArray(appState.sessions, function(s) { return s.appointment_id === appointmentId; });
            if (existingSession && existingSession.materials_used) {
                console.log("renderSessionCalculator: Found existing session materials, parsing and adding inputs.");
                try {
                    var parsedMaterials = JSON.parse(existingSession.materials_used);
                    mapArray(parsedMaterials, function(mat) { addMaterialInput(mat); });
                    var sessionStartTimeEl = document.getElementById('session-start-time');
                    var sessionEndTimeEl = document.getElementById('session-end-time');
                    var sessionComplexityEl = document.getElementById('session-complexity');
                    var sessionDiscountEl = document.getElementById('session-discount');
                    var paymentMethodEl = document.getElementById('payment-method');
                    var sessionNotesEl = document.getElementById('session-notes');

                    if (sessionStartTimeEl) sessionStartTimeEl.value = new Date(existingSession.start_time).toISOString().slice(0, 16);
                    if (sessionEndTimeEl) sessionEndTimeEl.value = new Date(existingSession.end_time).toISOString().slice(0, 16);
                    if (sessionComplexityEl) sessionComplexityEl.value = escapeHtml(existingSession.complexity_score);
                    if (sessionDiscountEl) sessionDiscountEl.value = escapeHtml(existingSession.discount);
                    if (paymentMethodEl) paymentMethodEl.value = escapeHtml(existingSession.payment_method);
                    if (sessionNotesEl) sessionNotesEl.value = escapeHtml(existingSession.notes || '');
                    console.log("renderSessionCalculator: Pre-filled session details from existing session.");
                } catch (e) {
                    console.error("renderSessionCalculator: Error parsing materials_used:", e);
                }
            } else {
                // Add one empty material input by default for new sessions
                console.log("renderSessionCalculator: No existing session materials, adding one empty input.");
                addMaterialInput();
            }


            // Event listeners for calculations
            var sessionStartTime = document.getElementById('session-start-time');
            if (sessionStartTime) {
                sessionStartTime.addEventListener('input', calculateSessionPrice);
                console.log("renderSessionCalculator: Attached input listener to #session-start-time.");
            }
            var sessionEndTime = document.getElementById('session-end-time');
            if (sessionEndTime) {
                sessionEndTime.addEventListener('input', calculateSessionPrice);
                console.log("renderSessionCalculator: Attached input listener to #session-end-time.");
            }
            var sessionComplexity = document.getElementById('session-complexity');
            if (sessionComplexity) {
                sessionComplexity.addEventListener('input', calculateSessionPrice);
                console.log("renderSessionCalculator: Attached input listener to #session-complexity.");
            }
            var sessionDiscount = document.getElementById('session-discount');
            if (sessionDiscount) {
                sessionDiscount.addEventListener('input', calculateSessionPrice);
                console.log("renderSessionCalculator: Attached input listener to #session-discount.");
            }

            // Initial calculation
            calculateSessionPrice();
            console.log("renderSessionCalculator: Performed initial price calculation.");

            var saveSessionBtn = document.getElementById('save-session-btn');
            if (saveSessionBtn) {
                console.log("renderSessionCalculator: Found #save-session-btn, attaching listener.");
                saveSessionBtn.addEventListener('click', function() {
                    console.log("Event: #save-session-btn clicked.");
                    var startTimeInput = document.getElementById('session-start-time');
                    var endTimeInput = document.getElementById('session-end-time');
                    var complexityInput = document.getElementById('session-complexity');
                    var discountInput = document.getElementById('session-discount');
                    var paymentMethodInput = document.getElementById('payment-method');
                    var notesInput = document.getElementById('session-notes');

                    var startTime = startTimeInput ? startTimeInput.value : '';
                    var endTime = endTimeInput ? endTimeInput.value : '';
                    var complexity = complexityInput ? parseInt(complexityInput.value) : NaN;
                    var discount = discountInput ? parseFloat(discountInput.value) : NaN;
                    var paymentMethod = paymentMethodInput ? paymentMethodInput.value : '';
                    var notes = notesInput ? notesInput.value : '';

                    if (!startTime || !endTime || isNaN(complexity) || isNaN(discount)) {
                        console.warn("saveSessionBtn: Missing required session fields.");
                        showModal('Ошибка', 'Пожалуйста, заполните все поля времени, сложности и скидки.', 'alert');
                        return;
                    }

                    var start = new Date(startTime);
                    var end = new Date(endTime);

                    if (end <= start) {
                        console.warn("saveSessionBtn: End time is not after start time.");
                        showModal('Ошибка', 'Время окончания должно быть позже времени начала.', 'alert');
                        return;
                    }

                    var calculationResults = calculateSessionPrice(true);
                    var totalWorkTime = calculationResults.totalWorkTime;
                    var costPriceMaterials = calculationResults.costPriceMaterials;
                    var complexityMarkup = calculationResults.complexityMarkup;
                    var workCost = calculationResults.workCost;
                    var finalPrice = calculationResults.finalPrice;

                    var materialsUsed = mapArray(materialsUsedList.children, function(div) {
                        var select = div.querySelector('.material-select');
                        var quantity = div.querySelector('.material-quantity');
                        return {
                            material_id: select ? select.value : null,
                            quantity: parseFloat(quantity ? quantity.value : 0)
                        };
                    });
                    materialsUsed = filterArray(materialsUsed, function(m) { return m.material_id && m.quantity > 0; }); // Filter out empty or zero quantity materials

                    // Check for duplicate materials
                    var materialCounts = {};
                    for (var i = 0; i < materialsUsed.length; i++) {
                        var mat = materialsUsed[i];
                        if (mat.material_id) { // Only count if material_id is present
                            materialCounts[mat.material_id] = (materialCounts[mat.material_id] || 0) + 1;
                            if (materialCounts[mat.material_id] > 1) {
                                console.warn("saveSessionBtn: Duplicate materials found.");
                                showModal('Ошибка', 'Обнаружены дубликаты материалов. Пожалуйста, объедините их или удалите лишние.', 'alert');
                                return;
                            }
                        }
                    }

                    showModal('Подтверждение оплаты', 'Итого к оплате: ' + formatCurrency(finalPrice) + '. Подтвердить?', 'confirm', function() {
                        console.log("saveSessionBtn: User confirmed payment.");
                        var sessionId = existingSession ? existingSession.id : null;
                        var sessionData = {
                            appointment_id: appointmentId,
                            start_time: startTime,
                            end_time: endTime,
                            hourly_rate_used: appState.hourlyRate, // Use appState.hourlyRate
                            complexity_score: complexity,
                            materials_used: JSON.stringify(materialsUsed), // Store as JSON string
                            total_price: finalPrice,
                            cost_price: costPriceMaterials,
                            discount: discount,
                            payment_method: paymentMethod,
                            notes: notes
                        };

                        var promise;
                        if (sessionId) {
                            // Update existing session
                            console.log("saveSessionBtn: Updating existing session.");
                            promise = supabase.from('sessions').update(sessionData).eq('id', sessionId);
                        } else {
                            // Insert new session
                            console.log("saveSessionBtn: Inserting new session.");
                            promise = supabase.from('sessions').insert([sessionData]).select()
                                .then(function(newSessionResponse) {
                                    console.log("New session insert response:", newSessionResponse);
                                    if (newSessionResponse.error) throw newSessionResponse.error;
                                    sessionId = newSessionResponse.data && newSessionResponse.data.length > 0 ? newSessionResponse.data[0].id : null;
                                    if (!sessionId) throw new Error("Could not retrieve new session ID.");
                                    // Link session to appointment
                                    console.log("saveSessionBtn: Linking new session to appointment.");
                                    return supabase.from('appointments').update({ status: 'completed', session_id: sessionId }).eq('id', appointmentId);
                                });
                        }

                        promise
                            .then(function(response) {
                                console.log("Session/Appointment update response:", response);
                                if (response.error) throw response.error;
                                // Deduct materials from inventory and record movements
                                console.log("saveSessionBtn: Deducting materials from inventory.");
                                var materialDeductionPromises = mapArray(materialsUsed, function(item) {
                                    var material = findInArray(appState.materials, function(m) { return m.id === item.material_id; });
                                    if (material) {
                                        var newStock = material.stock - item.quantity;
                                        return supabase.from('materials').update({ stock: newStock }).eq('id', item.material_id)
                                            .then(function() {
                                                console.log("Material stock updated for:", material.name, "New stock:", newStock);
                                                return supabase.from('material_movements').insert([
                                                    {
                                                        material_id: item.material_id,
                                                        type: 'out',
                                                        quantity: item.quantity,
                                                        source_target: 'session_' + escapeHtml(sessionId) // Escape sessionId here
                                                    }
                                                ]);
                                            });
                                    }
                                    return Promise.resolve(); // Resolve if material not found
                                });
                                return Promise.all(materialDeductionPromises);
                            })
                            .then(function() {
                                showModal('Успех', 'Сеанс успешно сохранен и оплачен!', 'alert');
                                fetchDataAndRerenderCurrentPage(); // Re-fetch and re-render
                                window.location.hash = '#appointments'; // Go back to appointments
                                console.log("saveSessionBtn: Session saved, materials deducted, redirected to appointments.");
                            })
                            .catch(function(error) {
                                console.error('Ошибка сохранения сеанса:', error.message);
                                showModal('Ошибка', 'Не удалось сохранить сеанс: ' + escapeHtml(error.message), 'alert');
                            });
                    });
                });
            } else {
                console.warn("renderSessionCalculator: #save-session-btn not found.");
            }
            console.log("renderSessionCalculator: Function finished.");
        };


            function calculateSessionPrice(returnValues) {
                // Ensure returnValues is a boolean, default to false
                returnValues = typeof returnValues === 'boolean' ? returnValues : false;
                console.log("calculateSessionPrice: Function called with returnValues:", returnValues);
                var startTimeEl = document.getElementById('session-start-time');
                var endTimeEl = document.getElementById('session-end-time');
                var complexityEl = document.getElementById('session-complexity');
                var discountEl = document.getElementById('session-discount');

                var startTime = startTimeEl ? startTimeEl.value : '';
                var endTime = endTimeEl ? endTimeEl.value : '';
                var complexity = complexityEl ? parseInt(complexityEl.value) : 0;
                var discount = discountEl ? parseFloat(discountEl.value) : 0;

                var totalWorkTime = 0;
                if (startTime && endTime) {
                    var start = new Date(startTime);
                    var end = new Date(endTime);
                    if (end > start) {
                        totalWorkTime = (end - start) / (1000 * 60 * 60); // in hours
                    }
                }

                var costPriceMaterials = 0;
                var materialsUsedList = document.getElementById('materials-used-list'); // Ensure this is accessible
                var materialInputs = materialsUsedList ? materialsUsedList.querySelectorAll('.material-select') : [];
                var quantityInputs = materialsUsedList ? materialsUsedList.querySelectorAll('.material-quantity') : [];

                for (var i = 0; i < materialInputs.length; i++) {
                    var materialId = materialInputs[i].value;
                    var quantity = parseFloat(quantityInputs[i].value);
                    if (materialId && !isNaN(quantity) && quantity > 0) {
                        var material = findInArray(appState.materials, function(m) { return m.id === materialId; });
                        if (material) {
                            costPriceMaterials += material.unit_price * quantity;
                        }
                    }
                }

                var workCost = totalWorkTime * appState.hourlyRate; // Corrected to use appState.hourlyRate
                var complexityMarkup = workCost * (complexity / 100); // Simple markup based on complexity (e.g., 10% for complexity 10)
                var subtotal = workCost + complexityMarkup + costPriceMaterials;
                var finalPrice = subtotal * (1 - (discount / 100));

                var calculatedWorkTimeEl = document.getElementById('calculated-work-time');
                if (calculatedWorkTimeEl) calculatedWorkTimeEl.textContent = totalWorkTime.toFixed(2);
                var calculatedCostPriceEl = document.getElementById('calculated-cost-price');
                if (calculatedCostPriceEl) calculatedCostPriceEl.textContent = formatCurrency(costPriceMaterials);
                var calculatedComplexityMarkupEl = document.getElementById('calculated-complexity-markup');
                if (calculatedComplexityMarkupEl) calculatedComplexityMarkupEl.textContent = formatCurrency(complexityMarkup);
                var calculatedWorkCostEl = document.getElementById('calculated-work-cost');
                if (calculatedWorkCostEl) calculatedWorkCostEl.textContent = formatCurrency(workCost);
                var calculatedTotalPriceEl = document.getElementById('calculated-total-price');
                if (calculatedTotalPriceEl) calculatedTotalPriceEl.textContent = formatCurrency(finalPrice);

                if (returnValues) {
                    return { totalWorkTime: totalWorkTime, costPriceMaterials: costPriceMaterials, complexityMarkup: complexityMarkup, workCost: workCost, finalPrice: finalPrice };
                }
            }


        // 4. Clients Module
        var renderClients = function() {
            console.log("renderClients: Function started.");
            var dynamicContentArea = document.getElementById('dynamic-content-area');
            if (!dynamicContentArea) {
                console.error("renderClients: Dynamic content area not found.");
                return;
            }
            dynamicContentArea.innerHTML = `
                <div class="p-4 md:p-8 bg-gray-700 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-blue-300">Клиенты</h2>

                    <div class="flex justify-end mb-6">
                        <button id="add-client-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-plus mr-2"></i>Додати клієнта
                        </button>
                    </div>

                    <div id="client-form-container" class="hidden bg-gray-800 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-blue-300">Додати/Редагувати клієнта</h3>
                        <form id="client-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="client-id">
                            <div>
                                <label for="client-name" class="block text-sm font-medium text-gray-300">Ім'я</label>
                                <input type="text" id="client-name" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="client-contact" class="block text-sm font-medium text-gray-300">Контакти (телефон/email)</label>
                                <input type="text" id="client-contact" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div class="md:col-span-2">
                                <label for="client-social" class="block text-sm font-medium text-gray-300">Посилання на соцмережі</label>
                                <input type="text" id="client-social" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200" placeholder="https://instagram.com/user">
                            </div>
                            <div class="md:col-span-2">
                                <label for="client-notes" class="block text-sm font-medium text-gray-300">Заметки</label>
                                <textarea id="client-notes" rows="3" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200"></textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label for="client-tags" class="block text-sm font-medium text-gray-300">Метки (через запятую)</label>
                                <input type="text" id="client-tags" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200" placeholder="Постоянный, Пропускал">
                            </div>
                            <div class="md:col-span-2 flex justify-end space-x-3">
                                <button type="button" id="cancel-client-form" class="px-5 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Отмена</button>
                                <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Сохранить клиента</button>
                            </div>
                        </form>
                    </div>

                    <h3 class="text-2xl font-semibold mb-4 text-blue-300">Список клиентов</h3>
                    <div id="clients-list" class="overflow-x-auto">
                        </div>
                </div>
            `;

            var addClientBtn = document.getElementById('add-client-btn');
            if (addClientBtn) {
                console.log("renderClients: Found #add-client-btn, attaching listener.");
                addClientBtn.addEventListener('click', function() {
                    console.log("Event: #add-client-btn clicked.");
                    var formContainer = document.getElementById('client-form-container');
                    var clientForm = document.getElementById('client-form');
                    var clientIdInput = document.getElementById('client-id');
                    if (formContainer) formContainer.classList.toggle('hidden');
                    if (clientForm) clientForm.reset();
                    if (clientIdInput) clientIdInput.value = ''; // Clear ID for new client
                    console.log("Event: Toggled client form visibility and reset.");
                });
            } else {
                console.warn("renderClients: #add-client-btn not found.");
            }

            var cancelClientFormBtn = document.getElementById('cancel-client-form');
            if (cancelClientFormBtn) {
                console.log("renderClients: Found #cancel-client-form, attaching listener.");
                cancelClientFormBtn.addEventListener('click', function() {
                    console.log("Event: #cancel-client-form clicked.");
                    var formContainer = document.getElementById('client-form-container');
                    var clientForm = document.getElementById('client-form');
                    if (formContainer) formContainer.classList.add('hidden');
                    if (clientForm) clientForm.reset();
                    console.log("Event: Client form cancelled and hidden.");
                });
            } else {
                console.warn("renderClients: #cancel-client-form not found.");
            }

            var clientForm = document.getElementById('client-form');
            if (clientForm) {
                console.log("renderClients: Found #client-form, attaching submit listener.");
                clientForm.addEventListener('submit', handleAddEditClient);
            } else {
                console.warn("renderClients: #client-form not found.");
            }
            renderClientList();
            console.log("renderClients: Function finished.");
        };

        var handleAddEditClient = function(event) {
            console.log("handleAddEditClient: Function started.");
            event.preventDefault();
            var form = event.target;
            var clientIdInput = form['client-id'];
            var nameInput = form['client-name'];
            var contactInput = form['client-contact'];
            var socialLinksInput = form['client-social'];
            var notesInput = form['client-notes'];
            var tagsInput = form['client-tags'];

            var clientId = clientIdInput ? clientIdInput.value : '';
            var name = nameInput ? nameInput.value : '';
            var contact = contactInput ? contactInput.value : '';
            var socialLinks = socialLinksInput ? socialLinksInput.value : '';
            var notes = notesInput ? notesInput.value : '';
            var tags = tagsInput ? filterArray(mapArray(tagsInput.value.split(','), function(tag) { return tag.trim(); }), function(tag) { return tag !== ''; }) : [];

            if (!name || !contact) {
                console.warn("handleAddEditClient: Missing client name or contact.");
                showModal('Ошибка', 'Имя и контакты клиента обязательны.', 'alert');
                return;
            }

            var promise;
            if (clientId) {
                console.log("handleAddEditClient: Updating existing client.");
                // Update existing client
                promise = supabase.from('clients').update({ name: name, contact: contact, social_links: socialLinks, notes: notes, tags: tags }).eq('id', clientId);
            } else {
                console.log("handleAddEditClient: Adding new client.");
                // Add new client
                promise = supabase.from('clients').insert([{ name: name, contact: contact, social_links: socialLinks, notes: notes, tags: tags }]);
            }

            promise
                .then(function(response) {
                    console.log("Client save response:", response);
                    if (response.error) throw response.error;
                    showModal('Успех', 'Данные клиента успешно ' + (clientId ? 'обновлены' : 'добавлены') + '!', 'alert');
                    form.reset();
                    var formContainer = document.getElementById('client-form-container');
                    if (formContainer) formContainer.classList.add('hidden');
                    fetchDataAndRerenderCurrentPage();
                    console.log("handleAddEditClient: Client saved and page re-rendered.");
                })
                .catch(function(error) {
                    console.error('Ошибка сохранения клиента:', error.message);
                    showModal('Ошибка', 'Не удалось сохранить клиента: ' + escapeHtml(error.message), 'alert');
                });
        };

        var renderClientList = function() {
            console.log("renderClientList: Function started.");
            var listContainer = document.getElementById('clients-list');
            if (!listContainer) {
                console.error("renderClientList: Clients list container not found.");
                return;
            }
            if (appState.clients.length === 0) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                        <i class="fas fa-users text-6xl mb-4"></i>
                        <p class="text-lg">База клієнтів порожня</p>
                        <button id="add-client-from-empty-btn" class="mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-plus mr-2"></i>Додати клієнта
                        </button>
                    </div>
                `;
                var addClientFromEmptyBtn = document.getElementById('add-client-from-empty-btn');
                if (addClientFromEmptyBtn) {
                    console.log("renderClientList: Found #add-client-from-empty-btn, attaching listener.");
                    addClientFromEmptyBtn.addEventListener('click', function() {
                        console.log("Event: #add-client-from-empty-btn clicked.");
                        var formContainer = document.getElementById('client-form-container');
                        if (formContainer) {
                            formContainer.classList.remove('hidden');
                            console.log("Event: Client form container shown.");
                        }
                    });
                } else {
                    console.warn("renderClientList: #add-client-from-empty-btn not found.");
                }
                console.log("renderClientList: No clients, rendered empty state.");
                return;
            }

            listContainer.innerHTML = `
                <table class="min-w-full bg-gray-800 rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-700 text-gray-300 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Ім'я</th>
                            <th class="py-3 px-6 text-left">Контакти</th>
                            <th class="py-3 px-6 text-left">Сеанси</th>
                            <th class="py-3 px-6 text-left">Останній візит</th>
                            <th class="py-3 px-6 text-center rounded-tr-lg">Дії</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-200 text-sm">
                        ${mapArray(appState.clients, function(client) {
                            var clientSessions = filterArray(appState.sessions, function(s) {
                                var app = findInArray(appState.appointments, function(a) { return a.id === s.appointment_id; });
                                return app && app.client_id === client.id;
                            });
                            var lastVisit = clientSessions.length > 0
                                ? formatDate(clientSessions.sort(function(a, b) { return new Date(b.start_time) - new Date(a.start_time); })[0].start_time)
                                : 'N/A';
                            return `
                                <tr class="border-b border-gray-600 hover:bg-gray-700">
                                    <td class="py-3 px-6 text-left font-medium">${escapeHtml(client.name)}</td>
                                    <td class="py-3 px-6 text-left">${escapeHtml(client.contact)}</td>
                                    <td class="py-3 px-6 text-left">${escapeHtml(clientSessions.length)}</td>
                                    <td class="py-3 px-6 text-left">${escapeHtml(lastVisit)}</td>
                                    <td class="py-3 px-6 text-center">
                                        <button data-id="${escapeHtml(client.id)}" class="edit-client-btn bg-yellow-600 text-white px-3 py-1 rounded-md text-xs hover:bg-yellow-700 transition-colors mr-2">Редагувати</button>
                                        <button data-id="${escapeHtml(client.id)}" class="view-client-history-btn bg-purple-600 text-white px-3 py-1 rounded-md text-xs hover:bg-purple-700 transition-colors mr-2">Історія</button>
                                        <button data-id="${escapeHtml(client.id)}" class="delete-client-btn bg-red-600 text-white px-3 py-1 rounded-md text-xs hover:bg-red-700 transition-colors">Видалити</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            var editClientButtons = listContainer.querySelectorAll('.edit-client-btn');
            console.log("renderClientList: Found", editClientButtons.length, "edit client buttons, attaching listeners.");
            for (var i = 0; i < editClientButtons.length; i++) {
                editClientButtons[i].addEventListener('click', function(e) {
                    console.log("Event: Edit client button clicked.");
                    var clientId = e.target.dataset.id;
                    var client = findInArray(appState.clients, function(c) { return c.id === clientId; });
                    if (client) {
                        var clientIdInput = document.getElementById('client-id');
                        var clientNameInput = document.getElementById('client-name');
                        var clientContactInput = document.getElementById('client-contact');
                        var clientSocialInput = document.getElementById('client-social');
                        var clientNotesInput = document.getElementById('client-notes');
                        var clientTagsInput = document.getElementById('client-tags');
                        var formContainer = document.getElementById('client-form-container');

                        if (clientIdInput) clientIdInput.value = escapeHtml(client.id);
                        if (clientNameInput) clientNameInput.value = escapeHtml(client.name);
                        if (clientContactInput) clientContactInput.value = escapeHtml(client.contact);
                        if (clientSocialInput) clientSocialInput.value = escapeHtml(client.social_links || '');
                        if (clientNotesInput) clientNotesInput.value = escapeHtml(client.notes || '');
                        if (clientTagsInput) clientTagsInput.value = escapeHtml(client.tags ? client.tags.join(', ') : '');
                        if (formContainer) formContainer.classList.remove('hidden');
                        console.log("Event: Pre-filled client form for editing.");
                    }
                });
            }

            var deleteClientButtons = listContainer.querySelectorAll('.delete-client-btn');
            console.log("renderClientList: Found", deleteClientButtons.length, "delete client buttons, attaching listeners.");
            for (var i = 0; i < deleteClientButtons.length; i++) {
                deleteClientButtons[i].addEventListener('click', function(e) {
                    console.log("Event: Delete client button clicked.");
                    var clientId = e.target.dataset.id;
                    showModal('Удалить клиента', 'Вы уверены, что хотите удалить этого клиента? Все связанные записи и сеансы останутся, но клиент будет удален из базы.', 'confirm', function() {
                        supabase.from('clients').delete().eq('id', clientId)
                            .then(function(response) {
                                console.log("Delete client response:", response);
                                if (response.error) throw response.error;
                                showModal('Успех', 'Клиент успешно удален!', 'alert');
                                fetchDataAndRerenderCurrentPage();
                                console.log("Event: Client deleted and page re-rendered.");
                            })
                            .catch(function(error) {
                                console.error('Ошибка удаления клиента:', error.message);
                                showModal('Ошибка', 'Не удалось удалить клиента: ' + escapeHtml(error.message), 'alert');
                            });
                    });
                });
            }

            var viewClientHistoryButtons = listContainer.querySelectorAll('.view-client-history-btn');
            console.log("renderClientList: Found", viewClientHistoryButtons.length, "view client history buttons, attaching listeners.");
            for (var i = 0; i < viewClientHistoryButtons.length; i++) {
                viewClientHistoryButtons[i].addEventListener('click', function(e) {
                    console.log("Event: View client history button clicked.");
                    var clientId = e.target.dataset.id;
                    showClientHistoryModal(clientId);
                });
            }
            console.log("renderClientList: Function finished.");
        };

        var showClientHistoryModal = function(clientId) {
            console.log("showClientHistoryModal: Function started for client ID:", clientId);
            var client = findInArray(appState.clients, function(c) { return c.id === clientId; });
            if (!client) {
                console.error("showClientHistoryModal: Client not found for ID:", clientId);
                showModal('Ошибка', 'Клиент не найден.', 'alert');
                return;
            }

            var clientAppointments = filterArray(appState.appointments, function(app) { return app.client_id === clientId; })
                .sort(function(a, b) { return new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + b.time); }); // Latest first

            var historyHtml = '';
            if (clientAppointments.length === 0) {
                historyHtml = '<p class="text-gray-400">У этого клиента нет истории визитов.</p>';
                console.log("showClientHistoryModal: No history found for client.");
            } else {
                historyHtml = `
                    <div class="overflow-x-auto max-h-96">
                        <table class="min-w-full bg-gray-800 rounded-lg shadow-sm text-sm">
                            <thead>
                                <tr class="bg-gray-700 text-gray-300 uppercase text-xs leading-normal">
                                    <th class="py-2 px-4 text-left rounded-tl-lg">Дата</th>
                                    <th class="py-2 px-4 text-left">Время</th>
                                    <th class="py-2 px-4 text-left">Статус</th>
                                    <th class="py-2 px-4 text-left">Цена</th>
                                    <th class="py-2 px-4 text-left">Эскиз</th>
                                    <th class="py-2 px-4 text-left rounded-tr-lg">Заметки</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-200">
                                ${mapArray(clientAppointments, function(app) {
                                    var session = findInArray(appState.sessions, function(s) { return s.appointment_id === app.id; });
                                    return `
                                        <tr class="border-b border-gray-600 hover:bg-gray-700">
                                            <td class="py-2 px-4 whitespace-nowrap">${formatDate(app.date)}</td>
                                            <td class="py-2 px-4">${formatTime(app.time)}</td>
                                            <td class="py-2 px-4">
                                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                                    app.status === 'completed' ? 'bg-green-700 text-green-100' :
                                                    app.status === 'confirmed' ? 'bg-blue-700 text-blue-100' :
                                                    app.status === 'pending' ? 'bg-yellow-700 text-yellow-100' :
                                                    'bg-red-700 text-red-100'
                                                }">
                                                    ${app.status === 'completed' ? 'Завершено' :
                                                      app.status === 'confirmed' ? 'Подтверждено' :
                                                      app.status === 'pending' ? 'Ожидает' :
                                                      'Отменено'}
                                                </span>
                                            </td>
                                            <td class="py-2 px-4 font-semibold">${session ? formatCurrency(session.total_price) : 'N/A'}</td>
                                            <td class="py-2 px-4">
                                                ${app.sketch_url ? `<a href="${escapeHtml(app.sketch_url)}" target="_blank" class="text-blue-400 hover:underline">${escapeHtml(app.sketch_url.substring(0, 30))}...</a>` : 'Нет'}
                                            </td>
                                            <td class="py-2 px-4">${session ? escapeHtml(session.notes || 'Нет') : 'Нет'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                console.log("showClientHistoryModal: Rendered client history table.");
            }

            // Determine if the contact is a phone number or email for SMS button
            var isPhoneNumber = client.contact && /^\+?\d[\d\s-()]*$/.test(client.contact); // Basic regex for phone number
            var smsButtonHtml = '';
            if (isPhoneNumber) {
                smsButtonHtml = `<button id="send-sms-to-client-btn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">Отправить SMS</button>`;
            }

            showModal(
                'История визитов для ' + escapeHtml(client.name),
                `<div class="mb-4">
                    <p class="text-gray-300"><strong>Контакты:</strong> ${escapeHtml(client.contact)}</p>
                    <p class="text-gray-300"><strong>Соцсети:</strong> ${client.social_links ? `<a href="${escapeHtml(client.social_links)}" target="_blank" class="text-blue-400 hover:underline">${escapeHtml(client.social_links)}</a>` : 'N/A'}</p>
                    <p class="text-gray-300"><strong>Заметки:</strong> ${escapeHtml(client.notes || 'Нет')}</p>
                    <p class="text-gray-300"><strong>Метки:</strong> ${client.tags && client.tags.length > 0 ? escapeHtml(client.tags.join(', ')) : 'Нет'}</p>
                </div>
                <h4 class="text-lg font-semibold mb-2 text-gray-300">История сеансов:</h4>
                ${historyHtml}
                <div class="mt-4 flex justify-end">
                    ${smsButtonHtml}
                </div>`,
                'alert' // Using alert type, but with rich HTML content
            );
            console.log("showClientHistoryModal: Modal displayed.");

            // Attach event listener for SMS button if it exists
            var sendSmsToClientBtn = document.getElementById('send-sms-to-client-btn');
            if (sendSmsToClientBtn) {
                sendSmsToClientBtn.addEventListener('click', function() {
                    showInputModal('Отправить SMS клиенту', 'Введите сообщение для ' + escapeHtml(client.name) + ':', '', function(message) {
                        if (message && message.trim() !== '') {
                            sendSms(client.contact, message.trim());
                        } else {
                            showModal('Ошибка', 'Сообщение не может быть пустым.', 'alert');
                        }
                    });
                });
            }
        };


        // 5. Inventory Module
        var renderInventory = function() {
            console.log("renderInventory: Function started.");
            var dynamicContentArea = document.getElementById('dynamic-content-area');
            if (!dynamicContentArea) {
                console.error("renderInventory: Dynamic content area not found.");
                return;
            }
            dynamicContentArea.innerHTML = `
                <div class="p-4 md:p-8 bg-gray-700 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-blue-300">Матеріали</h2>

                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center space-x-4">
                            <select class="bg-gray-800 text-gray-200 border border-gray-600 rounded-md py-2 px-4 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option>Усі категорії</option>
                                ${mapArray(appState.materialCategories, function(cat) { return `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`; }).join('')}
                            </select>
                            <div class="relative">
                                <input type="text" placeholder="Пошук матеріалів ..." class="bg-gray-800 text-gray-200 border border-gray-600 rounded-md py-2 px-4 pl-10 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                        <button id="add-material-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-plus mr-2"></i>Додати матеріал
                        </button>
                    </div>

                    <p class="text-gray-400 mb-4">Показано ${escapeHtml(appState.materials.length)} матеріалів</p>

                    <div id="material-form-container" class="hidden bg-gray-800 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-blue-300">Додати/Редагувати матеріал</h3>
                        <form id="material-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="material-id">
                            <div>
                                <label for="material-name" class="block text-sm font-medium text-gray-300">Назва</label>
                                <input type="text" id="material-name" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="material-price" class="block text-sm font-medium text-gray-300">Ціна за одиницю (грн)</label>
                                <input type="number" id="material-price" step="0.01" min="0" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="material-stock" class="block text-sm font-medium text-gray-300">Кількість</label>
                                <input type="number" id="material-stock" step="0.01" min="0" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="material-type" class="block text-sm font-medium text-gray-300">Категория</label>
                                <select id="material-type" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                                    ${mapArray(appState.materialCategories, function(cat) { return `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`; }).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="material-low-threshold" class="block text-sm font-medium text-gray-300">Поріг низького остатку</label>
                                <input type="number" id="material-low-threshold" step="0.01" min="0" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div class="md:col-span-2 flex justify-end space-x-3">
                                <button type="button" id="cancel-material-form" class="px-5 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Отмена</button>
                                <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Сохранить материал</button>
                            </div>
                        </form>
                    </div>

                    <div id="materials-list" class="overflow-x-auto mb-8">
                        </div>

                    <p class="text-gray-400 mt-4">Двічі клік по матеріалу для швидкого редагування</p>

                    <h3 class="text-2xl font-semibold mb-4 text-blue-300 mt-8">Історія рухів матеріалів</h3>
                    <div id="material-movements-list" class="overflow-x-auto">
                        </div>
                </div>
            `;

            var addMaterialBtn = document.getElementById('add-material-btn');
            if (addMaterialBtn) {
                console.log("renderInventory: Found #add-material-btn, attaching listener.");
                addMaterialBtn.addEventListener('click', function() {
                    console.log("Event: #add-material-btn clicked.");
                    var formContainer = document.getElementById('material-form-container');
                    var materialForm = document.getElementById('material-form');
                    var materialIdInput = document.getElementById('material-id');
                    if (formContainer) formContainer.classList.toggle('hidden');
                    if (materialForm) materialForm.reset();
                    if (materialIdInput) materialIdInput.value = ''; // Clear ID for new material
                    console.log("Event: Toggled material form visibility and reset.");
                });
            } else {
                console.warn("renderInventory: #add-material-btn not found.");
            }

            var cancelMaterialFormBtn = document.getElementById('cancel-material-form');
            if (cancelMaterialFormBtn) {
                console.log("renderInventory: Found #cancel-material-form, attaching listener.");
                cancelMaterialFormBtn.addEventListener('click', function() {
                    console.log("Event: #cancel-material-form clicked.");
                    var formContainer = document.getElementById('material-form-container');
                    var materialForm = document.getElementById('material-form');
                    if (formContainer) formContainer.classList.add('hidden');
                    if (materialForm) materialForm.reset();
                    console.log("Event: Material form cancelled and hidden.");
                });
            } else {
                console.warn("renderInventory: #cancel-material-form not found.");
            }

            var materialForm = document.getElementById('material-form');
            if (materialForm) {
                console.log("renderInventory: Found #material-form, attaching submit listener.");
                materialForm.addEventListener('submit', handleAddEditMaterial);
            } else {
                console.warn("renderInventory: #material-form not found.");
            }
            renderMaterialsList();
            renderMaterialMovements();
            checkLowStock();
            console.log("renderInventory: Function finished.");
        };

        var handleAddEditMaterial = function(event) {
            console.log("handleAddEditMaterial: Function started.");
            event.preventDefault();
            var form = event.target;
            var materialIdInput = form['material-id'];
            var nameInput = form['material-name'];
            var unitPriceInput = form['material-price'];
            var stockInput = form['material-stock'];
            var typeInput = form['material-type'];
            var lowStockThresholdInput = form['material-low-threshold'];

            var materialId = materialIdInput ? materialIdInput.value : '';
            var name = nameInput ? nameInput.value : '';
            var unitPrice = unitPriceInput ? parseFloat(unitPriceInput.value) : NaN;
            var stock = stockInput ? parseFloat(stockInput.value) : NaN;
            var type = typeInput ? typeInput.value : '';
            var lowStockThreshold = lowStockThresholdInput ? parseFloat(lowStockThresholdInput.value) : NaN;

            if (!name || isNaN(unitPrice) || isNaN(stock) || !type || isNaN(lowStockThreshold)) {
                console.warn("handleAddEditMaterial: Missing required fields.");
                showModal('Ошибка', 'Пожалуйста, заполните все обязательные поля.', 'alert');
                return;
            }

            var promise;
            if (materialId) {
                console.log("handleAddEditMaterial: Updating existing material.");
                // Update existing material
                promise = supabase.from('materials').update({ name: name, unit_price: unitPrice, stock: stock, type: type, low_stock_threshold: lowStockThreshold }).eq('id', materialId);
            } else {
                console.log("handleAddEditMaterial: Adding new material.");
                // Add new material
                promise = supabase.from('materials').insert([{ name: name, unit_price: unitPrice, stock: stock, type: type, low_stock_threshold: lowStockThreshold }]);
            }

            promise
                .then(function(response) {
                    console.log("Material save response:", response);
                    if (response.error) throw response.error;
                    showModal('Успех', 'Материал успешно ' + (materialId ? 'обновлен' : 'добавлен') + '!', 'alert');
                    form.reset();
                    var formContainer = document.getElementById('material-form-container');
                    if (formContainer) formContainer.classList.add('hidden');
                    fetchDataAndRerenderCurrentPage();
                    console.log("handleAddEditMaterial: Material saved and page re-rendered.");
                })
                .catch(function(error) {
                    console.error('Ошибка сохранения материала:', error.message);
                    showModal('Ошибка', 'Не удалось сохранить материал: ' + escapeHtml(error.message), 'alert');
                });
        };

        var renderMaterialsList = function() {
            console.log("renderMaterialsList: Function started.");
            var listContainer = document.getElementById('materials-list');
            if (!listContainer) {
                console.error("renderMaterialsList: Materials list container not found.");
                return;
            }
            if (appState.materials.length === 0) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                        <i class="fas fa-box-open text-6xl mb-4"></i>
                        <p class="text-lg">Немає матеріалів на складі</p>
                        <button id="add-material-from-empty-btn" class="mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-plus mr-2"></i>Додати матеріал
                        </button>
                    </div>
                `;
                var addMaterialFromEmptyBtn = document.getElementById('add-material-from-empty-btn');
                if (addMaterialFromEmptyBtn) {
                    console.log("renderMaterialsList: Found #add-material-from-empty-btn, attaching listener.");
                    addMaterialFromEmptyBtn.addEventListener('click', function() {
                        console.log("Event: #add-material-from-empty-btn clicked.");
                        var formContainer = document.getElementById('material-form-container');
                        if (formContainer) {
                            formContainer.classList.remove('hidden');
                            console.log("Event: Material form container shown.");
                        }
                    });
                } else {
                    console.warn("renderMaterialsList: #add-material-from-empty-btn not found.");
                }
                console.log("renderMaterialsList: No materials, rendered empty state.");
                return;
            }

            listContainer.innerHTML = `
                <table class="min-w-full bg-gray-800 rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-700 text-gray-300 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Назва</th>
                            <th class="py-3 px-6 text-left">Категорія</th>
                            <th class="py-3 px-6 text-left">Кількість</th>
                            <th class="py-3 px-6 text-left">Ціна</th>
                            <th class="py-3 px-6 text-center rounded-tr-lg">Дії</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-200 text-sm">
                        ${mapArray(appState.materials, function(material) {
                            return `
                                <tr class="border-b border-gray-600 hover:bg-gray-700 ${material.stock <= material.low_stock_threshold ? 'bg-red-900/30' : ''}">
                                    <td class="py-3 px-6 text-left font-medium">${escapeHtml(material.name)}</td>
                                    <td class="py-3 px-6 text-left">${escapeHtml(material.type)}</td>
                                    <td class="py-3 px-6 text-left">${escapeHtml(material.stock)}</td>
                                    <td class="py-3 px-6 text-left">${formatCurrency(material.unit_price)}</td>
                                    <td class="py-3 px-6 text-center">
                                        <button data-id="${escapeHtml(material.id)}" class="edit-material-btn bg-yellow-600 text-white px-3 py-1 rounded-md text-xs hover:bg-yellow-700 transition-colors mr-2">Редагувати</button>
                                        <button data-id="${escapeHtml(material.id)}" class="delete-material-btn bg-red-600 text-white px-3 py-1 rounded-md text-xs hover:bg-red-700 transition-colors">Видалити</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            var editMaterialButtons = listContainer.querySelectorAll('.edit-material-btn');
            console.log("renderMaterialsList: Found", editMaterialButtons.length, "edit material buttons, attaching listeners.");
            for (var i = 0; i < editMaterialButtons.length; i++) {
                editMaterialButtons[i].addEventListener('click', function(e) {
                    console.log("Event: Edit material button clicked.");
                    var materialId = e.target.dataset.id;
                    var material = findInArray(appState.materials, function(m) { return m.id === materialId; });
                    if (material) {
                        var materialIdInput = document.getElementById('material-id');
                        var materialNameInput = document.getElementById('material-name');
                        var materialPriceInput = document.getElementById('material-price');
                        var materialStockInput = document.getElementById('material-stock');
                        var materialTypeSelect = document.getElementById('material-type');
                        var materialLowThresholdInput = document.getElementById('material-low-threshold');
                        var formContainer = document.getElementById('material-form-container');

                        if (materialIdInput) materialIdInput.value = escapeHtml(material.id);
                        if (materialNameInput) materialNameInput.value = escapeHtml(material.name);
                        if (materialPriceInput) materialPriceInput.value = escapeHtml(material.unit_price);
                        if (materialStockInput) materialStockInput.value = escapeHtml(material.stock);
                        if (materialTypeSelect) materialTypeSelect.value = escapeHtml(material.type);
                        if (materialLowThresholdInput) materialLowThresholdInput.value = escapeHtml(material.low_stock_threshold);
                        if (formContainer) formContainer.classList.remove('hidden');
                        console.log("Event: Pre-filled material form for editing.");
                    }
                });
            }

            var deleteMaterialButtons = listContainer.querySelectorAll('.delete-material-btn');
            console.log("renderMaterialsList: Found", deleteMaterialButtons.length, "delete material buttons, attaching listeners.");
            for (var i = 0; i < deleteMaterialButtons.length; i++) {
                deleteMaterialButtons[i].addEventListener('click', function(e) {
                    console.log("Event: Delete material button clicked.");
                    var materialId = e.target.dataset.id;
                    showModal('Удалить материал', 'Вы уверены, что хотите удалить этот материал? Это действие необратимо.', 'confirm', function() {
                        supabase.from('materials').delete().eq('id', materialId)
                            .then(function(response) {
                                console.log("Delete material response:", response);
                                if (response.error) throw response.error;
                                showModal('Успех', 'Материал успешно удален!', 'alert');
                                fetchDataAndRerenderCurrentPage();
                                console.log("Event: Material deleted and page re-rendered.");
                            })
                            .catch(function(error) {
                                console.error('Ошибка удаления материала:', error.message);
                                showModal('Ошибка', 'Не удалось удалить материал: ' + escapeHtml(error.message), 'alert');
                            });
                    });
                });
            }
            console.log("renderMaterialsList: Function finished.");
        };

        var renderMaterialMovements = function() {
            console.log("renderMaterialMovements: Function started.");
            var listContainer = document.getElementById('material-movements-list');
            if (!listContainer) {
                console.error("renderMaterialMovements: Material movements list container not found.");
                return;
            }
            supabase.from('material_movements').select('*, materials(name)').order('date', { ascending: false })
                .then(function(response) {
                    console.log("Material movements fetch response:", response);
                    if (response.error) throw response.error;
                    var movements = response.data;

                    if (movements.length === 0) {
                        listContainer.innerHTML = '<p class="text-gray-400">Нет истории движений материалов.</p>';
                        console.log("renderMaterialMovements: No movements, rendered empty state.");
                        return;
                    }

                    listContainer.innerHTML = `
                        <table class="min-w-full bg-gray-800 rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gray-700 text-gray-300 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left rounded-tl-lg">Дата</th>
                                    <th class="py-3 px-6 text-left">Материал</th>
                                    <th class="py-3 px-6 text-left">Тип</th>
                                    <th class="py-3 px-6 text-left">Кол-во</th>
                                    <th class="py-3 px-6 text-left rounded-tr-lg">Источник/Цель</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-200 text-sm">
                                ${mapArray(movements, function(move) {
                                    return `
                                        <tr class="border-b border-gray-600 hover:bg-gray-700">
                                            <td class="py-3 px-6 text-left whitespace-nowrap">${new Date(move.date).toLocaleString('uk-UA')}</td>
                                            <td class="py-3 px-6 text-left">${move.materials ? escapeHtml(move.materials.name) : 'Неизвестно'}</td>
                                            <td class="py-3 px-6 text-left">
                                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${move.type === 'in' ? 'bg-blue-700 text-blue-100' : 'bg-orange-700 text-orange-100'}">
                                                    ${escapeHtml(move.type === 'in' ? 'Приход' : 'Расход')}
                                                </span>
                                            </td>
                                            <td class="py-3 px-6 text-left">${escapeHtml(move.quantity)}</td>
                                            <td class="py-3 px-6 text-left">${escapeHtml(move.source_target || 'N/A')}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                    console.log("renderMaterialMovements: Rendered movements table.");
                })
                .catch(function(error) {
                    console.error('Ошибка загрузки истории движений материалов:', error.message);
                    if (listContainer) {
                        listContainer.innerHTML = `<p class="text-red-400">Ошибка загрузки истории: ${escapeHtml(error.message)}</p>`;
                    }
                });
            console.log("renderMaterialMovements: Function finished.");
        };

        var checkLowStock = function() {
            console.log("checkLowStock: Function started.");
            var lowStockMaterials = filterArray(appState.materials, function(m) { return m.stock <= m.low_stock_threshold; });
            if (lowStockMaterials.length > 0) {
                var materialNames = mapArray(lowStockMaterials, function(m) { return escapeHtml(m.name); }).join(', ');
                showModal('Низкий остаток материалов', 'Следующие материалы имеют низкий остаток: ' + materialNames + '. Пожалуйста, пополните запасы.', 'alert');
                console.log("checkLowStock: Low stock materials found, showing alert.");
            } else {
                console.log("checkLowStock: No low stock materials.");
            }
            console.log("checkLowStock: Function finished.");
        };


        // 6. Finance Module
        var renderFinance = function() {
            console.log("renderFinance: Function started.");
            var dynamicContentArea = document.getElementById('dynamic-content-area');
            if (!dynamicContentArea) {
                console.error("renderFinance: Dynamic content area not found.");
                return;
            }
            dynamicContentArea.innerHTML = `
                <div class="p-4 md:p-8 bg-gray-700 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-blue-300">Фінанси</h2>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gray-800 p-5 rounded-lg shadow-sm">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300 mb-1">Дохід (за місяць)</h3>
                                <p class="text-3xl font-bold text-green-400" id="monthly-revenue-finance">${formatCurrency(calculateMonthlyRevenue())}</p>
                                <p class="text-sm text-gray-400">+0% з минулого місяця</p>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-sm">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300 mb-1">Витрати (за місяць)</h3>
                                <p class="text-3xl font-bold text-red-400" id="monthly-expenses-finance">${formatCurrency(calculateMonthlyExpenses())}</p>
                                <p class="text-sm text-gray-400">+0% з минулого місяця</p>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-sm">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-300 mb-1">Прибуток</h3>
                                <p class="text-3xl font-bold text-blue-400" id="net-profit">${formatCurrency(calculateNetProfit())}</p>
                                <p class="text-sm text-gray-400">Рентабельність: ${escapeHtml(((calculateNetProfit() / calculateTotalRevenue()) * 100 || 0).toFixed(1))}%</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end mb-6">
                        <button id="add-expense-btn" class="px-6 py-3 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors flex items-center">
                            <i class="fas fa-plus mr-2"></i>Додати витрату
                        </button>
                    </div>

                    <div id="expense-form-container" class="hidden bg-gray-800 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-blue-300">Додати новий расход</h3>
                        <form id="expense-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="expense-date" class="block text-sm font-medium text-gray-300">Дата</label>
                                <input type="date" id="expense-date" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="expense-amount" class="block text-sm font-medium text-gray-300">Сумма (грн)</label>
                                <input type="number" id="expense-amount" step="0.01" min="0" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div class="md:col-span-2">
                                <label for="expense-description" class="block text-sm font-medium text-gray-300">Описание</label>
                                <input type="text" id="expense-description" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="expense-category" class="block text-sm font-medium text-gray-300">Категория</label>
                                <select id="expense-category" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                                    ${mapArray(appState.expenseCategories, function(cat) { return `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`; }).join('')}
                                </select>
                            </div>
                            <div class="md:col-span-2 flex justify-end space-x-3">
                                <button type="button" id="cancel-expense-form" class="px-5 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Отмена</button>
                                <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Добавить расход</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-inner mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-semibold text-blue-300">Дохід vs Витрати</h3>
                            <select class="bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-1 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option>12 місяців</option>
                                <option>6 місяців</option>
                                <option>3 місяці</option>
                            </select>
                        </div>
                        <div class="h-64 bg-gray-900 rounded-md flex items-center justify-center text-gray-500">
                            Графік Дохід vs Витрати
                        </div>
                    </div>

                    <h3 class="text-2xl font-semibold mb-4 text-blue-300">Останні операції</h3>
                    <div id="finance-table" class="overflow-x-auto mb-8">
                        </div>

                    <h3 class="text-2xl font-semibold mb-4 text-blue-300">Отчёты</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-800 p-5 rounded-lg shadow-inner">
                            <h4 class="text-lg font-semibold mb-3 text-gray-300">Выручка по месяцам</h4>
                            <div id="monthly-revenue-report"></div>
                        </div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-inner">
                            <h4 class="text-lg font-semibold mb-3 text-gray-300">Выручка по методам оплаты</h4>
                            <div id="payment-method-report"></div>
                        </div>
                    </div>
                </div>
            `;

            var addExpenseBtn = document.getElementById('add-expense-btn');
            if (addExpenseBtn) {
                console.log("renderFinance: Found #add-expense-btn, attaching listener.");
                addExpenseBtn.addEventListener('click', function() {
                    console.log("Event: #add-expense-btn clicked.");
                    var formContainer = document.getElementById('expense-form-container');
                    var expenseForm = document.getElementById('expense-form');
                    if (formContainer) formContainer.classList.toggle('hidden');
                    if (expenseForm) expenseForm.reset();
                    console.log("Event: Toggled expense form visibility and reset.");
                });
            } else {
                console.warn("renderFinance: #add-expense-btn not found.");
            }

            var cancelExpenseFormBtn = document.getElementById('cancel-expense-form');
            if (cancelExpenseFormBtn) {
                console.log("renderFinance: Found #cancel-expense-form, attaching listener.");
                cancelExpenseFormBtn.addEventListener('click', function() {
                    console.log("Event: #cancel-expense-form clicked.");
                    var formContainer = document.getElementById('expense-form-container');
                    var expenseForm = document.getElementById('expense-form');
                    if (formContainer) formContainer.classList.add('hidden');
                    if (expenseForm) expenseForm.reset();
                    console.log("Event: Expense form cancelled and hidden.");
                });
            } else {
                console.warn("renderFinance: #cancel-expense-form not found.");
            }

            var expenseForm = document.getElementById('expense-form');
            if (expenseForm) {
                console.log("renderFinance: Found #expense-form, attaching submit listener.");
                expenseForm.addEventListener('submit', handleAddExpense);
            } else {
                console.warn("renderFinance: #expense-form not found.");
            }
            renderFinanceTable();
            renderMonthlyRevenueReport();
            renderPaymentMethodReport();
            console.log("renderFinance: Function finished.");
        };

        var calculateMonthlyExpenses = function() {
            var now = new Date();
            var currentMonth = now.getMonth();
            var currentYear = now.getFullYear();
            return reduceArray(appState.expenses, function(sum, expense) {
                var expenseDate = new Date(expense.date);
                if (expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear) {
                    return sum + expense.amount;
                }
                return sum;
            }, 0);
        };

        var calculateTotalExpenses = function() {
            return reduceArray(appState.expenses, function(sum, expense) { return sum + expense.amount; }, 0);
        };

        var calculateNetProfit = function() {
            return calculateTotalRevenue() - calculateTotalExpenses();
        };

        var handleAddExpense = function(event) {
            console.log("handleAddExpense: Function started.");
            event.preventDefault();
            var form = event.target;
            var dateInput = form['expense-date'];
            var amountInput = form['expense-amount'];
            var descriptionInput = form['expense-description'];
            var categoryInput = form['expense-category'];

            var date = dateInput ? dateInput.value : '';
            var amount = amountInput ? parseFloat(amountInput.value) : NaN;
            var description = descriptionInput ? descriptionInput.value : '';
            var category = categoryInput ? categoryInput.value : '';

            if (!date || isNaN(amount) || !description || !category) {
                console.warn("handleAddExpense: Missing required fields.");
                showModal('Ошибка', 'Пожалуйста, заполните все поля расхода.', 'alert');
                return;
            }

            supabase.from('expenses').insert([{ date: date, amount: amount, description: description, category: category }])
                .then(function(response) {
                    console.log("Expense add response:", response);
                    if (response.error) throw response.error;
                    showModal('Успех', 'Расход успешно добавлен!', 'alert');
                    form.reset();
                    var formContainer = document.getElementById('expense-form-container');
                    if (formContainer) formContainer.classList.add('hidden');
                    fetchDataAndRerenderCurrentPage();
                    console.log("handleAddExpense: Expense added and page re-rendered.");
                })
                .catch(function(error) {
                    console.error('Ошибка добавления расхода:', error.message);
                    showModal('Ошибка', 'Не удалось добавить расход: ' + escapeHtml(error.message), 'alert');
                });
        };

        var renderFinanceTable = function() {
            console.log("renderFinanceTable: Function started.");
            var tableContainer = document.getElementById('finance-table');
            if (!tableContainer) {
                console.error("renderFinanceTable: Finance table container not found.");
                return;
            }
            var combinedData = [];

            mapArray(appState.sessions, function(session) {
                var sessionDate = new Date(session.start_time);
                var relatedAppointment = findInArray(appState.appointments, function(app) {
                    return app.id === session.appointment_id;
                });
                var clientName = 'Неизвестно';
                if (relatedAppointment && relatedAppointment.client_id) {
                    var client = findInArray(appState.clients, function(c) {
                        return c.id === relatedAppointment.client_id;
                    });
                    if (client) {
                        clientName = client.name;
                    }
                }

                combinedData.push({
                    type: 'Доход',
                    date: sessionDate.toISOString().split('T')[0],
                    description: `Сеанс (${escapeHtml(clientName)})`, // Changed to template literal with escapeHtml
                    amount: session.total_price,
                    category: 'Тату-сеанс',
                    paymentMethod: session.payment_method
                });
            });

            mapArray(appState.expenses, function(expense) {
                combinedData.push({
                    type: 'Расход',
                    date: expense.date,
                    description: escapeHtml(expense.description), // Escape expense description
                    amount: expense.amount,
                    category: escapeHtml(expense.category), // Escape expense category
                    paymentMethod: 'N/A'
                });
            });

            combinedData.sort(function(a, b) { return new Date(b.date) - new Date(a.date); }); // Sort by date, newest first

            if (combinedData.length === 0) {
                if (tableContainer) {
                    tableContainer.innerHTML = '<p class="text-gray-400">Нет финансовых операций.</p>';
                }
                console.log("renderFinanceTable: No financial operations, rendered empty state.");
                return;
            }

            tableContainer.innerHTML = `
                <table class="min-w-full bg-gray-800 rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-700 text-gray-300 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Дата</th>
                            <th class="py-3 px-6 text-left">Тип</th>
                            <th class="py-3 px-6 text-left">Описание</th>
                            <th class="py-3 px-6 text-left">Категория</th>
                            <th class="py-3 px-6 text-left">Метод оплаты</th>
                            <th class="py-3 px-6 text-left rounded-tr-lg">Сумма</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-200 text-sm">
                        ${mapArray(combinedData, function(item) {
                            return `
                                <tr class="border-b border-gray-600 hover:bg-gray-700">
                                    <td class="py-3 px-6 text-left whitespace-nowrap">${formatDate(item.date)}</td>
                                    <td class="py-3 px-6 text-left">
                                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${item.type === 'Доход' ? 'bg-green-700 text-green-100' : 'bg-red-700 text-red-100'}">
                                            ${escapeHtml(item.type)}
                                        </span>
                                    </td>
                                    <td class="py-3 px-6 text-left">${item.description}</td>
                                    <td class="py-3 px-6 text-left">${item.category}</td>
                                    <td class="py-3 px-6 text-left">${escapeHtml(item.paymentMethod === 'cash' ? 'Наличные' : item.paymentMethod === 'card' ? 'Карта' : item.paymentMethod)}</td>
                                    <td class="py-3 px-6 text-left font-semibold ${item.type === 'Доход' ? 'text-green-400' : 'text-red-400'}">${formatCurrency(item.amount)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            console.log("renderFinanceTable: Rendered finance table.");
            console.log("renderFinanceTable: Function finished.");
        };

        var renderMonthlyRevenueReport = function() {
            console.log("renderMonthlyRevenueReport: Function started.");
            var reportContainer = document.getElementById('monthly-revenue-report');
            if (!reportContainer) {
                console.error("renderMonthlyRevenueReport: Monthly revenue report container not found.");
                return;
            }
            var monthlyData = {};

            mapArray(appState.sessions, function(session) {
                var sessionDate = new Date(session.start_time);
                var monthYear = sessionDate.getFullYear() + '-' + customPadStart((sessionDate.getMonth() + 1), 2, '0');
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = 0;
                }
                monthlyData[monthYear] += session.total_price;
            });

            var sortedMonths = Object.keys(monthlyData).sort();

            if (sortedMonths.length === 0) {
                if (reportContainer) {
                    reportContainer.innerHTML = '<p class="text-gray-400">Нет данных о выручке по месяцам.</p>';
                }
                console.log("renderMonthlyRevenueReport: No monthly revenue data, rendered empty state.");
                return;
            }

            reportContainer.innerHTML = `
                <ul class="list-disc list-inside space-y-1 text-gray-200">
                    ${mapArray(sortedMonths, function(month) {
                        return `
                        <li>${escapeHtml(month)}: <span class="font-semibold">${formatCurrency(monthlyData[month])}</span></li>
                    `;
                    }).join('')}
                </ul>
            `;
            console.log("renderMonthlyRevenueReport: Rendered monthly revenue report.");
            console.log("renderMonthlyRevenueReport: Function finished.");
        };

        var renderPaymentMethodReport = function() {
            console.log("renderPaymentMethodReport: Function started.");
            var reportContainer = document.getElementById('payment-method-report');
            if (!reportContainer) {
                console.error("renderPaymentMethodReport: Payment method report container not found.");
                return;
            }
            var paymentMethodData = {
                cash: 0,
                card: 0,
                transfer: 0
            };

            mapArray(appState.sessions, function(session) {
                if (paymentMethodData.hasOwnProperty(session.payment_method)) {
                    paymentMethodData[session.payment_method] += session.total_price;
                }
            });

            var totalRevenue = calculateTotalRevenue();

            if (totalRevenue === 0) {
                if (reportContainer) {
                    reportContainer.innerHTML = '<p class="text-gray-400">Нет данных о выручке по методам оплаты.</p>';
                }
                console.log("renderPaymentMethodReport: No payment method data, rendered empty state.");
                return;
            }

            reportContainer.innerHTML = `
                <ul class="list-disc list-inside space-y-1 text-gray-200">
                    <li>Наличные: <span class="font-semibold">${formatCurrency(paymentMethodData.cash)} (${escapeHtml(((paymentMethodData.cash / totalRevenue) * 100 || 0).toFixed(1))}%)</span></li>
                    <li>Карта: <span class="font-semibold">${formatCurrency(paymentMethodData.card)} (${escapeHtml(((paymentMethodData.card / totalRevenue) * 100 || 0).toFixed(1))}%)</span></li>
                    <li>Перевод: <span class="font-semibold">${formatCurrency(paymentMethodData.transfer)} (${escapeHtml(((paymentMethodData.transfer / totalRevenue) * 100 || 0).toFixed(1))}%)</span></li>
                </ul>
            `;
            console.log("renderPaymentMethodReport: Rendered payment method report.");
            console.log("renderPaymentMethodReport: Function finished.");
        };


        // 7. Settings Module
        var renderSettings = function() {
            console.log("renderSettings: Function started.");
            var dynamicContentArea = document.getElementById('dynamic-content-area');
            if (!dynamicContentArea) {
                console.error("renderSettings: Dynamic content area not found.");
                return;
            }
            dynamicContentArea.innerHTML = `
                <div class="p-4 md:p-8 bg-gray-700 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-6 text-blue-300">Налаштування</h2>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-blue-300">Основні налаштування</h3>
                        <form id="settings-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="hourly-rate" class="block text-sm font-medium text-gray-300">Почасова ставка (грн)</label>
                                <input type="number" id="hourly-rate" step="0.01" min="0" value="${escapeHtml(appState.hourlyRate)}" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            </div>
                            <div>
                                <label for="sms-api-key" class="block text-sm font-medium text-gray-300">SMS API Key (Turbo SMS)</label>
                                <input type="text" id="sms-api-key" value="${escapeHtml(appState.settings.sms_api_key || '')}" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200" placeholder="Ваш Turbo SMS API ключ">
                            </div>
                            <div>
                                <label for="sms-sender-name" class="block text-sm font-medium text-gray-300">Имя отправителя SMS</label>
                                <input type="text" id="sms-sender-name" value="${escapeHtml(appState.settings.sms_sender_name || '')}" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200" placeholder="Например, 'TATTOO STUDIO'">
                            </div>
                            <div>
                                <label for="currency" class="block text-sm font-medium text-gray-300">Валюта</label>
                                <select id="currency" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                                    <option value="UAH">Гривня (грн)</option>
                                    <option value="USD">Доллар (USD)</option>
                                    <option value="EUR">Евро (EUR)</option>
                                </select>
                            </div>
                            <div>
                                <label for="language" class="block text-sm font-medium text-gray-300">Мова інтерфейсу</label>
                                <select id="language" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                                    <option value="uk-UA">Українська</option>
                                    <option value="en-US">English</option>
                                </select>
                            </div>
                            <div>
                                <label for="date-format" class="block text-sm font-medium text-gray-300">Формат дати</label>
                                <select id="date-format" class="mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                                    <option value="DD.MM.YYYY">ДД.ММ.ГГГГ</option>
                                    <option value="MM/DD/YYYY">ММ/ДД/ГГГГ</option>
                                </select>
                            </div>
                            <div class="md:col-span-2 flex justify-end">
                                <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-colors">
                                    Зберегти налаштування
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-inner mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-blue-300">Категорії витрат</h3>
                        <div id="expense-categories-list" class="mb-4">
                            ${mapArray(appState.expenseCategories, function(cat) {
                                return `
                                <div class="flex items-center justify-between bg-gray-700 p-3 rounded-md mb-2">
                                    <span class="text-gray-200">${escapeHtml(cat)}</span>
                                    <div class="flex space-x-2">
                                        <button class="edit-expense-category-btn text-blue-400 hover:text-blue-300" data-category="${escapeHtml(cat)}"><i class="fas fa-pencil-alt"></i></button>
                                        <button class="delete-expense-category-btn text-red-400 hover:text-red-300" data-category="${escapeHtml(cat)}"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="new-expense-category" placeholder="Назва нової категорії" class="flex-1 p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            <button id="add-expense-category-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-inner">
                        <h3 class="text-xl font-semibold mb-4 text-blue-300">Категорії матеріалів</h3>
                        <div id="material-categories-list" class="mb-4">
                            ${mapArray(appState.materialCategories, function(cat) {
                                return `
                                <div class="flex items-center justify-between bg-gray-700 p-3 rounded-md mb-2">
                                    <span class="text-gray-200">${escapeHtml(cat)}</span>
                                    <div class="flex space-x-2">
                                        <button class="edit-material-category-btn text-blue-400 hover:text-blue-300" data-category="${escapeHtml(cat)}"><i class="fas fa-pencil-alt"></i></button>
                                        <button class="delete-material-category-btn text-red-400 hover:text-red-300" data-category="${escapeHtml(cat)}"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="new-material-category" placeholder="Назва нової категорії" class="flex-1 p-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-800 text-gray-200">
                            <button id="add-material-category-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            var settingsForm = document.getElementById('settings-form');
            if (settingsForm) {
                console.log("renderSettings: Found #settings-form, attaching submit listener.");
                settingsForm.addEventListener('submit', handleSaveSettings);
            } else {
                console.warn("renderSettings: #settings-form not found.");
            }

            // Add/Edit category logic for Expense Categories
            var addExpenseCategoryBtn = document.getElementById('add-expense-category-btn');
            if (addExpenseCategoryBtn) {
                console.log("renderSettings: Found #add-expense-category-btn, attaching listener.");
                addExpenseCategoryBtn.addEventListener('click', function() {
                    console.log("Event: #add-expense-category-btn clicked.");
                    var newCatInput = document.getElementById('new-expense-category');
                    if (newCatInput && newCatInput.value.trim() !== '') {
                        appState.expenseCategories.push(newCatInput.value.trim());
                        newCatInput.value = '';
                        handleSaveSettings(null, true); // Save settings and re-render
                        console.log("Event: Added new expense category.");
                    } else {
                        console.warn("Event: New expense category input is empty.");
                    }
                });
            } else {
                console.warn("renderSettings: #add-expense-category-btn not found.");
            }

            var expenseCategoriesList = document.getElementById('expense-categories-list');
            if (expenseCategoriesList) {
                console.log("renderSettings: Found #expense-categories-list, attaching click listener for edit/delete.");
                expenseCategoriesList.addEventListener('click', function(e) {
                    if (e.target.closest('.edit-expense-category-btn')) {
                        console.log("Event: Edit expense category button clicked.");
                        var oldCategory = e.target.closest('.edit-expense-category-btn').dataset.category;
                        showInputModal('Редагувати категорію витрат', 'Введіть нову назву категорії:', oldCategory, function(newCategory) {
                            if (newCategory !== null && newCategory.trim() !== '' && newCategory.trim() !== oldCategory) {
                                var index = appState.expenseCategories.indexOf(oldCategory);
                                if (index > -1) {
                                    appState.expenseCategories[index] = newCategory.trim();
                                    handleSaveSettings(null, true);
                                    console.log("Event: Edited expense category.");
                                }
                            }
                        });
                    } else if (e.target.closest('.delete-expense-category-btn')) {
                        console.log("Event: Delete expense category button clicked.");
                        var categoryToDelete = e.target.closest('.delete-expense-category-btn').dataset.category;
                        showModal('Удалить категорию', 'Вы уверены, что хотите удалить категорию "' + escapeHtml(categoryToDelete) + '"?', 'confirm', function() {
                            appState.expenseCategories = filterArray(appState.expenseCategories, function(cat) { return cat !== categoryToDelete; });
                            handleSaveSettings(null, true);
                            console.log("Event: Deleted expense category.");
                        });
                    }
                });
            } else {
                console.warn("renderSettings: #expense-categories-list not found.");
            }


            // Add/Edit category logic for Material Categories
            var addMaterialCategoryBtn = document.getElementById('add-material-category-btn');
            if (addMaterialCategoryBtn) {
                console.log("renderSettings: Found #add-material-category-btn, attaching listener.");
                addMaterialCategoryBtn.addEventListener('click', function() {
                    console.log("Event: #add-material-category-btn clicked.");
                    var newCatInput = document.getElementById('new-material-category');
                    if (newCatInput && newCatInput.value.trim() !== '') {
                        appState.materialCategories.push(newCatInput.value.trim());
                        newCatInput.value = '';
                        handleSaveSettings(null, true); // Save settings and re-render
                        console.log("Event: Added new material category.");
                    } else {
                        console.warn("Event: New material category input is empty.");
                    }
                });
            } else {
                console.warn("renderSettings: #add-material-category-btn not found.");
            }

            var materialCategoriesList = document.getElementById('material-categories-list');
            if (materialCategoriesList) {
                console.log("renderSettings: Found #material-categories-list, attaching click listener for edit/delete.");
                materialCategoriesList.addEventListener('click', function(e) {
                    if (e.target.closest('.edit-material-category-btn')) {
                        console.log("Event: Edit material category button clicked.");
                        var oldCategory = e.target.closest('.edit-material-category-btn').dataset.category;
                        showInputModal('Редагувати категорію матеріалів', 'Введіть нову назву категорії:', oldCategory, function(newCategory) {
                            if (newCategory !== null && newCategory.trim() !== '' && newCategory.trim() !== oldCategory) {
                                var index = appState.materialCategories.indexOf(oldCategory);
                                if (index > -1) {
                                    appState.materialCategories[index] = newCategory.trim();
                                    handleSaveSettings(null, true);
                                    console.log("Event: Edited material category.");
                                }
                            }
                        });
                    } else if (e.target.closest('.delete-material-category-btn')) {
                        console.log("Event: Delete material category button clicked.");
                        var categoryToDelete = e.target.closest('.delete-material-category-btn').dataset.category;
                        showModal('Удалить категорию', 'Вы уверены, что хотите удалить категорию "' + escapeHtml(categoryToDelete) + '"?', 'confirm', function() {
                            appState.materialCategories = filterArray(appState.materialCategories, function(cat) { return cat !== categoryToDelete; });
                            handleSaveSettings(null, true);
                            console.log("Event: Deleted material category.");
                        });
                    }
                });
            } else {
                console.warn("renderSettings: #material-categories-list not found.");
            }
            console.log("renderSettings: Function finished.");
        };

        var handleSaveSettings = function(event, isCategoryUpdate) {
            console.log("handleSaveSettings: Function started.");
            if (event) event.preventDefault(); // Prevent default form submission if called from form

            var hourlyRateInput = document.getElementById('hourly-rate');
            var smsApiKeyInput = document.getElementById('sms-api-key');
            var smsSenderNameInput = document.getElementById('sms-sender-name');

            var hourlyRate = hourlyRateInput ? parseFloat(hourlyRateInput.value) : appState.hourlyRate;
            var smsApiKey = smsApiKeyInput ? smsApiKeyInput.value.trim() : (appState.settings.sms_api_key || '');
            var smsSenderName = smsSenderNameInput ? smsSenderNameInput.value.trim() : (appState.settings.sms_sender_name || '');


            if (isNaN(hourlyRate) || hourlyRate < 0) {
                console.warn("handleSaveSettings: Invalid hourly rate.");
                showModal('Ошибка', 'Ставка за час должна быть положительным числом.', 'alert');
                return;
            }

            // Assuming there's only one settings row, update it
            var settingsId = appState.settings && appState.settings.length > 0 ? appState.settings.id : null; // Use appState.settings.id directly
            var promise;

            var settingsToSave = {
                hourly_rate: hourlyRate,
                material_categories: appState.materialCategories, // Use updated array
                expense_categories: appState.expenseCategories, // Use updated array
                sms_api_key: smsApiKey, // Save new SMS API key
                sms_sender_name: smsSenderName // Save new SMS sender name
            };

            if (settingsId) {
                console.log("handleSaveSettings: Updating existing settings.");
                promise = supabase.from('settings').update(settingsToSave).eq('id', settingsId);
            } else {
                console.log("handleSaveSettings: Inserting new settings.");
                promise = supabase.from('settings').insert([settingsToSave]);
            }

            promise
                .then(function(response) {
                    console.log("Settings save response:", response);
                    if (response.error) {
                        // If no settings row exists, insert one (PGRST116 is a common code for no rows found on update)
                        if (response.error.code === 'PGRST116' || (response.error.message && response.error.message.includes('no rows found'))) {
                            console.log("handleSaveSettings: No settings row found, attempting to insert default settings.");
                            return supabase.from('settings').insert([settingsToSave]);
                        } else {
                            throw response.error;
                        }
                    }
                    return response; // Pass through successful update response
                })
                .then(function() {
                    showModal('Успех', 'Настройки успешно сохранены!', 'alert');
                    fetchDataAndRerenderCurrentPage();
                    console.log("handleSaveSettings: Settings saved and page re-rendered.");
                })
                .catch(function(error) {
                    console.error('Ошибка сохранения настроек:', error.message);
                    showModal('Ошибка', 'Не удалось сохранить настройки: ' + escapeHtml(error.message), 'alert');
                });
            console.log("handleSaveSettings: Function finished.");
        };


        // Initial load and event listeners
        window.addEventListener('hashchange', function() {
            console.log("Window hashchange event detected.");
            handleRouteChange();
        });
        window.addEventListener('load', function() {
            console.log("Window load event detected.");
            fetchData().then(function() {
                setupRealtimeSubscriptions();
                handleRouteChange(); // Initial route handling after data is loaded
            });
        });

        // --- Routing --- (Moved after all render functions)
        var routes = {
            'dashboard': renderDashboard,
            'appointments': renderAppointments,
            'clients': renderClients,
            'inventory': renderInventory,
            'finance': renderFinance,
            'settings': renderSettings,
            'session': renderSessionCalculator // This will handle /session/[id]
        };

        var handleRouteChange = function() {
            var path = window.location.hash.substring(1);
            var dynamicContentArea = document.getElementById('dynamic-content-area');
            var pageTitle = document.getElementById('page-title');

            // Clear only the dynamic content area
            if (dynamicContentArea) dynamicContentArea.innerHTML = '';

            // Remove active class from all nav links
            var navLinks = document.querySelectorAll('.nav-link');
            for (var i = 0; i < navLinks.length; i++) {
                navLinks[i].classList.remove('active');
            }

            var pathParts = path.split('/');
            var basePath = pathParts[0];
            var id = pathParts[1];

            console.log("handleRouteChange: Current path is", path, "Base path:", basePath, "ID:", id);

            if (routes[basePath]) {
                routes[basePath](id); // Pass ID if available
                // Add active class to current nav link
                var activeLink = document.querySelector('.nav-link[href="#' + basePath + '"]'); // Corrected closing quote
                if (activeLink) {
                    activeLink.classList.add('active');
                    console.log("handleRouteChange: Active link set for", basePath);
                }
                // Update page title
                var linkText = activeLink ? activeLink.textContent.trim() : '';
                // Extract only the Russian word for the title
                var titleMatch = linkText.match(/(Панель|Записи|Клиенты|Инвентарь|Финансы|Настройки)/);
                if (pageTitle) {
                    pageTitle.textContent = titleMatch ? titleMatch[0] : 'Неизвестно';
                    console.log("handleRouteChange: Page title set to", pageTitle.textContent);
                }

            } else {
                // Default to dashboard if path is not found or empty
                console.log("handleRouteChange: Path not found or empty, defaulting to dashboard.");
                window.location.hash = '#dashboard';
                renderDashboard();
                var defaultLink = document.querySelector('.nav-link[href="#dashboard"]');
                if (defaultLink) {
                    defaultLink.classList.add('active');
                }
                if (pageTitle) {
                    pageTitle.textContent = 'Панель';
                }
            }
        };
    </script>
</body>
</html>
